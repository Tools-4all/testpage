{% load static %}
<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Tab Sandboxed JS Compiler</title>


  <link rel="stylesheet" data-name="vs/editor/editor.main"
    href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/editor/editor.main.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Fira Code', monospace;
      display: flex;
      flex-direction: row;
      height: 100vh;
      background-color: #1e1e1e;
      color: #d4d4d4;
      overflow: hidden;
    }

    .vs-logo {
      position: absolute;
      top: 0;
      left: 0;
      height: 40px;
      width: 40px;
      z-index: 1010;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .vs-logo img {
      height: 27px;
      width: 27px;
      object-fit: contain;
      border-radius: 4px;
      margin-bottom: 10px;
      user-select: none;
      -webkit-user-drag: none;
    }

    .vs-navbar {
      background-color: #252526;
      color: #ffffff;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      display: flex;
      padding: 5px 10px;
      border-bottom: 1px solid #333;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      padding-left: 40px;
      height: 30px;
    }

    .vs-navbar-item {
      margin-right: 10px;
      margin-top: 1px;
      position: relative;
      cursor: pointer;
      padding: 5px;
      padding-top: 1px;
      font-size: 12px;
      border-radius: 5px;
    }

    .vs-navbar-item:hover {
      background-color: #9492923b;
    }

    .vs-navbar-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #333;
      border: 1px solid #252526;
      border-radius: 4px;
      overflow: hidden;
      z-index: 1000;
      min-width: 120px;
    }

    .vs-navbar-dropdown.active {
      display: block;
    }

    .vs-navbar-dropdown-item {
      padding: 8px 12px;
      color: #d4d4d4;
      cursor: pointer;
      white-space: nowrap;
    }

    .vs-navbar-dropdown-item:hover {
      background-color: #444;
      color: #ffffff;
    }

    .vs-navbar-dropdown-item.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    #activityBar {
      width: 50px;
      background-color: #252526;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      border-right: 1px solid #333;
      transition: width 0.3s ease;
      flex-shrink: 0;
      margin-top: 30px;
    }

    #activityBar .icon {
      color: #b3b3b3;
      padding: 12px 0;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      width: 100%;
      text-align: center;
      font-size: 20px;
      position: relative;
    }

    #activityBar .icon:hover,
    #activityBar .icon.active {
      background-color: #3c3c3c;
      color: #fff;
    }

    #activityBar .icon:hover:after {
      content: attr(data-label);
      position: absolute;
      left: 55px;
      top: 50%;
      transform: translateY(-50%);
      background: #333;
      color: #fff;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 3px;
      white-space: nowrap;
      z-index: 9;
    }

    .sidebar-panel {
      width: 250px;
      background-color: #1e1e1e;
      border-right: 1px solid #333;
      overflow-y: auto;
      padding: 10px;
      display: none;
      flex-shrink: 0;
      transition: all 0.3s ease;
      margin-top: 30px;
    }

    .sidebar-panel.active {
      display: block;
    }

    #gitUrl {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      background-color: #2d2d2d;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      color: #d4d4d4;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #gitUrl:focus {
      border-color: #007acc;
    }

    #loadGitButton {
      width: 100%;
      padding: 8px 10px;
      background-color: #007acc;
      border: none;
      border-radius: 4px;
      color: white;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #loadGitButton:hover {
      background-color: #005f99;
    }

    #tabSizeInput {
      width: 100%;
    }

    .vs-range {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background-color: #2d2d2d;
      outline: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: #007acc;
      border-radius: 50%;
      border: 2px solid #444;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #007acc;
      border: 2px solid #444;
      border-radius: 50%;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb:hover,
    .vs-range::-moz-range-thumb:hover {
      background: #119eff;
    }

    .vs-range::-webkit-slider-thumb:active,
    .vs-range::-moz-range-thumb:active {
      background: #0067a8;
    }

    #mainContainer {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-top: 30px;
      overflow: hidden;
    }

    #tabBar {
      background-color: #252526;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      height: 36px;
      flex-shrink: 0;
    }

    .tab {
      background-color: #333;
      margin-right: 3px;
      margin-top: 9px;
      padding: 7px 10px 7px;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      user-select: none;
      -webkit-user-drag: element;
    }

    .tab.active {
      background-color: #1e1e1e;
      border-top: 1px solid #007acc;
    }

    .tab .tab-title {
      margin-right: 15px;
    }

    .tab .close {
      font-size: 12px;
      cursor: pointer;
    }

    .tab-title-edit {
      background: #555;
      border: 1px solid #666;
      color: #fff;
      width: 90px;
      font-size: 13px;
      margin-right: 8px;
      font-family: inherit;
      outline: none;
    }

    #addTabButton {
      background: none;
      color: #c5c5c5;
      font-size: 18px;
      cursor: pointer;
      margin-left: auto;
      margin-right: 5px;
    }

    #addTabButton:hover {
      color: #fff;
    }

    #tabsContainer {
      position: relative;
      flex: 1;
      overflow: hidden;
    }

    .editor-and-output {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .editor-and-output.active {
      display: flex;
    }

    .editorContainer {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .monaco-editor {
      width: 100%;
      height: 100%;
    }

    .outputContainer {
      height: 200px;
      background-color: #1e1e1e;
      border-top: 1px solid #333;
      display: flex;
      flex-direction: column;
    }

    .controls {
      display: flex;
      justify-content: flex-end;
      padding: 8px 12px;
      background-color: #252526;
      border-bottom: 1px solid #333;
    }

    .monaco-findInput>.controls {
      padding: 0px !important;
      background-color: transparent !important;
    }

    .clearButton {
      padding: 6px 8px;
      background-color: transparent;
      color: #b2afaf;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 16px;
      display: flex;
      align-items: center;
      margin-right: 10px;
      transition: background-color 0.1s ease;
    }

    .clearButton:hover {
      background-color: #535252;
    }


    .runButton {
      padding: 6px 12px;
      background-color: #0e639c;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

    .runButton:hover {
      background-color: #1177bb;
    }

    .runButton i {
      margin-right: 5px;
    }

    .output {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      background-color: #1e1e1e;
    }

    .log {
      color: #d4d4d4;
    }

    .error {
      color: #f44747;
    }

    .warn {
      color: #cca700;
    }

    .info {
      color: #3794ff;
    }

    .outputContent {
      margin-top: 2px;
    }

    .prompt-line {
      display: flex;
      align-items: center;
      color: #d4d4d4;
      font-size: 14px;
    }

    .prompt-line span {
      margin-right: 5px;
      white-space: pre;
    }

    .prompt-line input {
      flex: 1;
      padding: 0;
      margin: 0;
      border: none;
      outline: none;
      background: transparent;
      color: #d4d4d4;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      caret-color: #d4d4d4;
    }

    /* Status Bar */
    #statusBar {
      height: 24px;
      background-color: #252526;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      font-size: 12px;
      color: #cccccc;
      flex-shrink: 0;
    }

    .status-item {
      margin-right: 10px;
    }


    @media (max-width: 768px) {
      #activityBar {
        width: 40px;
      }

      #activityBar .icon {
        font-size: 18px;
        padding: 10px 0;
      }

      .sidebar-panel {
        width: 200px;
      }

      .runButton {
        padding: 6px 10px;
        font-size: 12px;
      }

      #statusBar {
        left: 50px;
      }
    }
  </style>
</head>

<body>
  <div class="vs-logo">
    <img src="{% static 'site_images/jseditor.png' %}" alt="Logo" />
  </div>

  <div class="vs-navbar">
    <div class="vs-navbar-item" data-dropdown="fileDropdown">
      File
      <div class="vs-navbar-dropdown" id="fileDropdown">
        <div class="vs-navbar-dropdown-item" id="uploadFileBtn">Upload File</div>
        <div class="vs-navbar-dropdown-item" id="saveScriptBtn">Save File</div>
      </div>
    </div>
    <div class="vs-navbar-item" data-dropdown="editDropdown">
      Edit
      <div class="vs-navbar-dropdown" id="editDropdown">
        <div class="vs-navbar-dropdown-item" id="undoBtn">Undo</div>
        <div class="vs-navbar-dropdown-item" id="redoBtn">Redo</div>
      </div>
    </div>
  </div>

  <div id="activityBar">
    <div class="icon" id="searchIcon" data-label="Search" data-target="searchPanel">
      <i class="fas fa-search"></i>
    </div>
    <div class="icon" id="gitIcon" data-label="Source Control" data-target="gitPanel">
      <i class="fas fa-code-branch"></i>
    </div>
    <div class="icon" id="settingsIcon" data-label="Settings" data-target="settingsPanel">
      <i class="fas fa-cog"></i>
    </div>
  </div>

  <div id="gitPanel" class="sidebar-panel">
    <input type="url" id="gitUrl" placeholder="Enter GitHub file URL" />
    <button id="loadGitButton" disabled="true">Load</button>
  </div>
  <div id="settingsPanel" class="sidebar-panel">
    <div>
      <label for="tabSizeInput">Tab Size: <span id="tabSizeDisplay">3</span></label>
      <input id="tabSizeInput" type="range" min="1" max="8" value="3" class="vs-range" />
    </div>
  </div>

  <div id="mainContainer">
    <div id="tabBar">
      <div id="addTabButton"><i class="fas fa-plus"></i></div>
    </div>

    <div id="tabsContainer"></div>

    <div id="statusBar">
      <div class="status-item" id="statusPosition">Ln 1, Col 1</div>
      <div class="status-item">UTF-8</div>
      <div class="status-item" id="statusSpaces">Spaces: 3</div>
      <div class="status-item">JavaScript</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>

  <script>
    const workerPath = "{% url 'betzi_test_js' %}";
    let workerBlobURL = null;

    let activeDropdown = null;
    let spaces = 3;

    let tabs = [];
    let activeTabId = null;


    function getUniqueTabName(baseName, ignoreTabId = null) {
      let candidate = baseName;
      let suffix = 1;

      while (
        tabs.some(
          (t) => t.id !== ignoreTabId && t.name.toLowerCase() === candidate.toLowerCase()
        )
      ) {
        candidate = baseName + `(${suffix++})`;
      }
      return candidate;
    }


    function createTab(desiredName = null, initialContent = null) {
      let tabName;
      if (!desiredName) {
        tabName = getNextTabName();
      } else {
        tabName = getUniqueTabName(desiredName);
      }

      const newTabId = Date.now();
      const sharedBuffer = new SharedArrayBuffer(1024);
      const view = new Int32Array(sharedBuffer);

      const tabElem = document.createElement("div");
      tabElem.classList.add("tab");
      tabElem.draggable = true;

      const titleSpan = document.createElement("span");
      titleSpan.classList.add("tab-title");
      titleSpan.textContent = tabName;
      tabElem.appendChild(titleSpan);

      const closeIcon = document.createElement("i");
      closeIcon.classList.add("fas", "fa-times", "close");
      tabElem.appendChild(closeIcon);

      const editorAndOutput = document.createElement("div");
      editorAndOutput.classList.add("editor-and-output");

      const editorContainer = document.createElement("div");
      editorContainer.classList.add("editorContainer");

      const outputContainer = document.createElement("div");
      outputContainer.classList.add("outputContainer");

      const controlsDiv = document.createElement("div");
      controlsDiv.classList.add("controls");

      const clearTerminalButton = document.createElement("button");
      clearTerminalButton.classList.add("clearButton");
      clearTerminalButton.innerHTML = '<i class="fas fa-trash"></i>';
      clearTerminalButton.addEventListener("click", () => {
        // Clear the output for this tab
        outputDiv.innerHTML = "";
      });

      const runBtn = document.createElement("button");
      runBtn.classList.add("runButton");
      runBtn.innerHTML = '<i class="fas fa-play"></i> Run';
      controlsDiv.appendChild(clearTerminalButton);
      controlsDiv.appendChild(runBtn);

      const outputDiv = document.createElement("div");
      outputDiv.classList.add("output");

      outputContainer.appendChild(controlsDiv);
      outputContainer.appendChild(outputDiv);

      editorAndOutput.appendChild(editorContainer);
      editorAndOutput.appendChild(outputContainer);

      const tabBar = document.getElementById("tabBar");
      const addTabButton = document.getElementById("addTabButton");
      tabBar.insertBefore(tabElem, addTabButton);

      const tabsContainer = document.getElementById("tabsContainer");
      tabsContainer.appendChild(editorAndOutput);

      const editorInstance = monaco.editor.create(editorContainer, {
        language: "javascript",
        theme: "custom-dark",
        automaticLayout: true,
        tabSize: spaces,
        insertSpaces: true,
        minimap: { enabled: true },
        fontSize: 14,
        fontFamily: 'Fira Code, Consolas, "Courier New", monospace',
        fontLigatures: true,
        folding: true,
        lineNumbers: "on",
        wordWrap: "on",
        scrollbar: {
          verticalScrollbarSize: 8,
          horizontalScrollbarSize: 8,
        },
        contextmenu: true,
        selectionHighlight: true,
        renderIndentGuides: true,
        renderLineHighlight: "all",
        cursorStyle: "line",
        cursorBlinking: "blink",
        quickSuggestions: true,
        parameterHints: true,
        autoClosingBrackets: "always",
        autoClosingQuotes: "always",
        formatOnType: true,
        formatOnPaste: true,
        suggestOnTriggerCharacters: true,
        smoothScrolling: true,
        breadcrumbs: {
          enabled: true,
        },
      });

      const tabObj = {
        id: newTabId,
        name: tabName,
        sharedBuffer,
        view,
        tabElement: tabElem,
        editorContainer,
        outputElement: outputDiv,
        editorInstance,
        worker: null,
        editorAndOutput,
      };
      tabs.push(tabObj);

      editorInstance.onDidChangeCursorPosition(() => {
        updateStatusPosition();
      });

      runBtn.addEventListener("click", () => {
        runTab(newTabId);
      });

      closeIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        closeTab(newTabId);
      });

      switchTab(newTabId);

      if (initialContent !== null) {
        editorInstance.setValue(initialContent);
      } else {
        editorInstance.setValue(`// ${tabName}\nconsole.log("This is a log");\nconsole.info("This is an info");\nconsole.warn("This is a warning");\nconsole.error("This is an error");\nprompt("This is a prompt:");`);
      }

      return newTabId;
    }


    function getNextTabName() {
      let maxNum = 0;
      for (const t of tabs) {
        const match = t.name.match(/^Tab(\d+)$/);
        if (match) {
          const num = parseInt(match[1], 10);
          if (num > maxNum) {
            maxNum = num;
          }
        }
      }
      return `Tab${maxNum + 1}`;
    }


    function reorderTabs(draggedTabId, targetTabId) {
      if (draggedTabId === targetTabId) return;

      const draggedIndex = tabs.findIndex((t) => t.id === draggedTabId);
      const targetIndex = tabs.findIndex((t) => t.id === targetTabId);
      if (draggedIndex === -1 || targetIndex === -1) return;

      const draggedTabObj = tabs[draggedIndex];
      tabs.splice(draggedIndex, 1);
      tabs.splice(targetIndex, 0, draggedTabObj);

      const tabBar = document.getElementById("tabBar");
      tabs.forEach((t) => {
        tabBar.insertBefore(t.tabElement, document.getElementById("addTabButton"));
      });
    }
    function switchTab(tabId) {
      if (activeTabId !== null) {
        const currentTab = tabs.find((t) => t.id === activeTabId);
        if (currentTab) {
          currentTab.tabElement.classList.remove("active");
          currentTab.editorAndOutput.classList.remove("active");
        }
      }
      const newTab = tabs.find((t) => t.id === tabId);
      if (newTab) {
        newTab.tabElement.classList.add("active");
        newTab.editorAndOutput.classList.add("active");
        activeTabId = tabId;
        updateStatusPosition();
      }
    }

    function closeTab(tabId) {
      const idx = tabs.findIndex((t) => t.id === tabId);
      if (idx === -1) return;
      const tabObj = tabs[idx];

      if (tabObj.worker) {
        tabObj.worker.terminate();
        tabObj.worker = null;
      }

      tabObj.tabElement.remove();
      tabObj.editorAndOutput.remove();

      tabs.splice(idx, 1);

      if (activeTabId === tabId) {
        if (tabs.length > 0) {
          switchTab(tabs[tabs.length - 1].id);
        } else {
          activeTabId = null;
        }
      }
    }

    async function runTab(tabId) {
      const tabObj = tabs.find((t) => t.id === tabId);
      if (!tabObj) return;

      clearConsole(tabObj.outputElement);

      if (tabObj.worker) {
        tabObj.worker.terminate();
        tabObj.worker = null;
      }

      await cacheWorkerCode();
      const w = new Worker(workerBlobURL);
      tabObj.worker = w;

      w.onmessage = async (evt) => {
        const { type, message } = evt.data;
        if (type === "prompt") {
          await handlePrompt(message, tabObj);
        } else if (["log", "error", "warn", "info"].includes(type)) {
          appendToOutput(tabObj.outputElement, type, message);
        } else if (type === "clear") {
          clearConsole(tabObj.outputElement);
        }
      };
      w.onerror = (error) => {
        appendToOutput(tabObj.outputElement, "error", error.message);
        appendToOutput(tabObj.outputElement, "log", "The script has finished running with exit code 1.");
      };

      const code = tabObj.editorInstance.getValue();
      w.postMessage({
        type: "execute",
        code,
        sharedBuffer: tabObj.sharedBuffer,
      });
    }

    function clearConsole(outputDiv) {
      outputDiv.innerHTML = "";
    }

    const symbolsMap = {
      log: ">",
      error: "x",
      warn: "!",
      info: "i",
      prompt: "?"
    };

    const colorMap = {
      log: "#CCCCCC",
      error: "#FF5555",
      warn: "#FFFF55",
      info: "#55FFFF",
      prompt: "#55FF55",
    };


    function appendToOutput(outputDiv, type, message) {
      if (!outputDiv) return;
      const line = document.createElement("div");
      line.className = type;
      line.classList.add("outputContent");
      line.textContent = `[${symbolsMap[type]}] ${message}`;
      line.style.color = colorMap[type];
      outputDiv.appendChild(line);
      outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    function handlePrompt(msg, tabObj) {
      return new Promise((resolve) => {
        const outputDiv = tabObj.outputElement;
        const promptLine = document.createElement("div");
        promptLine.className = "prompt-line";
        promptLine.classList.add("outputContent");

        const promptMsg = document.createElement("span");
        promptMsg.textContent = `[?] ${msg}`;
        promptMsg.style.color = colorMap.prompt;

        const input = document.createElement("input");
        input.type = "text";
        input.autocomplete = "off";

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            const value = input.value.trim();
            promptMsg.textContent = `[PROMPT] ${msg} ${value}`;
            input.remove();

            const textEncoder = new TextEncoder();
            const encodedResponse = textEncoder.encode(value + "\0");

            const responseBuffer = new Uint8Array(tabObj.sharedBuffer, 4);
            responseBuffer.fill(0);
            responseBuffer.set(encodedResponse);

            Atomics.store(tabObj.view, 0, 1);
            Atomics.notify(tabObj.view, 0);

            resolve();
          }
        });

        promptLine.appendChild(promptMsg);
        promptLine.appendChild(input);
        outputDiv.appendChild(promptLine);
        input.focus();
      });
    }

    function makeTabTitleEditable(tabObj) {
      const span = tabObj.tabElement.querySelector(".tab-title");
      const xBtn = tabObj.tabElement.querySelector(".close");
      if (!span) return;
      xBtn.style.display = "none";
      const oldName = tabObj.name;
      const input = document.createElement("input");
      input.type = "text";
      input.value = oldName;
      input.classList.add("tab-title-edit");

      tabObj.tabElement.replaceChild(input, span);

      input.focus();
      input.select();

      let finalizeCalled = false;

      const finalize = () => {
        if (finalizeCalled) return;
        finalizeCalled = true;

        let newVal = input.value.trim();
        if (!newVal || newVal === oldName) {
          newVal = oldName;
        } else {
          newVal = getUniqueTabName(newVal, tabObj.id);
        }

        tabObj.name = newVal;

        const newSpan = document.createElement("span");
        newSpan.classList.add("tab-title");
        newSpan.textContent = newVal;
        newSpan.addEventListener("dblclick", () => {
          makeTabTitleEditable(tabObj);
        });

        tabObj.tabElement.replaceChild(newSpan, input);
        xBtn.style.display = "block";
      };

      input.addEventListener("blur", finalize);

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          finalize();
        } else if (e.key === "Escape") {
          e.preventDefault();
          input.value = oldName;
          finalize();
        }
      });
    }


    require.config({
      paths: {
        vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs",
      },
    });
    window.MonacoEnvironment = {
      getWorkerUrl: function (moduleId, label) {
        return (
          "data:text/javascript;charset=utf-8," +
          encodeURIComponent(`
              self.MonacoEnvironment = {
                baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/'
              };
              importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/base/worker/workerMain.js');
            `)
        );
      },
    };

    async function cacheWorkerCode() {
      if (!workerBlobURL) {
        const resp = await fetch(workerPath);
        const code = await resp.text();
        const blob = new Blob([code], { type: "application/javascript" });
        workerBlobURL = URL.createObjectURL(blob);
      }
    }

    require(["vs/editor/editor.main"], function () {
      monaco.editor.defineTheme("custom-dark", {
        base: "vs-dark",
        inherit: true,
        rules: [
          { token: "keyword", foreground: "C586C0" },
          { token: "identifier", foreground: "9CDCFE" },
          { token: "string", foreground: "CE9178" },
          { token: "comment", foreground: "6A9955" },
          { token: "number", foreground: "B5CEA8" },
        ],
        colors: {
          "editor.background": "#1E1E1E",
        },
      });

      createTab();
    });

    function updateStatusPosition() {
      if (activeTabId === null) {
        document.getElementById("statusPosition").textContent = "Ln 0, Col 0";
        return;
      }
      const tabObj = tabs.find((t) => t.id === activeTabId);
      if (!tabObj) return;

      const pos = tabObj.editorInstance.getPosition();
      if (pos) {
        document.getElementById("statusPosition").textContent =
          `Ln ${pos.lineNumber}, Col ${pos.column}`;
      }
    }

    document.getElementById("addTabButton").addEventListener("click", () => {
      createTab();
    });

    document.getElementById("tabBar").addEventListener("click", (e) => {
      const clickedTab = tabs.find(
        (t) => t.tabElement === e.target || t.tabElement.contains(e.target)
      );
      if (clickedTab) {
        switchTab(clickedTab.id);
      }
    });

    ["gitIcon", "settingsIcon"].forEach((iconId) => {
      const icon = document.getElementById(iconId);
      icon.addEventListener("click", (e) => {
        const isActive = e.currentTarget.classList.contains("active");
        document.querySelectorAll(".icon").forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-panel")
          .forEach((panel) => panel.classList.remove("active"));

        if (!isActive) {
          e.currentTarget.classList.add("active");
          const targetPanel = e.currentTarget.getAttribute("data-target");
          document.getElementById(targetPanel).classList.add("active");
        }
      });
    });

    document.getElementById("searchIcon").addEventListener("click", () => {
      if (activeTabId === null) return;
      const tabObj = tabs.find((t) => t.id === activeTabId);
      if (!tabObj) return;
      tabObj.editorInstance.getAction("actions.find").run();
    });

    document.addEventListener("click", (event) => {
      if (!event.target.closest(".vs-navbar-item")) {
        document.querySelectorAll(".vs-navbar-dropdown").forEach((d) => d.classList.remove("active"));
        activeDropdown = null;
      }
    });

    document.querySelectorAll(".vs-navbar-item").forEach((item) => {
      item.addEventListener("click", (evt) => {
        const dropdownId = evt.currentTarget.getAttribute("data-dropdown");
        const dropdown = document.getElementById(dropdownId);

        document
          .querySelectorAll(".vs-navbar-dropdown")
          .forEach((d) => d.classList.remove("active"));

        if (dropdown) {
          dropdown.classList.toggle("active");
          activeDropdown = dropdown.classList.contains("active") ? dropdown : null;
        }
      });
      item.addEventListener("mouseover", (evt) => {
        if (activeDropdown) {
          const dropdownId = evt.currentTarget.getAttribute("data-dropdown");
          const dropdown = document.getElementById(dropdownId);
          if (activeDropdown !== dropdown) {
            activeDropdown.classList.remove("active");
            dropdown.classList.add("active");
            activeDropdown = dropdown;
          }
        }
      });
    });

    const tabSizeInput = document.getElementById("tabSizeInput");
    const tabSizeDisplay = document.getElementById("tabSizeDisplay");
    tabSizeInput.addEventListener("input", () => {
      spaces = parseInt(tabSizeInput.value, 10);
      tabSizeDisplay.textContent = spaces;
      document.getElementById("statusSpaces").textContent = `Spaces: ${spaces}`;

      tabs.forEach((t) => {
        t.editorInstance.updateOptions({ tabSize: spaces });
      });
    });

    const redoBtn = document.getElementById("redoBtn");
    const undoBtn = document.getElementById("undoBtn");

    function toggleDisabled(elem, isDisabled) {
      if (isDisabled) {
        elem.classList.add("disabled");
      } else {
        elem.classList.remove("disabled");
      }
    }
    function updateUndoRedoButtons() {
      if (activeTabId === null) {
        toggleDisabled(undoBtn, true);
        toggleDisabled(redoBtn, true);
        return;
      }
      const tabObj = tabs.find((t) => t.id === activeTabId);
      if (!tabObj) return;
      const model = tabObj.editorInstance.getModel();
      if (!model) return;
      toggleDisabled(undoBtn, !model.canUndo());
      toggleDisabled(redoBtn, !model.canRedo());
    }

    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        document.getElementById("saveScriptBtn").dispatchEvent(new MouseEvent("click"));
      } else if (
        (e.ctrlKey && e.key === "z") ||
        (e.ctrlKey && e.shiftKey && e.key === "Z")
      ) {
        setTimeout(() => updateUndoRedoButtons(), 100);
      }
    });
    redoBtn.addEventListener("click", () => {
      if (activeTabId === null) return;
      const tabObj = tabs.find((t) => t.id === activeTabId);
      tabObj.editorInstance.trigger("redo", "redo", null);
      updateUndoRedoButtons();
    });
    undoBtn.addEventListener("click", () => {
      if (activeTabId === null) return;
      const tabObj = tabs.find((t) => t.id === activeTabId);
      tabObj.editorInstance.trigger("undo", "undo", null);
      updateUndoRedoButtons();
    });
    setInterval(() => updateUndoRedoButtons(), 500);

    document.getElementById("uploadFileBtn").addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".js";
      input.style.display = "none";
      input.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
          const fileName = getUniqueTabName(file.name);
          createTab(fileName, evt.target.result);
          closeDropdowns();
        };
        reader.readAsText(file);
      });
      document.body.appendChild(input);
      input.click();
      input.remove();
    });

    document.getElementById("saveScriptBtn").addEventListener("click", () => {
      if (activeTabId === null) return;
      const tabObj = tabs.find((t) => t.id === activeTabId);
      const content = tabObj.editorInstance.getValue();
      const blob = new Blob([content], { type: "text/javascript" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = tabObj.name.endsWith(".js")
        ? tabObj.name
        : `${tabObj.name}.js`;
      a.click();
      URL.revokeObjectURL(url);
      closeDropdowns();
    });
    function closeDropdowns() {
      document
        .querySelectorAll(".vs-navbar-dropdown")
        .forEach((d) => d.classList.remove("active"));
    }

    const gitInp = document.getElementById("gitUrl");
    const loadGitButton = document.getElementById("loadGitButton");

    gitInp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadGitButton.click();
    });
    gitInp.addEventListener("input", () => {
      if (!gitInp.value.trim()) {
        loadGitButton.disabled = true;
      } else {
        loadGitButton.disabled = false;
      }
    });

    loadGitButton.addEventListener("click", async () => {
      const gitUrl = gitInp.value.trim();
      if (!gitUrl) return appendToOutput(null, "error", "No URL provided.");

      let tabFileName = "untitled.js";
      try {
        new URL(gitUrl);
      } catch (err) {
        alert("Invalid URL");
        return;
      }

      const normalizedUrl = normalizeUrl(gitUrl);
      const parsedUrl = parseGitHubUrl(normalizedUrl);
      if (parsedUrl.isRawFile) {
        const lastSlash = parsedUrl.rawUrl.lastIndexOf("/");
        if (lastSlash !== -1) {
          tabFileName = parsedUrl.rawUrl.substring(lastSlash + 1);
        }
      } else if (parsedUrl.isFile) {
        const lastSlash = parsedUrl.path.lastIndexOf("/");
        if (lastSlash !== -1) {
          tabFileName = parsedUrl.path.substring(lastSlash + 1);
        }
      }

      try {
        let fileContent;
        if (parsedUrl.isRawFile) {
          fileContent = await fetchRawFile(parsedUrl.rawUrl);
        } else if (parsedUrl.isFile) {
          const fileData = await fetchFromGit(
            parsedUrl.owner,
            parsedUrl.repo,
            parsedUrl.path,
            parsedUrl.branch
          );
          if (!fileData.content) {
            alert("Failed to fetch file content.");
            return;
          }
          fileContent = atob(fileData.content);
        } else {
          alert("Invalid GitHub file URL. Must point to a specific file.");
          return;
        }

        createTab(tabFileName, fileContent);
      } catch (error) {
        alert(`Error fetching file: ${error.message}`);
      }
    });
    function normalizeUrl(url) {
      if (url.endsWith(".git")) {
        url = url.slice(0, -4);
      }
      if (!url.startsWith("http://") && !url.startsWith("https://")) {
        url = "https://" + url;
      }
      if (url.startsWith("http://")) {
        url = "https://" + url.substring(7);
      }
      return url;
    }
    function parseGitHubUrl(url) {
      if (url.includes("raw.githubusercontent.com")) {
        const match = url.match(
          /^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)$/
        );
        if (match) {
          return {
            isRawFile: true,
            rawUrl: url,
          };
        }
        return { isRawFile: false };
      }
      const match = url.match(
        /^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/
      );
      if (!match) {
        return { isFile: false };
      }
      return {
        owner: match[1],
        repo: match[2],
        branch: match[3],
        path: match[4],
        isFile: true,
      };
    }
    async function fetchFromGit(owner, repo, path, branch = "main") {
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
      const response = await fetch(apiUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch file: ${response.statusText}`);
      }
      const data = await response.json();
      if (data.type !== "file") {
        throw new Error("The URL does not point to a valid file.");
      }
      return data;
    }
    async function fetchRawFile(rawUrl) {
      const response = await fetch(rawUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch raw file: ${response.statusText}`);
      }
      return await response.text();
    }

    document.getElementById("clearTerminalButton").addEventListener("click", () => {
      if (activeTabId === null) return;
      const tabObj = tabs.find((t) => t.id === activeTabId);
      if (!tabObj || !tabObj.outputElement) return;

      tabObj.outputElement.innerHTML = "";
    });

  </script>
</body>

</html>