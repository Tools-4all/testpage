{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Multi-Tab Sandboxed JS Compiler</title>
  <link rel="stylesheet" data-name="vs/editor/editor.main"
    href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/editor/editor.main.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      user-select: none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .allowSelect {
      user-select: text !important;
      -webkit-user-drag: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
    }

    .dontAllowSelect {
      user-select: none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .darkMode {
      background-color: #252526;
      color: #d4d4d4;
    }

    .lightMode {
      background-color: #f0f0f0;
      color: #131313;
    }

    #compiler {
      position: relative;
      font-family: 'Fira Code', monospace;
      display: flex;
      width: 60%;
      height: 500px;
      margin: 100px auto;
      overflow: hidden;
      transition: width 0.3s ease, height 0.3s ease, margin 0.3s ease;
    }

    /* 
    #compiler:not(.lightMode) {
      background-color: #252526;
      color: #d4d4d4;
    }

    #compiler:not(.darkMode) {
      background-color: #f0f0f0;
      color: #131313;
    } */

    /* .theme {} */

    .color1e1e1e {
      background-color: #1e1e1e;
      color: #d4d4d4;
    }

    .color252526 {
      background-color: #252526;
      color: #cccccc;
      border-color: #333 !important;
      border-bottom-color: #333;
    }

    .colorffffff {
      background-color: #ffffff;
      color: #000;
    }

    .colorf0f0f0 {
      background-color: #f0f0f0;
      color: #131313;
      border-color: #c0c0c0 !important;
      border-bottom-color: #c0c0c0;
    }

    .vs-logo {
      position: absolute;
      top: 0;
      left: 0;
      height: 40px;
      width: 40px;
      z-index: 1010;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .vs-logo img {
      height: 25px;
      width: 25px;
      object-fit: contain;
      border-radius: 4px;
      margin-bottom: 8px;
      user-select: none;
      -webkit-user-drag: none;
    }

    .vs-navbar {
      font-family: 'Fira Code', monospace;
      background-color: transparent;
      font-size: 14px;
      display: flex;
      padding: 5px 10px;
      padding-right: 5px;
      border-bottom: 1px solid;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      padding-left: 40px;
      height: 30px;
    }

    .vs-navbar-item {
      margin-right: 10px;
      margin-top: 1px;
      position: relative;
      cursor: pointer;
      padding: 5px;
      padding-top: 1px;
      font-size: 12px;
      border-radius: 5px;
    }

    .vs-navbar-item:hover {
      background-color: #9492923b;
    }

    .vs-navbar-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      border: 1px solid #252526;
      border-radius: 4px;
      overflow: hidden;
      z-index: 1000;
      min-width: 120px;
    }

    .vs-navbar-dropdown.active {
      display: block;
    }

    .vs-navbar-dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .vs-navbar-dropdown-item:hover {
      background-color: #444;
      color: #ffffff;
    }

    .vs-navbar-dropdown-item.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    #lightMode {
      margin-left: 20px;
      margin-right: 20px;
      cursor: pointer;
    }

    #fullScreenBtn {
      margin-top: 3px;
      margin-right: 7px;
      font-size: 13px;
      cursor: pointer;
    }

    #activityBar {
      width: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      background-color: transparent;
      border-right: 1px solid;
      transition: width 0.3s ease;
      flex-shrink: 0;
      margin-top: 30px;
    }

    #activityBar .icon {
      padding: 12px 0;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      width: 100%;
      text-align: center;
      font-size: 20px;
      position: relative;
    }

    #activityBar .icon:hover:after {
      content: attr(data-label);
      position: absolute;
      left: 55px;
      top: 50%;
      transform: translateY(-50%);
      background: #333;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 3px;
      white-space: nowrap;
      z-index: 9;
    }

    #compiler:not(.darkMode) #activityBar .icon {
      color: #9b9a9a !important;
    }

    #compiler:not(.darkMode) #activityBar .icon:hover,
    #compiler:not(.darkMode) #activityBar .icon.active {
      background-color: rgb(183, 182, 182);
      color: #eae8e8 !important;
    }

    #compiler:not(.darkMode) #activityBar .icon:hover:after {
      background: #acabab;
    }

    #compiler:not(.lightMode) #activityBar .icon:hover,
    #compiler:not(.lightMode) #activityBar .icon.active {
      background-color: #3c3c3c;
      color: #fff;
    }

    .sidebar-panel {
      width: 250px;
      background-color: #1e1e1e;
      border-right: 1px solid #333;
      overflow-y: auto;
      padding: 10px;
      display: none;
      flex-shrink: 0;
      margin-top: 30px;
    }

    .sidebar-panel.active {
      display: block;
    }

    #compiler:not(.darkMode) .sideBar-panel {
      background-color: #eeeeee;
      color: #000000;
      border-color: #c0c0c0 !important;
    }

    #gitUrl {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      background-color: #2d2d2d;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      color: #d4d4d4;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #gitUrl:focus {
      border-color: #007acc;
    }

    #loadGitButton {
      width: 100%;
      padding: 8px 10px;
      background-color: #007acc;
      border: none;
      border-radius: 4px;
      color: white;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #loadGitButton:hover {
      background-color: #005f99;
    }

    #tabSizeInput {
      width: 100%;
    }


    .vs-range {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background-color: #2d2d2d;
      outline: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: #007acc;
      border-radius: 50%;
      border: 2px solid #444;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #007acc;
      border: 2px solid #444;
      border-radius: 50%;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb:hover,
    .vs-range::-moz-range-thumb:hover {
      background: #119eff;
    }

    .vs-range::-webkit-slider-thumb:active,
    .vs-range::-moz-range-thumb:active {
      background: #0067a8;
    }

    .exportBtnsWrapper {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }

    #exportSelect {
      padding: 5px 5px;
      border-radius: 5px;
      width: 100%;
      max-width: 275px;
      color: #000 !important;
    }

    #exportButton {
      width: 100%;
      max-width: 275px;
      margin-left: 0px;
      margin-top: 15px;
    }

    #mainContainer {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-top: 30px;
      overflow: hidden;
    }

    #tabBar {
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      height: 30px;
      flex-shrink: 0;
      overflow: hidden;
    }

    #tabBar:hover {
      overflow-x: auto;
      overflow-y: hidden;
      transition: overflow 0.3s;
    }

    #tabBar::-webkit-scrollbar {
      height: 4px;
    }

    #tabBar::-webkit-scrollbar-thumb {
      background-color: #007acc;
      border-radius: 10px;
    }

    .tab {
      margin-right: 2px;
      margin-top: 3px;
      padding: 7px 10px;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      user-select: none;
      -webkit-user-drag: element;
    }

    #compiler:not(.darkMode) .tab {
      background-color: #e0e0e0;
      color: #000000;
    }

    #compiler:not(.lightMode) .tab {
      background-color: #2c2c2c;
      color: #ffffff;
    }

    #compiler:not(.darkMode) .tab.active {
      background-color: #d0d0d0;
      border-top: 1px solid #007acc !important;
    }

    #compiler:not(.lightMode) .tab.active {
      background-color: #1c1c1c;
      border-top: 1px solid #007acc !important;
    }

    #compiler:not(.darkMode) .tab:hover:not(.active, .tab) {
      background-color: #c0c0c0;
    }

    #compiler:not(.lightMode) .tab:hover:not(.active, .tab) {
      background-color: #3c3c3c;
    }

    .tab .tab-title {
      margin-right: 15px;
    }

    .tab .close {
      font-size: 12px;
      cursor: pointer;
      visibility: hidden
    }

    .tab:hover .close {
      visibility: visible;
    }

    .tab.active .close {
      visibility: visible;
    }

    /* 
    .tab:hover:not(.active, .theme.colorffffff .tab) {
      background-color: rgba(255, 255, 255, 0.1) !important;
    }

    .tab:hover:not(.active, .theme.color1e1e1e .tab) {
      background-color: rgba(0, 0, 0, 0.1) !important;
    } */

    .tab-title-edit {
      background: #555;
      border: 1px solid #666;
      color: #fff;
      width: 90px;
      font-size: 13px;
      margin-right: 8px;
      font-family: inherit;
      outline: none;
    }

    #addTabButton,
    #addTabButton_media {
      background: none;
      color: #c5c5c5;
      font-size: 17px;
      cursor: pointer;
      margin-left: 20px;
      margin-top: -1px;
      flex-shrink: 0;
      transition: color 0.2s;
    }

    #addTabButton:hover {
      color: #fff;
    }

    #addTabButton_media {
      font-size: 25px;
      margin-left: 0px;
      display: none;
    }

    #tabsContainer {
      position: relative;
      flex: 1;
      overflow: hidden;
    }

    .editor-and-output {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .editor-and-output.active {
      display: flex;
      margin-top: -1px
    }

    .editorContainer {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .monaco-editor {
      width: 100%;
      height: 100%;
    }

    .outputContainer {
      display: flex;
      flex-direction: column;
    }

    .resize {
      height: 30%;
    }

    .monaco-editor .find-widget.visible .controls {
      padding: 0px !important;
      border: none !important;
    }

    .controls {
      padding: 4px;
      cursor: ns-resize;
      user-select: none;
      border-top: 1px solid;
      border-bottom: 1px solid;
    }


    #runButton {
      margin-left: auto;
      padding: 10px 12px;
      background-color: #46a22a;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      transition: background-color 0.3s;
    }

    #runButton:hover {
      background-color: #35851d;
    }

    #runButton i {
      margin-right: 5px;
    }

    .output {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      overflow: hidden;
    }

    .output:hover {
      overflow: auto;
      transition: overflow 0.3s;
    }

    .output::-webkit-scrollbar {
      width: 8px;
    }

    .output::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .output::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .output::-webkit-scrollbar-horizontal {
      height: 8px;
    }

    .outputContent {
      margin-top: 2px;
      display: flex;
      flex-grow: 1;
      flex-shrink: 0;
    }

    .prompt-line {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-left: 4px;
    }

    .prompt-line span {
      margin-right: 5px;
      white-space: pre;
    }

    .promptInput {
      flex: 1;
      padding: 0;
      margin: 0;
      border: none;
      outline: none;
      background: transparent;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      caret-color: currentColor;
      margin-left: 10px;
      padding-left: 5px;
      padding-right: 5px;
      border-radius: 4px;
    }

    .outputContainer:not(.darkMode) .promptInput {
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    #statusBar {
      height: 24px;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      font-size: 12px;
      flex-shrink: 0;
    }

    .status-item {
      margin-right: 10px;
    }

    .tab-drop-left {
      box-shadow: inset 4px 0 0 0 #007acc;
    }

    .tab-drop-right {
      box-shadow: inset -4px 0 0 0 #007acc;
    }

    .vs-button {
      background-color: #0e639c;
      color: #ffffff;
      border: none;
      padding: 6px 12px;
      margin-left: 10px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .vs-button:hover {
      background-color: #1177bb;
    }

    .console-table {
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 4px;
      width: auto;
      width: 100%;
      max-width: 1200px;
      line-break: anywhere;
    }

    q .console-table thead {
      font-weight: bold;
    }

    .console-table th,
    .console-table td {
      border: 1px solid #333;
      padding: 4px 8px;
      vertical-align: top;
    }

    .outputContainer:not(.lightMode) .console-table thead .console-table-header:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .outputContainer:not(.darkMode) .console-table thead .console-table-header:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }

    .outputContainer:not(.lightMode) .console-table tbody .console-table-row:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .outputContainer:not(.darkMode) .console-table tbody .console-table-row:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }

    .outputContainer:not(.darkMode) .prompt-line {
      color: #000
    }

    .outputContainer:not(.lightMode) .prompt-line {
      color: #d4d4d4
    }

    #undoBtn,
    #redoBtn {
      margin-top: 3px;
      font-size: 11px;
    }

    #undoBtn {
      margin-right: 10px;
    }


    .theme.color1e1e1e .tab {
      background-color: #2c2c2c;
      color: #ffffff;
    }

    .theme.color1e1e1e .tab.active {
      background-color: #1c1c1c;
    }

    .tab.active {
      border-top: 1px solid #007acc !important;
      border-bottom: 1px solid transparent;
      margin-bottom: -2px;
      border-top-left-radius: 3px;
      border-top-right-radius: 3px;
    }


    .theme.color1e1e1e #statusBar {
      background-color: #2c2c2c;
      color: #cccccc;
    }

    #activityBar .icon.active {
      border-left: 3px solid #007acc;
    }

    #activityBar.theme.color252526 .icon:hover,
    #activityBar.theme.color252526 .icon.active {
      background-color: #3c3c3c;
      color: #fff;
    }

    .theme.color1e1e1e .sidebar-panel.active {
      background-color: #2b2b2b;
      color: #ffffff;
      border-color: #3c3c3c !important;
    }

    .theme.color1e1e1e .sidebar-panel.active #gitUrl {
      background-color: #3c3c3c;
      border-color: #4c4c4c;
      color: #ffffff;
    }

    .theme.color1e1e1e .sidebar-panel.active .vs-range {
      background-color: #3c3c3c;
      border: 1px solid #4c4c4c;
    }

    .theme.color1e1e1e .output {
      background-color: #1e1e1e;
      color: #d4d4d4;
    }

    .theme.color1e1e1e .console-table thead {
      background-color: #3c3c3c;
      color: #ffffff;
    }

    .theme.color1e1e1e .console-table td,
    .theme.color1e1e1e .console-table th {
      color: #d4d4d4;
    }

    .dark-log {
      color: #BBBBBB !important;
    }

    .dark-error {
      color: #FF6666 !important;
    }

    .dark-warn {
      color: #FFFF66 !important;
    }

    .dark-info {
      color: #74cbfb !important;
    }

    .dark-prompt {
      color: #99FF99 !important;
    }

    .theme.colorffffff .tab {
      background-color: #e0e0e0;
      color: #000000;
    }

    .theme.colorffffff .tab {
      background-color: #e0e0e0;
      color: #000000;
    }

    .theme.colorffffff .tab.active {
      background-color: #d0d0d0;
      border-top: 1px solid #007acc !important;
    }

    .theme.colorffffff #statusBar {
      background-color: #ecebeb;
      color: #000000;
      border-color: #c0c0c0 !important;
    }

    .theme.colorf0f0f0.vs-navbar-dropdown.active .vs-navbar-dropdown-item:hover {
      background-color: #c0c0c0;
      color: black;
    }

    .vs-navbar.theme.colorf0f0f0 #addTabButton {
      color: #636262 !important;
    }


    .vs-navbar.theme.colorf0f0f0 #addTabButton:hover {
      color: #000000 !important;
    }

    .theme.color252526 #tabBar::-webkit-scrollbar-track {
      background-color: #333;
    }

    .theme.colorf0f0f0 #tabBar::-webkit-scrollbar-track {
      background-color: #c0c0c0;
    }

    .theme.color252526.output::-webkit-scrollbar-corner {
      background: #252526;
    }

    .theme.colorf0f0f0.output::-webkit-scrollbar-corner {
      background: #f0f0f0;
    }

    .theme.color252526 #tabBar::-webkit-scrollbar-track {
      background-color: #333;
    }

    .theme.colorf0f0f0 #tabBar::-webkit-scrollbar-track {
      background-color: #c0c0c0;
    }


    #activityBar.theme.colorf0f0f0 .icon {
      color: #9b9a9a !important;
    }

    #activityBar.theme.colorf0f0f0 .icon:hover,
    #activityBar.theme.colorf0f0f0 .icon.active {
      background-color: rgb(183, 182, 182);
      color: #eae8e8 !important;
    }

    #activityBar.theme.colorf0f0f0 .icon:hover:after {
      background: #acabab;
    }

    .theme.colorf0f0f0 #activityBar .icon {
      color: #9b9a9a !important;
    }

    .theme.colorffffff .sidebar-panel.active {
      background-color: #eeeeee;
      color: #000000;
      border-color: #c0c0c0 !important;
    }

    .theme.colorffffff .sidebar-panel.active #gitUrl {
      background-color: #f9f9f9;
      border-color: #c0c0c0;
      color: #000000;
    }

    .theme.colorffffff .sidebar-panel.active .vs-range {
      background-color: #f9f9f9;
      border: 1px solid #c0c0c0;
    }

    .theme.colorf0f0f0 .controls {
      background-color: #c0c0c0;
    }

    .theme.color252526 .controls {
      background-color: #444;
    }

    .theme.colorffffff .output {
      background-color: #f9f9f9;
      color: #000;
    }

    .theme.colorffffff .console-table thead {
      background-color: #dddddd;
      color: #000000;
    }

    .theme.colorffffff .console-table td,
    .theme.colorffffff .console-table th {
      color: #333333;
    }

    .light-log {
      color: #444444 !important;
    }

    .light-error {
      color: #cc0000 !important;
    }

    .light-warn {
      color: #cc9a00 !important;
    }

    .light-info {
      color: #0066cc !important;
    }

    .light-prompt {
      color: #008000 !important;
    }

    .theme.color1e1e1e .prompt-line input {
      color: #ffffff;
      background-color: rgba(255, 255, 255, 0.07);
    }

    .theme.colorffffff .prompt-line input {
      color: #000000;
      background-color: rgba(0, 0, 0, 0.03);
    }

    #moon {
      font-size: 17px;
      height: 20px;
      width: 20px;
      padding-top: 2px;
      padding-left: 4px;
    }

    .objinsp-summary {
      cursor: pointer;
      color: #d4d4d4;
    }

    summary {
      list-style: none;
      -webkit-appearance: none;
      appearance: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    summary::marker {
      display: none;
    }

    details>summary::before {
      content: "▶";
      display: inline-block;
      margin-right: 5px;
      transition: transform 0.2s;
    }


    details[open]>summary::before {
      transform: rotate(90deg);
    }

    .isClone {
      cursor: default !important;
      pointer-events: none !important;
    }

    .outputContainer.isClone details>summary::before {
      font-family: "Symbol", Symbol, symbol;
      content: "Þ";
      display: inline-block;
      margin-right: 5px;
      transition: transform 0.2s;
      font-size: 13px;
    }

    .outputContainer.isClone details[open]>summary::before {
      font-family: "Symbol", Symbol, symbol;
      content: "ß";
      transform: none;
    }

    .objinsp-highlight-key {
      color: #9cdcfe;
      margin-left: 10px;
    }

    .objinsp-highlight-string {
      color: #ce9178;
      display: ruby;
    }

    .objinsp-highlight-number {
      color: #b5cea8;
    }

    .objinsp-highlight-primitive {
      color: #ce9178;
    }

    .objinsp-highlight-type {
      color: #4ec9b0;
    }

    .objinsp-highlight-value {
      color: #efd8d8;
    }

    .objinsp-node {
      color: #d4d4d4;
      margin-left: 10px;
    }

    .objinsp-dark:hover {
      background-color: rgba(0, 0, 0, 0.04);
    }

    .objinsp:hover {
      background-color: rgba(255, 255, 255, 0.04);
    }

    @media (max-width: 768px) {

      #lightMode {
        margin-left: 10px;
        margin-right: 10px;
      }

      #activityBar {
        width: 40px;
      }

      #activityBar .icon {
        font-size: 18px;
        padding: 10px 0;
      }

      .sidebar-panel {
        width: 200px;
      }

      #runButton {
        padding: 6px 10px;
        font-size: 12px;
      }

      #statusBar {
        left: 50px;
      }

      .iPadShowKeyboard {
        display: none !important;
      }

      #activityBar .icon:hover:after {
        display: none;
      }

      #addTabButton {
        display: none;
      }

      #addTabButton_media {
        display: block;
      }
    }

    @media (max-width: 675px) {
      .sidebar-panel {
        width: 100%;
        padding-right: 50px;
        z-index: 1010;
        margin-top: 0px;
        padding-top: 46px;
      }
    }


    .lightMode {}

    .darkMode {}

    .monaco-editor .find-widget>.button.codicon-widget-close {
      top: 8px !important;
    }

    .lineNumber {
      vertical-align: middle;
      text-align: right;
      font-variant-numeric: tabular-nums;
      box-sizing: border-box;
      width: 50px;
      height: 100%;
    }

    .lineNumDark {
      color: rgb(133, 133, 133);
    }

    .lineNumLight {
      color: rgb(35, 120, 147);
    }

    .numberDiv {
      text-align: right;
      height: 18.9px;
      padding-right: 10px;
      padding-left: 18px;
    }

    .codeLineDiv {
      flex: 1;
      min-width: 0;
      overflow-wrap: anywhere;
      word-wrap: break-word;
      word-break: break-all;
      line-break: strict;
      hyphens: none;
      -webkit-hyphens: none;
      -moz-hyphens: none;
    }

    .outputItem {
      white-space: pre-wrap;
      display: flex;
      flex-wrap: wrap;
    }

    .symbolDiv {
      margin-right: 5px;
      flex-shrink: 0;
    }

    .flexContainer {
      display: flex;
      align-items: flex-start;
    }

    .previewModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    .previewModal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    .modalClose {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .modalClose:hover,
    .modalClose:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    body.lastTab .tab .close {
      visibility: hidden !important;
    }

    body.lastTab #allZip {
      display: none !important;
    }

    .exportBtnsWrapper {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .headerText {
      background-color: white;
    }

    .handPointer {
      cursor: pointer;
    }



    #compiler:not(.darkMode) .vs-navbar,
    #compiler:not(.darkMode) #activityBar {
      border-color: #c0c0c0;
    }

    #compiler:not(.lightMode) .vs-navbar,
    #compiler:not(.lightMode) #activityBar {
      border-color: #333;
    }
  </style>
</head>

<body>
  <div id="compiler" class="darkMode">
    <div class="vs-logo">
      <img src="{% static 'site_images/jseditor.png' %}" alt="Logo" />
    </div>
    <div class="vs-navbar">
      <div class="vs-navbar-item" data-dropdown="fileDropdown">
        File
        <div class="theme color252526 vs-navbar-dropdown" id="fileDropdown">
          <div class="vs-navbar-dropdown-item" id="uploadFileBtn">Upload File</div>
          <div class="vs-navbar-dropdown-item" id="saveScriptBtn">Save File</div>
        </div>
      </div>
      <div class="vs-navbar-item" data-dropdown="editDropdown">
        Edit
        <div class="theme color252526 vs-navbar-dropdown" id="editDropdown">
          <div class="vs-navbar-dropdown-item"> </div>
          <div class="vs-navbar-dropdown-item"> </div>
        </div>
      </div>
      <div id="undoBtn"><i class="fa-solid fa-arrow-rotate-left"></i></div>
      <div id="redoBtn"><i class="fa-solid fa-rotate-right"></i></div>
      <button id="runButton" onclick="runTab()">
        <i class="fas fa-play"></i> Run
      </button>
      <div id="addTabButton"><i class="fas fa-plus"></i></div>
      <div id="lightMode" onclick="changeToLightMode()">
        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
          <circle cx="12" cy="12" r="5" stroke="white" stroke-width="2" fill="none" />
          <line x1="12" y1="2" x2="12" y2="4" stroke="white" stroke-width="2" />
          <line x1="12" y1="20" x2="12" y2="22" stroke="white" stroke-width="2" />
          <line x1="2" y1="12" x2="4" y2="12" stroke="white" stroke-width="2" />
          <line x1="20" y1="12" x2="22" y2="12" stroke="white" stroke-width="2" />
          <line x1="5.5" y1="5.5" x2="7" y2="7" stroke="white" stroke-width="2" />
          <line x1="17" y1="5.5" x2="18.5" y2="7" stroke="white" stroke-width="2" />
          <line x1="5.5" y1="18.5" x2="7" y2="17" stroke="white" stroke-width="2" />
          <line x1="17" y1="18.5" x2="18.5" y2="17" stroke="white" stroke-width="2" />
        </svg>
      </div>
      <div id="fullScreenBtn" onclick="fullScreen()">
        <i class="fa-solid fa-up-right-and-down-left-from-center"></i>
      </div>
    </div>
    <div id="activityBar">
      <div id="addTabButton_media"><i class="fas fa-plus"></i></div>
      <div class="icon" id="searchIcon" data-label="Search" data-target="searchPanel">
        <i class="fas fa-search"></i>
      </div>
      <div class="icon" id="gitIcon" data-label="Source Control" data-target="gitPanel">
        <i class="fas fa-code-branch"></i>
      </div>
      <div class="icon" id="settingsIcon" data-label="Settings" data-target="settingsPanel">
        <i class="fas fa-cog"></i>
      </div>
      <div class="icon" id="exportIcon" data-label="Export" data-target="exportPanel">
        <i class="fas fa-file-export"></i>
      </div>
    </div>

    <div id="gitPanel" class="sidebar-panel">
      <input type="url" id="gitUrl" placeholder="Enter GitHub file URL" />
      <button id="loadGitButton" disabled="true">Load</button>
    </div>
    <div id="settingsPanel" class="sidebar-panel">
      <div>
        <label for="tabSizeInput">Tab Size: <span id="tabSizeDisplay">3</span></label>
        <input id="tabSizeInput" type="range" min="1" max="8" value="3" class="vs-range" />
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" style="margin-top: 10px;">
          <label class="form-check-label" for="flexSwitchCheckDefault">Terminate Worker</label>
        </div>
      </div>
    </div>
    <div id="exportPanel" class="sidebar-panel">
      <div class="exportBtnsWrapper">
        <select id="exportSelect">
          <option value="current">Download Current Script</option>
          <option id="allZip" value="allZip">Download All Scripts (zip)</option>
          <option value="image">Export as Image</option>
          <option value="pdf">Export as PDF</option>
        </select>
        <button id="exportButton" class="vs-button" onclick="exportCode()">Export</button>
      </div>
    </div>
    <div id="mainContainer">
      <div id="tabBar" class="theme color252526"></div>
      <div id="tabsContainer"></div>
      <div id="statusBar">
        <div class="status-item" id="statusPosition">Ln 1, Col 1</div>
        <div class="status-item">UTF-8</div>
        <div class="status-item" id="statusSpaces">Spaces: 3</div>
        <div class="status-item">JavaScript</div>
      </div>
    </div>
  </div>

  <div id="exportModal" class="previewModal">
    <div class="previewModal-content" id="exportModalContent">
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
  <script>
    const workerPath = "{% url 'betzi_test_js' %}";
    const { jsPDF } = window.jspdf;
    let currentTab = null;
    let workerBlobURL = null;
    let activeDropdown = null;
    let spaces = 3;
    let tabs = [];
    let activeTabId = null;
    let draggedTabId = null;
    let lastDropSide = null;
    let darkModeFlag = true;
    let nextWorker;
    let tabSizeInput = document.getElementById("tabSizeInput");
    let tabSizeDisplay = document.getElementById("tabSizeDisplay");
    const compiler = document.getElementById("compiler");
    const exportSelect = document.getElementById("exportSelect");
    const flexSwitchCheckDefault = document.getElementById("flexSwitchCheckDefault");
    const modal = document.getElementById("exportModal");
    const exportModalContent = document.getElementById("exportModalContent");
    if (window.innerWidth < 768) {
      compiler.style.width = '100%';
      compiler.style.height = '100vh';
      compiler.style.margin = '0';
      document.getElementById("fullScreenBtn").style.display = 'none';
    } else {
      window.onload = function () {
        compiler.style.width = '60%';
        fullScreen();
      };
    }
    function fullScreen() {
      if (compiler.style.width === "60%") {
        compiler.style.width = "100%";
        compiler.style.height = "100vh";
        compiler.style.margin = "0";
      } else {
        compiler.style.width = "60%";
        compiler.style.height = "500px";
        compiler.style.margin = '100px auto';
      }
    }
    document.addEventListener('keydown', function (event) {
      if (compiler.style.width === "100%") {
        if (event.key === 'Escape' && modalIsOpen()) {
          closeModal("close");
        } else if (event.key === 'Escape') {
          compiler.style.width = "60%";
          compiler.style.height = "500px";
          compiler.style.margin = '100px auto';
        }
      }
    });
    const themeMapDark = {
      "color252526": "colorf0f0f0",
      "color1e1e1e": "colorffffff"
    };
    const themeMapLight = {
      "colorf0f0f0": "color252526",
      "colorffffff": "color1e1e1e"
    };
    const lightModeDiv = document.getElementById("lightMode");
    const sunSvg = lightModeDiv.innerHTML;

    function changeToLightMode() {
      if (darkModeFlag) {
        document.querySelectorAll(".outputContainer").forEach((element) => {
          element.classList.add("lightMode");
          element.classList.remove("darkMode")
        });

        document.getElementById('compiler').classList.add("lightMode");
        document.getElementById('compiler').classList.remove("darkMode");

        darkModeFlag = false;
        document.querySelectorAll(".theme").forEach((element) => {
          element.classList.forEach((cls) => {
            if (themeMapDark[cls]) {
              element.classList.remove(cls);
              element.classList.add(themeMapDark[cls]);
            }
          });
        });
        monaco.editor.setTheme("custom-light");

        tabs.forEach(tab => {
          let lines = tab.outputElement.querySelectorAll(".outputContent");
          lines.forEach(line => {
            if (line.classList.contains("dark-log")) {
              line.classList.remove("dark-log");
              line.classList.add("light-log");
            } else if (line.classList.contains("dark-error")) {
              line.classList.remove("dark-error");
              line.classList.add("light-error");
            } else if (line.classList.contains("dark-warn")) {
              line.classList.remove("dark-warn");
              line.classList.add("light-warn");
            } else if (line.classList.contains("dark-info")) {
              line.classList.remove("dark-info");
              line.classList.add("light-info");
            }
            let promptSpan = line.querySelector(".dark-prompt");
            if (promptSpan) {
              promptSpan.classList.remove("dark-prompt");
              promptSpan.classList.add("light-prompt");
            }
          });
        });

      } else {
        document.querySelectorAll(".outputContainer").forEach((element) => {
          element.classList.remove("lightMode");
          element.classList.add("darkMode")
        });

        document.getElementById('compiler').classList.remove("lightMode");
        document.getElementById('compiler').classList.add("darkMode");

        lightModeDiv.innerHTML = sunSvg;
        darkModeFlag = true;
        document.querySelectorAll(".theme").forEach((element) => {
          element.classList.forEach((cls) => {
            if (themeMapLight[cls]) {
              element.classList.remove(cls);
              element.classList.add(themeMapLight[cls]);
            }
          });
        });
        monaco.editor.setTheme("custom-dark");

        tabs.forEach(tab => {
          let lines = tab.outputElement.querySelectorAll(".outputContent");
          lines.forEach(line => {
            if (line.classList.contains("light-log")) {
              line.classList.remove("light-log");
              line.classList.add("dark-log");
            } else if (line.classList.contains("light-error")) {
              line.classList.remove("light-error");
              line.classList.add("dark-error");
            } else if (line.classList.contains("light-warn")) {
              line.classList.remove("light-warn");
              line.classList.add("dark-warn");
            } else if (line.classList.contains("light-info")) {
              line.classList.remove("light-info");
              line.classList.add("dark-info");
            }
            let promptSpan = line.querySelector(".light-prompt");
            if (promptSpan) {
              promptSpan.classList.remove("light-prompt");
              promptSpan.classList.add("dark-prompt");
            }
          });
        });
      }
      updateUndoRedoButtons();
    }


    function reorderTabsByTab(dId, tId, side) {
      let dIndex = tabs.findIndex((x) => x.id === dId);
      let tIndex = tabs.findIndex((x) => x.id === tId);
      if (dIndex < 0 || tIndex < 0) return;
      let removed = tabs.splice(dIndex, 1)[0];
      let newI = tIndex + (side === "right" ? 1 : 0);
      if (dIndex < tIndex) newI--;
      tabs.splice(newI, 0, removed);
      let b = document.getElementById("tabBar");
      tabs.forEach((x) => {
        b.appendChild(x.tabElement);
      });
    }
    function createTab(desiredName = null, content = null) {
      let name = desiredName
        ? getUniqueTabName(desiredName)
        : getNextTabName();
      let id = Date.now();
      let sharedBuffer = new SharedArrayBuffer(1024);
      let view = new Int32Array(sharedBuffer);
      let tabEl = document.createElement("div");
      tabEl.classList.add("tab");
      tabEl.draggable = true;
      let titleSpan = document.createElement("span");
      titleSpan.classList.add("tab-title");
      titleSpan.textContent = name;
      tabEl.appendChild(titleSpan);
      let closeIcon = document.createElement("i");
      closeIcon.classList.add("fas", "fa-times", "close");
      tabEl.appendChild(closeIcon);
      let editorOutputWrapper = document.createElement("div");
      editorOutputWrapper.classList.add("editor-and-output");
      let editorContainer = document.createElement("div");
      editorContainer.classList.add("editorContainer");
      editorOutputWrapper.appendChild(editorContainer);
      let outputContainer = document.createElement("div");
      outputContainer.classList.add("outputContainer");
      outputContainer.classList.add("allowSelect")
      outputContainer.classList.add("resize");
      outputContainer.classList.add(darkModeFlag ? "darkMode" : "lightMode");
      let controlsBar = document.createElement("div");
      controlsBar.classList.add("controls");
      controlsBar.classList.add("theme");
      controlsBar.classList.add(darkModeFlag ? "color252526" : "colorf0f0f0");
      outputContainer.appendChild(controlsBar);

      controlsBar.addEventListener('mousedown', function (e) {
        e.preventDefault();

        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.cursor = 'ns-resize';
        overlay.style.zIndex = '10000';
        overlay.style.backgroundColor = 'transparent';
        document.body.appendChild(overlay);

        let startY = e.clientY;
        let parentHeight = outputContainer.parentElement.clientHeight;
        let startHeight = outputContainer.offsetHeight;

        const MIN_HEIGHT = 30;
        const MAX_HEIGHT = 60;

        function onMouseMove(e) {
          let dy = e.clientY - startY;
          let newHeight = startHeight - dy;


          let newHeightPercent = (newHeight / parentHeight) * 100;


          newHeightPercent = Math.max(MIN_HEIGHT, Math.min(newHeightPercent, MAX_HEIGHT));


          outputContainer.style.height = newHeightPercent + '%';
        }

        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          overlay.remove();
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });




      let outputDiv = document.createElement("div");
      outputDiv.classList.add("output");
      outputDiv.setAttribute("tabindex", "0");
      outputDiv.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key.toLowerCase() === "a") {
          e.preventDefault();
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(outputDiv);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      });
      outputContainer.appendChild(outputDiv);
      editorOutputWrapper.appendChild(outputContainer);
      let tabBar = document.getElementById("tabBar");
      let addTabBtn = document.getElementById("addTabButton");
      let addTabBtn_media = document.getElementById("addTabButton_media");
      tabBar.appendChild(tabEl);
      let tabsContainer = document.getElementById("tabsContainer");
      tabsContainer.appendChild(editorOutputWrapper);
      let editorInstance = monaco.editor.create(editorContainer, {
        language: "javascript",
        theme: darkModeFlag ? "custom-dark" : "custom-light",
        automaticLayout: true,
        tabSize: spaces,
        insertSpaces: true,
        minimap: { enabled: true },
        fontSize: 14,
        fontFamily: 'Fira Code, Consolas, "Courier New", monospace',
        fontLigatures: true,
        folding: true,
        lineNumbers: "on",
        wordWrap: "on",
        scrollbar: { verticalScrollbarSize: 8, horizontalScrollbarSize: 8 },
        contextmenu: true,
        selectionHighlight: true,
        renderIndentGuides: true,
        renderLineHighlight: "all",
        cursorStyle: "line",
        cursorBlinking: "blink",
        quickSuggestions: true,
        parameterHints: true,
        autoClosingBrackets: "always",
        autoClosingQuotes: "always",
        formatOnType: true,
        formatOnPaste: true,
        suggestOnTriggerCharacters: true,
        smoothScrolling: true,
        breadcrumbs: { enabled: true },
        fixedOverflowWidgets: true,
        folding: true,
      });
      editorInstance.getModel().onDidChangeOptions((e) => {
        const tabSizeNum = editorInstance.getModel().getOptions().tabSize
        if (tabSizeNum) {
          tabSizeInput.value = tabSizeNum;
          tabSizeInput.dispatchEvent(new Event("input"));
        }
      });
      let tabObj = {
        id,
        name,
        sharedBuffer,
        view,
        tabElement: tabEl,
        editorContainer,
        outputElement: outputDiv,
        editorInstance,
        worker: null,
        editorAndOutput: editorOutputWrapper
      };
      tabs.push(tabObj);
      editorInstance.onDidChangeCursorPosition(() => {
        updateStatusPosition();
      });
      closeIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        if (tabs.length === 1) {
          return;
        }
        closeTab(id);
        if (tabs.length === 1) {
          document.body.classList.add("lastTab");
        }
      });
      tabEl.addEventListener("dragstart", (ev) => {
        switchTab(id);
        ev.dataTransfer.setData("text/plain", "");
        ev.dataTransfer.effectAllowed = "move";
        draggedTabId = id;
        tabEl.classList.add("dragging");
      });
      tabEl.addEventListener("dragend", () => {
        tabEl.classList.remove("dragging");
        draggedTabId = null;
        lastDropSide = null;
        document.querySelectorAll(".tab")
          .forEach((m) => m.classList.remove("tab-drop-left", "tab-drop-right", "dragging"));
      });
      tabEl.addEventListener("dragover", (ev) => {
        ev.preventDefault();
        if (!draggedTabId || tabEl.classList.contains("dragging")) return;
        let rect = tabEl.getBoundingClientRect();
        let mid = rect.left + rect.width / 2;
        if (ev.clientX < mid) {
          tabEl.classList.add("tab-drop-left");
          tabEl.classList.remove("tab-drop-right");
          lastDropSide = "left";
        } else {
          tabEl.classList.add("tab-drop-right");
          tabEl.classList.remove("tab-drop-left");
          lastDropSide = "right";
        }
      });
      tabEl.addEventListener("dragleave", () => {
        tabEl.classList.remove("tab-drop-left", "tab-drop-right");
      });
      tabEl.addEventListener("drop", (ev) => {
        ev.preventDefault();
        tabEl.classList.remove("tab-drop-left", "tab-drop-right");
        if (!draggedTabId) return;
        reorderTabsByTab(draggedTabId, id, lastDropSide);
        lastDropSide = null;
      });
      titleSpan.addEventListener("dblclick", () => {
        makeTabTitleEditable(tabObj);
      });
      if (content !== null) {
        editorInstance.setValue(content);
      } else {
        editorInstance.setValue(`// ${name}
console.log("This is a log");
console.info("This is an info");
console.warn("This is a warning");
console.error("This is an error");
prompt("This is a prompt:");
`);
      }
      switchTab(id);
      if (tabs.length > 1) {
        document.body.classList.remove("lastTab");
      } else {
        document.body.classList.add("lastTab");
      }
      return id;
    }
    function getUniqueTabName(baseName, tabId = null) {
      let candidate = baseName;
      let suffix = 1;
      while (tabs.some((t) =>
        t.id !== tabId && t.name.toLowerCase() === candidate.toLowerCase()
      )) {
        candidate = baseName + `(${suffix++})`;
      }
      return candidate;
    }
    function getNextTabName() {
      let max = 0;
      for (let t of tabs) {
        let match = t.name.match(/^Tab(\d+)$/);
        if (match) {
          let num = parseInt(match[1], 10);
          if (num > max) max = num;
        }
      }
      return `Tab${max + 1}`;
    }
    function switchTab(tabId) {
      if (activeTabId !== null) {
        let current = tabs.find((x) => x.id === activeTabId);
        if (current) {
          current.tabElement.classList.remove("active");
          current.editorAndOutput.classList.remove("active");
        }
      }
      let newTab = tabs.find((x) => x.id === tabId);
      if (newTab) {
        newTab.tabElement.classList.add("active");
        newTab.editorAndOutput.classList.add("active");
        activeTabId = tabId;
        updateStatusPosition();
        currentTab = newTab;
      }
    }
    function closeTab(tabId) {
      let i = tabs.findIndex((x) => x.id === tabId);
      if (i === -1) return;
      let obj = tabs[i];
      if (obj.worker) {
        obj.worker.terminate();
        obj.worker = null;
      }
      obj.tabElement.remove();
      obj.editorAndOutput.remove();
      tabs.splice(i, 1);
      if (activeTabId === tabId) {
        if (tabs.length > 0) {
          switchTab(tabs[tabs.length - 1].id);
        } else {
          activeTabId = null;
        }
      }
    }
    async function handlePrompt(message, defaultValue, tab) {
      return new Promise((resolve) => {
        let container = tab.outputElement;
        let pl = document.createElement("div");
        pl.classList.add("prompt-line", "outputContent");

        let flexContainer = document.createElement("div");
        flexContainer.classList.add("flexContainer");

        let symbolDiv = document.createElement("div");
        symbolDiv.classList.add("dontAllowSelect", "symbolDiv");
        symbolDiv.textContent = `[?]`;

        let messageDiv = document.createElement("div");
        messageDiv.textContent = message;
        messageDiv.classList.add("outputItem")

        flexContainer.appendChild(symbolDiv);
        flexContainer.appendChild(messageDiv);
        pl.appendChild(flexContainer);

        let inp = document.createElement("input");
        inp.type = "text";
        inp.autocomplete = "off";
        inp.classList.add("promptInput");
        if (defaultValue) {
          inp.value = defaultValue;
        }
        inp.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            let val = inp.value.trim();
            inp.disabled = true;
            inp.style.border = "none";
            inp.style.backgroundColor = "transparent";
            if (currentTab.groupStack && currentTab.groupStack.length > 0) {
              let newContainer = currentTab.groupStack[currentTab.groupStack.length - 1];
              pl.style.marginLeft = (currentTab.groupStack.length * 20) + "px";
              newContainer.appendChild(pl);
            }
            inp.style.height = pl.clientHeight + "px";
            let te = new TextEncoder();
            let encoded = te.encode(val + "\0");
            let respBuffer = new Uint8Array(tab.sharedBuffer, 4);
            respBuffer.fill(0);
            respBuffer.set(encoded);
            Atomics.store(tab.view, 0, 1);
            Atomics.notify(tab.view, 0);
            resolve();
          }
        });
        pl.appendChild(inp);
        container.appendChild(pl);
        inp.style.height = pl.clientHeight + "px";
        inp.focus();
      });
    }

    async function handleAlert(message, tab) {
      return new Promise((resolve) => {
        let container = tab.outputElement;
        const alertLine = document.createElement("div");
        alertLine.classList.add("prompt-line", "outputContent");

        let flexContainer = document.createElement("div");
        flexContainer.classList.add("flexContainer");

        let symbolDiv = document.createElement("div", "symbolDiv");
        symbolDiv.classList.add("dontAllowSelect");
        symbolDiv.textContent = `[!]`;

        let messageDiv = document.createElement("div");
        messageDiv.textContent = message;
        messageDiv.classList.add("outputItem")

        flexContainer.appendChild(symbolDiv);
        flexContainer.appendChild(messageDiv);
        alertLine.appendChild(flexContainer);

        const okBtn = document.createElement("button");
        okBtn.classList.add("vs-button");
        okBtn.style.marginLeft = "10px";
        okBtn.textContent = "OK";
        alertLine.appendChild(okBtn);

        container.appendChild(alertLine);
        okBtn.focus();
        okBtn.addEventListener("click", () => {
          Atomics.store(tab.view, 0, 1);
          Atomics.notify(tab.view, 0);
          if (currentTab.groupStack && currentTab.groupStack.length > 0) {
            let newContainer = currentTab.groupStack[currentTab.groupStack.length - 1];
            alertLine.style.marginLeft = (currentTab.groupStack.length * 20) + "px";
            newContainer.appendChild(alertLine);
          }
          appendToOutput(container, "info", message);
          alertLine.remove();
          resolve();
        });
      });
    }




    async function runTab() {
      let btn = document.getElementById("runButton");
      btn.disabled = true;
      let tab = tabs.find((x) => x.id === currentTab.id);
      if (!tab) {
        btn.disabled = false;
        return;
      }
      try {
        clearConsole(tab.outputElement);
        if (tab.worker) {
          tab.worker.terminate();
          tab.worker = null;
        }
        await cacheWorkerCode();
        tab.groupStack = [];
        let w;
        if (!nextWorker) {
          w = new Worker(workerPath);
        } else {
          w = nextWorker;
          nextWorker = null;
        }
        tab.worker = w;
        w.onmessage = async (e) => {
          let type = e.data.type;
          let msg = e.data.message;

          if (!currentTab.groupStack) {
            currentTab.groupStack = [];
          }

          if (type === "group") {
            const details = document.createElement("details");
            details.open = !e.data.collapsed;
            const summary = document.createElement("summary");
            summary.style.display = "-webkit-box"
            if (typeof msg === "string") {
              summary.textContent = msg;
            } else if (typeof msg === "object") {
              let actualMsg = "";
              let subMsgDiv
              for (let key in msg) {
                subMsgDiv = document.createElement("div");
                if (msg[key][1]) {
                  subMsgDiv = lazyRenderTreeNode(null, msg[key][0])
                  subMsgDiv.style.marginRight = "8px";
                  summary.appendChild(subMsgDiv);
                } else {
                  subMsgDiv = document.createElement("div");
                  subMsgDiv.style.marginRight = "8px";
                  subMsgDiv.innerText = msg[key][0]
                  summary.appendChild(subMsgDiv);
                }
              }
            }
            details.appendChild(summary);
            let parentContainer = currentTab.groupStack.length > 0 ?
              currentTab.groupStack[currentTab.groupStack.length - 1] :
              currentTab.outputElement;
            parentContainer.appendChild(details);
            const groupLevel = currentTab.groupStack.length;
            details.style.marginLeft = groupLevel ? "20px" : "4px";
            currentTab.groupStack.push(details);
          }
          else if (type === "groupEnd") {
            if (currentTab.groupStack && currentTab.groupStack.length > 0) {
              currentTab.groupStack.pop();
            }
          }

          else if (type === "prompt") {
            await handlePrompt(msg, e.data.default, tab);
          }
          else if (type === "alert") {
            await handleAlert(msg, tab);
          }
          else if (type === "clear") {
            clearConsole(tab.outputElement);
          }
          else if (type === "table") {
            appendTable(tab.outputElement, e.data, msg);
          }
          else if (["log", "error", "warn", "info"].includes(type)) {
            const isForce = e.data.forceUse;
            appendToOutput(tab.outputElement, type, msg, isForce);
          }
          else if (type === "dir") {
            appendDir(tab.outputElement, msg);
          }
        }

        w.onerror = (err) => {
          appendToOutput(tab.outputElement, "error", err.message);
          if (flexSwitchCheckDefault.checked) {
            appendToOutput(tab.outputElement, "log",
              "The script has finished running with exit code 1.", true);
          }
        };
        let code = tab.editorInstance.getValue();
        w.postMessage({
          type: "execute",
          code,
          sharedBuffer: tab.sharedBuffer,
          flexSwitchCheckDefault: flexSwitchCheckDefault.checked
        });
      }
      catch (ex) {
        appendToOutput(tab.outputElement, "error", ex.message);
        appendToOutput(tab.outputElement, "log",
          "The script has finished running with exit code 1.", true);
      }
      btn.disabled = false;
      nextWorker = new Worker(workerPath);
    }
    function clearConsole(outputDiv) {
      outputDiv.innerHTML = "";
    }

    function appendDir(outputDiv, obj) {
      let container = outputDiv;
      if (currentTab.groupStack && currentTab.groupStack.length > 0) {
        container = currentTab.groupStack[currentTab.groupStack.length - 1];
      }
      let line = document.createElement("div");
      line.classList.add("outputContent");
      const groupLevel = currentTab.groupStack ? currentTab.groupStack.length : 0;
      line.style.marginLeft = groupLevel ? "20px" : "4px";
      let styleClass = (darkModeFlag ? "dark-" : "light-") + "log";
      line.classList.add(styleClass);
      line.innerHTML = obj;
      container.appendChild(line);
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtmlVisible(text) {
      return text.replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, '\\n');
    }



    function lazyRenderTreeNode(key, tree) {
      if (typeof tree !== 'object' || tree === null) {
        const div = document.createElement('div');
        let content = '';
        if (typeof tree === 'string') {
          content = `<span class="objinsp objinsp-highlight-string">${escapeHtmlVisible(tree)}</span>`;
        } else if (typeof tree === 'number') {
          content = `<span class="objinsp objinsp-highlight-number">${tree}</span>`;
        } else {
          content = `<span class="objinsp objinsp-highlight-primitive">${tree}</span>`;
        }
        if (key !== null && key !== undefined) {

          div.innerHTML = `<div class="objinsp"><span class="objinsp-highlight-key"> ${key}: </span>${content}</div>`;
        } else {
          div.innerHTML = content;
        }
        return div;
      }

      let summaryText = "";
      let childrenTree = null;
      if (key !== null) {
        summaryText = key;
        childrenTree = tree;
      } else {
        const keys = Object.keys(tree);
        if (keys.length > 0) {
          summaryText = keys[0];
          childrenTree = tree[keys[0]];
        } else {
          summaryText = "{}";
          childrenTree = {};
        }
      }
      if (summaryText.includes(":")) {
        const both = summaryText.split(":");
        summaryText = both[0];
        summaryText += `:<span class="objinsp objinsp-highlight-value">${both[1]}</span>`;
      }
      const detailsEl = document.createElement('details');
      detailsEl.setAttribute('data-loaded', 'false');
      const summaryEl = document.createElement('summary');
      summaryEl.className = 'objinsp objinsp-summary';
      summaryEl.innerHTML = `<span class="objinsp objinsp-highlight-type">${summaryText}</span>`;
      detailsEl.appendChild(summaryEl);

      detailsEl.addEventListener('toggle', function () {
        if (detailsEl.open && detailsEl.getAttribute('data-loaded') === 'false') {
          const container = document.createElement('div');
          container.className = 'objinsp-node';
          const childKeys = Object.keys(childrenTree);
          childKeys.forEach(function (childKey) {
            const childNode = lazyRenderTreeNode(childKey, childrenTree[childKey]);
            container.appendChild(childNode);
          });
          detailsEl.appendChild(container);
          detailsEl.setAttribute('data-loaded', 'true');
        }
      });
      return detailsEl;
    }


    function gotoLine(lineNumber) {
      const model = currentTab.editorInstance.getModel();
      if (lineNumber > model.getLineCount()) {
        return;
      }
      const column = model.getLineMaxColumn(lineNumber);
      currentTab.editorInstance.setPosition({ lineNumber, column });
      currentTab.editorInstance.revealLineInCenter(lineNumber);
      currentTab.editorInstance.focus();
    }
    const symbolsMap = { log: ">", error: "x", warn: "!", info: "i", prompt: "?" };

    function appendToOutput(outputDiv, type, message, forceUse = false) {
      let container = outputDiv;
      if (currentTab.groupStack && currentTab.groupStack.length > 0 && !forceUse) {
        container = currentTab.groupStack[currentTab.groupStack.length - 1];
      }
      let line = document.createElement("div");
      line.classList.add("outputContent");
      var groupLevel = currentTab.groupStack ? currentTab.groupStack.length : 0;
      if (forceUse) {
        groupLevel = 0;
      }
      line.style.marginLeft = groupLevel ? "20px" : "4px";
      let styleClass = (darkModeFlag ? "dark-" : "light-") + type;
      line.classList.add(styleClass);

      let flexContainer = document.createElement("div");
      flexContainer.classList.add("flexContainer");

      let symbolDiv = document.createElement("div");
      symbolDiv.classList.add("dontAllowSelect", "symbolDiv");

      symbolDiv.textContent = `[${symbolsMap[type]}]`;

      let messageDiv = document.createElement("div");
      messageDiv.classList.add("outputItem");
      if (type === "error" && forceUse) {
        const lines = message.split("\n");
        messageDiv.innerHTML = `<div>${lines[0]}\n<div style="margin-left: 20px;">${lines.slice(1).join("\n")}</div></div>`;
        const matches = message.match(/\(js:\d+\)/g);
        if (matches) {
          matches.forEach(match => {
            const lineNumber = parseInt(match.match(/\d+/)[0]);
            messageDiv.innerHTML = messageDiv.innerHTML.replace(match, `<span class="error-line handPointer" onclick="gotoLine(${lineNumber})">${match}</span>`);
          });
        }
      }
      else if (typeof message === "object") {
        let actualMsg = "";
        let subMsgDiv
        for (let key in message) {
          subMsgDiv = document.createElement("div");
          if (message[key][1]) {
            subMsgDiv = lazyRenderTreeNode(null, message[key][0])
            subMsgDiv.style.marginRight = "8px";
            messageDiv.appendChild(subMsgDiv);
          } else {
            subMsgDiv = document.createElement("div");
            subMsgDiv.style.marginRight = "8px";
            subMsgDiv.innerText = message[key][0]
            messageDiv.appendChild(subMsgDiv);
          }
        }
      } else {
        messageDiv.textContent = message;
      }

      flexContainer.appendChild(symbolDiv);
      flexContainer.appendChild(messageDiv);
      line.appendChild(flexContainer);

      container.appendChild(line);
      container.scrollTop = container.scrollHeight;
    }


    function appendTable(outputElement, tableInfo, msg) {
      let container = outputElement;
      if (currentTab.groupStack && currentTab.groupStack.length > 0) {
        container = currentTab.groupStack[currentTab.groupStack.length - 1];
      }

      let tableData, headerOrder;
      if (
        tableInfo.table &&
        typeof tableInfo.table === "object" &&
        "tableData" in tableInfo.table &&
        "headerOrder" in tableInfo.table
      ) {
        tableData = tableInfo.table.tableData;
        headerOrder = tableInfo.table.headerOrder;
      } else if (tableInfo.table && typeof tableInfo.table === "object") {
        tableData = tableInfo.table;
        headerOrder = Object.keys(tableData);
        headerOrder.sort((a, b) => (a === "(index)" ? -1 : b === "(index)" ? 1 : 0));
      } else {
        appendToOutput(container, "error", "Invalid table data received.");
        return;
      }

      if (
        !tableData ||
        !Array.isArray(tableData["(index)"]) ||
        headerOrder.length === 0 ||
        tableData["(index)"].length === 0
      ) {
        appendToOutput(container, "log", "");
        return;
      }

      const rowCount = tableData["(index)"].length;
      const div = document.createElement("div");
      div.classList.add("outputContent");
      const groupLevel = currentTab.groupStack ? currentTab.groupStack.length : 0;
      div.style.marginLeft = groupLevel ? "20px" : "4px";

      const table = document.createElement("table");
      table.classList.add("console-table");

      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      headRow.classList.add("console-table-row");
      headerOrder.forEach(col => {
        const th = document.createElement("th");
        th.classList.add("console-table-header");
        th.textContent = col;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      for (let i = 0; i < rowCount; i++) {
        const tr = document.createElement("tr");
        tr.classList.add("console-table-row");
        headerOrder.forEach(col => {
          const td = document.createElement("td");
          td.classList.add("console-table-data");

          let value = tableData[col] && tableData[col][i];
          if (typeof value === "object" && value !== null) {
            if (Array.isArray(value)) {
              td.textContent = `[Array(${value.length})]`;
            } else if (value === "[Circular]") {
              td.textContent = "{…}";
            } else {
              const expandable = document.createElement("span");
              expandable.classList.add("expandable");
              expandable.textContent = "{…}";
              expandable.style.cursor = "pointer";
              expandable.addEventListener("click", () => {
                if (expandable.classList.contains("expanded")) {
                  expandable.classList.remove("expanded");
                  const details = td.querySelector(".expandable-details");
                  if (details) details.remove();
                } else {
                  expandable.classList.add("expanded");
                  const details = document.createElement("div");
                  details.classList.add("expandable-details");
                  details.style.marginTop = "4px";
                  details.style.marginLeft = "20px";
                  details.innerHTML = objectToHTML(value, 1);
                  td.appendChild(details);
                }
              });
              td.appendChild(expandable);
            }
          } else if (typeof value === "function") {
            td.textContent = value;
          } else {
            td.textContent = (value === "undefined") ? "undefined" : String(value);
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);

      const symbolDiv = document.createElement("div");
      symbolDiv.classList.add("dontAllowSelect");
      symbolDiv.innerHTML = "[>]";
      table.style.marginLeft = "7px";
      symbolDiv.style.marginTop = "7px";
      div.appendChild(symbolDiv);
      const wrapBoth = document.createElement("div");
      wrapBoth.style.display = "block"
      wrapBoth.style.width = "100%"
      const wrapTable = document.createElement("div");
      wrapTable.style.display = "flex";
      wrapTable.appendChild(table);
      wrapBoth.style.width = "100%";
      wrapBoth.appendChild(wrapTable);
      div.appendChild(wrapBoth);
      let actualMsg = "";
      let subMsgDiv
      for (let key in msg) {
        subMsgDiv = document.createElement("div");
        if (msg[key][1]) {
          subMsgDiv = lazyRenderTreeNode(null, msg[key][0])
          subMsgDiv.style.marginRight = "8px";
          wrapBoth.appendChild(subMsgDiv);
        } else {
          subMsgDiv = document.createElement("div");
          subMsgDiv.style.marginRight = "8px";
          subMsgDiv.innerText = msg[key][0]
          wrapBoth.appendChild(subMsgDiv);
        }
      }
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }


    function objectToHTML(obj, level = 0) {
      if (obj === null) {
        return `<span style="opacity:0.7;">null</span>`;
      }
      if (typeof obj !== "object") {
        return `<span>${escapeHtml(String(obj))}</span>`;
      }
      if (Array.isArray(obj)) {
        let html = `<details open style="margin-left:${level * 20}px;">`;
        html += `<summary>Array(${obj.length})</summary>`;
        obj.forEach((value, i) => {
          html += `<div style="margin-left:${(level + 1) * 20}px;">[${i}] => ${objectToHTML(value, level + 1)}</div>`;
        });
        html += `</details>`;
        return html;
      }
      const keys = Object.keys(obj);
      let html = `<details open style="margin-left:${level * 20}px;">`;
      html += `<summary>Object {${keys.length} keys}</summary>`;
      keys.forEach((key) => {
        html += `<div style="margin-left:${(level + 1) * 20}px;">
          <strong>${escapeHtml(key)}</strong>:
          ${objectToHTML(obj[key], level + 1)}
        </div>`;
      });
      html += `</details>`;
      return html;
    }
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
    require.config({
      paths: {
        vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs"
      }
    });
    window.MonacoEnvironment = {
      getWorkerUrl: function () {
        return "data:text/javascript;charset=utf-8," + encodeURIComponent(`
          self.MonacoEnvironment={baseUrl:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/'};
          importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/base/worker/workerMain.js');
        `);
      }
    };
    async function cacheWorkerCode() {
      if (!workerBlobURL) {
        let resp = await fetch(workerPath);
        let code = await resp.text();
        let blob = new Blob([code], { type: "application/javascript" });
        workerBlobURL = URL.createObjectURL(blob);
      }
    }
    require(["vs/editor/editor.main"], function () {
      monaco.languages.setMonarchTokensProvider('javascript', {
        defaultToken: 'invalid',
        tokenPostfix: '.js',

        keywords: [
          'break', 'case', 'catch', 'class', 'continue', 'debugger',
          'default', 'do', 'else', 'export', 'extends', 'finally',
          'for', 'from', 'get', 'if', 'import', 'in', 'set', 'super',
          'switch', 'symbol', 'this', 'throw', 'try', 'while', 'with',
          'yield', 'await', 'of'
        ],

        specialKeywords: [
          'let', 'const', 'var', 'function',
          'null', 'undefined', 'true', 'false', 'void', 'typeof',
          'new', 'delete', 'instanceof'
        ],

        typeKeywords: [
          'any', 'boolean', 'number', 'object', 'string', 'undefined'
        ],

        operators: [
          '<=', '>=', '==', '!=', '===', '!==', '=>', '+', '-', '**',
          '*', '/', '%', '++', '--', '<<', '</', '>>', '>>>', '&',
          '|', '^', '!', '~', '&&', '||', '?', ':', '=', '+=', '-=',
          '*=', '**=', '/=', '%=', '<<=', '>>=', '>>>=', '&=', '|=',
          '^=', '@'
        ],

        symbols: /[=><!~?:&|+\-*\/\^%]+/,
        escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,
        digits: /\d+(_+\d+)*/,
        octaldigits: /[0-7]+(_+[0-7]+)*/,
        binarydigits: /[0-1]+(_+[0-1]+)*/,
        hexdigits: /[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,
        regexpctl: /[(){}\[\]\$\^|\-*+?\.]/,
        regexpesc: /\\(?:[bBdDfnrstvwWn0\\\/]|@regexpctl|c[A-Z]|x[0-9a-fA-F]{2}|u[0-9a-fA-F]{4})/,

        tokenizer: {
          root: [
            [/[{}]/, 'delimiter.bracket'],
            { include: 'common' }
          ],

          common: [
            [/=>/, 'arrow'],

            [/\basync(?=\s+function\b)/, 'special.keyword'],

            [/(\.)([a-z_$][\w$]*)(?=\s*\()/, ['delimiter', 'method']],
            [/([a-z_$][\w$]*)(?=\s*\()/, 'method'],
            [/(\.)([a-z_$][\w$]*)/, ['delimiter', 'attribute']],

            [/[a-z_$][\w$]*/, {
              cases: {
                '@specialKeywords': 'special.keyword',
                '@keywords': 'keyword',
                '@typeKeywords': 'keyword',
                '@default': 'identifier'
              }
            }],
            [/[A-Z][\w\$]*/, 'type.identifier'],

            { include: '@whitespace' },

            [/\/(?=([^\\\/]|\\.)+\/([gimsuy]*)(\s*)(\.|;|\/|,|\)|\]|\}|$))/, { token: 'regexp', bracket: '@open', next: '@regexp' }],

            [/[()\[\]]/, '@brackets'],
            [/[<>](?!@symbols)/, '@brackets'],
            [/@symbols/, {
              cases: {
                '@operators': 'delimiter',
                '@default': ''
              }
            }],

            [/(@digits)[eE]([\-+]?(@digits))?/, 'number.float'],
            [/(@digits)\.(@digits)([eE][\-+]?(@digits))?/, 'number.float'],
            [/0[xX](@hexdigits)/, 'number.hex'],
            [/0[oO]?(@octaldigits)/, 'number.octal'],
            [/0[bB](@binarydigits)/, 'number.binary'],
            [/(@digits)/, 'number'],

            [/[;,.]/, 'delimiter'],

            [/"([^"\\]|\\.)*$/, 'string.invalid'],
            [/'([^'\\]|\\.)*$/, 'string.invalid'],
            [/"/, 'string', '@string_double'],
            [/'/, 'string', '@string_single'],
            [/`/, 'string', '@string_backtick']
          ],

          whitespace: [
            [/[ \t\r\n]+/, ''],
            [/\/\*\*(?!\/)/, 'comment.doc', '@jsdoc'],
            [/\/\*/, 'comment', '@comment'],
            [/\/\/.*$/, 'comment']
          ],

          comment: [
            [/[^\/*]+/, 'comment'],
            [/\*\//, 'comment', '@pop'],
            [/[\/*]/, 'comment']
          ],

          jsdoc: [
            [/[^\/*]+/, 'comment.doc'],
            [/\*\//, 'comment.doc', '@pop'],
            [/[\/*]/, 'comment.doc']
          ],

          regexp: [
            [/(\{)(\d+(?:,\d*)?)(\})/, ['regexp.escape.control', 'regexp.escape.control', 'regexp.escape.control']],
            [/(\[)(\^?)(?=(?:[^\]\\\/]|\\.)+)/, ['regexp.escape.control', { token: 'regexp.escape.control', next: '@regexrange' }]],
            [/(\()(\?:|\?=|\?!)/, ['regexp.escape.control', 'regexp.escape.control']],
            [/[()]/, 'regexp.escape.control'],
            [/@regexpctl/, 'regexp.escape.control'],
            [/[^\\\/]/, 'regexp'],
            [/@regexpesc/, 'regexp.escape'],
            [/\\\./, 'regexp.invalid'],
            [/(\/)([gimsuy]*)/, [{ token: 'regexp', bracket: '@close', next: '@pop' }, 'keyword.other']]
          ],

          regexrange: [
            [/-/, 'regexp.escape.control'],
            [/\^/, 'regexp.invalid'],
            [/@regexpesc/, 'regexp.escape'],
            [/[^\]]/, 'regexp'],
            [/\]/, { token: 'regexp.escape.control', next: '@pop', bracket: '@close' }]
          ],

          string_double: [
            [/[^\\"]+/, 'string'],
            [/@escapes/, 'string.escape'],
            [/\\./, 'string.escape.invalid'],
            [/"/, 'string', '@pop']
          ],

          string_single: [
            [/[^\\']+/, 'string'],
            [/@escapes/, 'string.escape'],
            [/\\./, 'string.escape.invalid'],
            [/'/, 'string', '@pop']
          ],

          string_backtick: [
            [/\$\{/, { token: 'delimiter.bracket', next: '@bracketCounting' }],
            [/[^\\`$]+/, 'string'],
            [/@escapes/, 'string.escape'],
            [/\\./, 'string.escape.invalid'],
            [/`/, 'string', '@pop']
          ],

          bracketCounting: [
            [/\{/, 'delimiter.bracket', '@bracketCounting'],
            [/\}/, 'delimiter.bracket', '@pop'],
            { include: 'common' }
          ]
        }
      });

      monaco.editor.defineTheme('custom-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          { token: 'special.keyword', foreground: '569cd6' },
          { token: 'keyword', foreground: 'c586c0' },
          { token: 'identifier', foreground: '9CDCFE' },
          { token: 'delimiter', foreground: 'D4D4D4' },
          { token: 'operator', foreground: 'D4D4D4' },
          { token: 'method', foreground: 'dcdcaa' },
          { token: 'attribute', foreground: '9cdcfe' },
          { token: 'arrow', foreground: '569cd6' },
          { token: 'type.identifier', foreground: '4EC9B0' },
          { token: 'function', foreground: 'dcdcaa' },
          { token: 'comment', foreground: '6A9955' },
          { token: 'string', foreground: 'CE9178' },
          { token: 'number', foreground: 'B5CEA8' },
          { token: 'regexp', foreground: 'D16969' },
          { token: 'string.escape', foreground: 'd7ba7d' },
          { token: 'string.escape.invalid', foreground: 'ffffff', background: 'e51400' },
          { token: 'string.escape.js', foreground: 'd7ba7d' },
        ],
        colors: {
          'editor.background': '#1E1E1E'
        }
      });

      monaco.editor.defineTheme('custom-light', {
        base: 'vs',
        inherit: true,
        rules: [
          { token: 'special.keyword', foreground: '0000FF' },
          { token: 'keyword', foreground: 'af00db' },
          { token: 'identifier', foreground: '0070c1' },
          { token: 'attribute', foreground: '001080' },
          { token: 'delimiter', foreground: '000000' },
          { token: 'operator', foreground: '000000' },
          { token: 'arrow', foreground: '0000FF' },
          { token: 'method', foreground: '795e26' },
          { token: 'function', foreground: '795e26' },
          { token: 'type.identifier', foreground: '267f99' },
          { token: 'comment', foreground: '008000' },
          { token: 'string', foreground: 'a31515' },
          { token: 'string.escape', foreground: 'a31515' },
          { token: 'string.escape.invalid', foreground: 'ffffff', background: 'e51400' },
          { token: 'string.escape.js', foreground: 'ee0000' },
          { token: 'number', foreground: '098658' },
          { token: 'regexp', foreground: 'd16969' }
        ],
        colors: {
          'editor.background': '#ffffff',
          'editor.foreground': '#333333'
        }
      });

      createTab();
    });

    function updateStatusPosition() {
      if (activeTabId === null) {
        document.getElementById("statusPosition").textContent = "Ln 0, Col 0";
        return;
      }
      let t = tabs.find((x) => x.id === activeTabId);
      if (!t) return;
      let pos = t.editorInstance.getPosition();
      if (pos) {
        document.getElementById("statusPosition").textContent = `Ln ${pos.lineNumber}, Col ${pos.column}`;
      }
    }
    document.getElementById('addTabButton').addEventListener("click", () => {
      createTab();
    });
    document.getElementById('addTabButton_media').addEventListener("click", () => {
      createTab();
    });
    document.getElementById("tabBar").addEventListener("click", (e) => {
      let clickedTab = tabs.find((t) =>
        t.tabElement === e.target || t.tabElement.contains(e.target)
      );
      if (clickedTab) {
        switchTab(clickedTab.id);
      }
    });
    ["gitIcon", "settingsIcon", "exportIcon"].forEach((iconId) => {
      let el = document.getElementById(iconId);
      el.addEventListener("click", (e) => {
        let alreadyActive = e.currentTarget.classList.contains("active");
        document.querySelectorAll(".icon")
          .forEach((b) => b.classList.remove("active"));
        document.querySelectorAll(".sidebar-panel")
          .forEach((p) => p.classList.remove("active"));
        if (!alreadyActive) {
          e.currentTarget.classList.add("active");
          let targetPanel = e.currentTarget.getAttribute("data-target");
          document.getElementById(targetPanel).classList.add("active");
        }
      });
    });
    document.getElementById("searchIcon").addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      if (!t) return;
      t.editorInstance.getAction("actions.find").run();
    });
    document.addEventListener("click", (event) => {
      if (!event.target.closest(".vs-navbar-item")) {
        document.querySelectorAll(".vs-navbar-dropdown").forEach((d) => {
          d.classList.remove("active");
        });
        activeDropdown = null;
      }
    });
    document.querySelectorAll(".vs-navbar-item").forEach((item) => {
      item.addEventListener("click", (evt) => {
        let dropdownId = evt.currentTarget.getAttribute("data-dropdown");
        let dd = document.getElementById(dropdownId);
        document.querySelectorAll(".vs-navbar-dropdown")
          .forEach((d) => d.classList.remove("active"));
        if (dd) {
          dd.classList.toggle("active");
          activeDropdown = dd.classList.contains("active") ? dd : null;
        }
      });
      item.addEventListener("mouseover", (evt) => {
        if (activeDropdown) {
          let dropdownId = evt.currentTarget.getAttribute("data-dropdown");
          let dd = document.getElementById(dropdownId);
          if (activeDropdown !== dd) {
            activeDropdown.classList.remove("active");
            dd.classList.add("active");
            activeDropdown = dd;
          }
        }
      });
    });
    tabSizeInput.addEventListener("input", () => {
      spaces = parseInt(tabSizeInput.value, 10);
      tabSizeDisplay.textContent = spaces;
      document.getElementById("statusSpaces").textContent = `Spaces: ${spaces}`;
      tabs.forEach((t) => {
        t.editorInstance.updateOptions({ tabSize: spaces });
      });
    });
    let redoBtn = document.getElementById("redoBtn");
    let undoBtn = document.getElementById("undoBtn");
    function toggleDisabled(el, disabled) {
      if (disabled) {
        el.classList.add("disabled");
        el.style.color = "grey";
        el.style.cursor = "default";
      } else {
        el.classList.remove("disabled");
        el.style.cursor = "pointer";
        if (darkModeFlag) {
          el.style.color = "white";
        } else {
          el.style.color = "black";
        }
      }
    }
    function updateUndoRedoButtons() {
      if (activeTabId === null) {
        toggleDisabled(undoBtn, true);
        toggleDisabled(redoBtn, true);
        return;
      }
      let t = tabs.find((x) => x.id === activeTabId);
      if (!t) return;
      let model = t.editorInstance.getModel();
      if (!model) return;
      toggleDisabled(undoBtn, !model.canUndo());
      toggleDisabled(redoBtn, !model.canRedo());
    }
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        document.getElementById("saveScriptBtn")
          .dispatchEvent(new MouseEvent("click"));
      } else if ((e.ctrlKey && e.key === "z") ||
        (e.ctrlKey && e.shiftKey && e.key === "Z")) {
        setTimeout(() => updateUndoRedoButtons(), 100);
      }
    });
    redoBtn.addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      t.editorInstance.trigger("redo", "redo", null);
      updateUndoRedoButtons();
    });
    undoBtn.addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      t.editorInstance.trigger("undo", "undo", null);
      updateUndoRedoButtons();
    });
    setInterval(() => updateUndoRedoButtons(), 500);
    document.getElementById("uploadFileBtn").addEventListener("click", () => {
      let input = document.createElement("input");
      input.type = "file";
      input.accept = ".js";
      input.style.display = "none";
      input.addEventListener("change", async (e) => {
        let file = e.target.files[0];
        let reader = new FileReader();
        reader.onload = (evt) => {
          let newTabName = getUniqueTabName(file.name);
          createTab(newTabName, evt.target.result);
          closeDropdowns();
        };
        reader.readAsText(file);
      });
      document.body.appendChild(input);
      input.click();
      input.remove();
    });
    document.getElementById("saveScriptBtn").addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      let content = t.editorInstance.getValue();
      let blob = new Blob([content], { type: "text/javascript" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = t.name.endsWith(".js") ? t.name : (t.name + ".js");
      a.click();
      URL.revokeObjectURL(url);
      closeDropdowns();
    });
    function closeDropdowns() {
      document.querySelectorAll(".vs-navbar-dropdown")
        .forEach((d) => d.classList.remove("active"));
    }
    let gitInp = document.getElementById("gitUrl");
    let loadGitButton = document.getElementById("loadGitButton");
    gitInp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadGitButton.click();
    });
    gitInp.addEventListener("input", () => {
      if (!gitInp.value.trim()) {
        loadGitButton.disabled = true;
      } else {
        loadGitButton.disabled = false;
      }
    });
    loadGitButton.addEventListener("click", async () => {
      let urlVal = gitInp.value.trim();
      if (!urlVal) return;
      let fileName = "untitled.js";
      try {
        new URL(urlVal);
      } catch (e) {
        alert("Invalid URL");
        return;
      }
      let normalized = normalizeUrl(urlVal);
      let parsed = parseGitHubUrl(normalized);
      if (parsed.isRawFile) {
        let slashIdx = parsed.rawUrl.lastIndexOf("/");
        if (slashIdx !== -1) {
          fileName = parsed.rawUrl.substring(slashIdx + 1);
        }
      } else if (parsed.isFile) {
        let slashIdx = parsed.path.lastIndexOf("/");
        if (slashIdx !== -1) {
          fileName = parsed.path.substring(slashIdx + 1);
        }
      }
      try {
        let fileContent;
        if (parsed.isRawFile) {
          fileContent = await fetchRawFile(parsed.rawUrl);
        } else if (parsed.isFile) {
          let fileData = await fetchFromGit(parsed.owner, parsed.repo, parsed.path, parsed.branch);
          if (!fileData.content) {
            alert("Failed to fetch file content.");
            return;
          }
          fileContent = atob(fileData.content);
        } else {
          alert("Invalid GitHub file URL. Must point to a specific file.");
          return;
        }
        createTab(fileName, fileContent);
      } catch (err) {
        alert(`Error fetching file: ${err.message}`);
      }
    });
    function normalizeUrl(u) {
      if (u.endsWith(".git")) {
        u = u.slice(0, -4);
      }
      if (!u.startsWith("http://") && !u.startsWith("https://")) {
        u = "https://" + u;
      }
      if (u.startsWith("http://")) {
        u = "https://" + u.substring(7);
      }
      return u;
    }
    function parseGitHubUrl(u) {
      if (u.includes("raw.githubusercontent.com")) {
        let match = u.match(/^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)$/);
        if (match) {
          return { isRawFile: true, rawUrl: u };
        }
        return { isRawFile: false };
      }
      let m = u.match(/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/);
      if (!m) return { isFile: false };
      return {
        owner: m[1],
        repo: m[2],
        branch: m[3],
        path: m[4],
        isFile: true
      };
    }
    async function fetchFromGit(owner, repo, path, branch = "main") {
      let apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
      let resp = await fetch(apiUrl);
      if (!resp.ok) {
        throw new Error(`Failed to fetch file: ${resp.statusText}`);
      }
      let data = await resp.json();
      if (data.type !== "file") {
        throw new Error("The URL does not point to a valid file.");
      }
      return data;
    }
    async function fetchRawFile(rawUrl) {
      let r = await fetch(rawUrl);
      if (!r.ok) {
        throw new Error(`Failed to fetch raw file: ${r.statusText}`);
      }
      return await r.text();
    }
    function makeTabTitleEditable(tabObj) {
      let span = tabObj.tabElement.querySelector(".tab-title");
      let closeIcon = tabObj.tabElement.querySelector(".close");
      if (!span) return;
      closeIcon.style.display = "none";
      let oldName = tabObj.name;
      let input = document.createElement("input");
      input.type = "text";
      input.value = oldName;
      input.classList.add("tab-title-edit");
      tabObj.tabElement.replaceChild(input, span);
      input.focus();
      input.select();
      let done = false;
      let finalize = () => {
        if (done) return;
        done = true;
        let newVal = input.value.trim();
        if (!newVal || newVal === oldName) {
          newVal = oldName;
        } else {
          newVal = getUniqueTabName(newVal, tabObj.id);
        }
        tabObj.name = newVal;
        let newSpan = document.createElement("span");
        newSpan.classList.add("tab-title");
        newSpan.textContent = newVal;
        newSpan.addEventListener("dblclick", () => {
          makeTabTitleEditable(tabObj);
        });
        tabObj.tabElement.replaceChild(newSpan, input);
        closeIcon.style.display = "block";
      };
      input.addEventListener("blur", finalize);
      input.addEventListener("keydown", (evt) => {
        if (evt.key === "Enter") {
          evt.preventDefault();
          finalize();
        } else if (evt.key === "Escape") {
          evt.preventDefault();
          input.value = oldName;
          finalize();
        }
      });
    }

    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      const chunkSize = 0x8000;
      for (let i = 0; i < bytes.length; i += chunkSize) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
      }
      return window.btoa(binary);
    }

    document.addEventListener("DOMContentLoaded", async function () {
      await cacheWorkerCode();
      nextWorker = new Worker(workerBlobURL);
    });


    function exportCode() {
      switch (exportSelect.value) {
        case "allZip":
          exportAllZip();
          break;
        case "image":
          exportImage();
          break;
        case "pdf":
          exportPDF();
          break;
        case "current":
          exportCurrent();
          break;
      }
    }

    function exportAllZip() {
      if (tabs.length === 0) {
        return;
      }
      if (tabs.length === 1) {
        exportCurrent();
        return;
      }

      exportModalContent.innerHTML = "";

      let checklistContainer = document.createElement("div");
      checklistContainer.style.display = "flex";
      checklistContainer.style.flexWrap = "wrap";
      checklistContainer.style.gap = "10px";
      checklistContainer.style.padding = "10px";

      tabs.forEach((tab) => {
        let checkboxWrapper = document.createElement("div");
        checkboxWrapper.style.display = "flex";
        checkboxWrapper.style.alignItems = "center";
        checkboxWrapper.style.flex = "1 0 auto";

        let checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        checkbox.id = "export-tab-" + tab.id;
        checkbox.dataset.tabId = tab.id;

        let label = document.createElement("label");
        label.htmlFor = checkbox.id;
        label.textContent = tab.name;
        label.style.marginLeft = "5px";

        checkboxWrapper.appendChild(checkbox);
        checkboxWrapper.appendChild(label);
        checklistContainer.appendChild(checkboxWrapper);
      });
      exportModalContent.appendChild(checklistContainer);

      let exportBtn = document.createElement("button");
      exportBtn.textContent = "Export";
      exportBtn.classList.add("exportBtn");
      exportBtn.style.marginTop = "20px";

      function updateExportButtonState() {
        let selectedCount = checklistContainer.querySelectorAll("input[type='checkbox']:checked").length;
        exportBtn.disabled = selectedCount === 0;
      }

      checklistContainer.querySelectorAll("input[type='checkbox']").forEach((cb) => {
        cb.addEventListener("change", updateExportButtonState);
      });
      updateExportButtonState();

      exportModalContent.appendChild(exportBtn);

      exportBtn.addEventListener("click", function () {
        let selectedCheckboxes = checklistContainer.querySelectorAll("input[type='checkbox']:checked");
        let selectedTabs = [];
        selectedCheckboxes.forEach((cb) => {
          let tabId = parseInt(cb.dataset.tabId, 10);
          let tabObj = tabs.find((t) => t.id === tabId);
          if (tabObj) {
            selectedTabs.push(tabObj);
          }
        });
        closeModal("close");

        if (selectedTabs.length === 0) {
          return;
        }

        if (selectedTabs.length === 1) {
          let t = selectedTabs[0];
          let blob = new Blob([t.editorInstance.getValue()], { type: "text/javascript" });
          let url = URL.createObjectURL(blob);
          let a = document.createElement("a");
          a.href = url;
          a.download = t.name.endsWith(".js") ? t.name : t.name + ".js";
          a.click();
          URL.revokeObjectURL(url);
        } else {
          let zip = new JSZip();
          selectedTabs.forEach((t) => {
            let fileName = t.name.endsWith(".js") ? t.name : t.name + ".js";
            zip.file(fileName, t.editorInstance.getValue());
          });
          zip.generateAsync({ type: "blob" }).then((content) => {
            let a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = "scripts.zip";
            a.click();
          });
        }
      });

      displayModal();
    }


    async function takeImage(domElem) {
      const canvas = await html2canvas(domElem, {
        scale: 2,
        logging: false,
        backgroundColor: null,
        willReadFrequently: true,
        allowTaint: true,
        useCORS: true
      });

      return canvas.toDataURL("image/png");
    }

    async function getOutputDivClone() {
      const backgroundColor = darkModeFlag ? '#1E1E1E' : '#FFFFFF';
      const maxWidth = currentTab.editorInstance.getLayoutInfo().contentWidth + "px"
      const outputWrapper = document.createElement('div');
      outputWrapper.classList.add("outputContainer", "isClone", darkModeFlag ? "darkMode" : "lightMode");
      outputWrapper.style.backgroundColor = backgroundColor;
      tempOutputDiv = currentTab.outputElement.cloneNode(true);
      outputWrapper.appendChild(tempOutputDiv);
      tempOutputDiv.classList.add(...currentTab.outputElement.classList);
      tempOutputDiv.style.width = maxWidth;
      tempOutputDiv.style.maxWidth = maxWidth;
      tempOutputDiv.style.height = 'auto';
      tempOutputDiv.style.overflowY = 'visible';
      return outputWrapper;
    }

    async function getEditorDiv() {
      const model = currentTab.editorInstance.getModel();
      const code = model.getValue();
      const language = "javascript";

      const codeLines = code.split('\n');

      const highlightedLines = await Promise.all(
        codeLines.map((line) => monaco.editor.colorize(line, language, {}))
      );

      const fontSize = currentTab.editorInstance.getOption(monaco.editor.EditorOption.fontSize) || 14;
      const lineHeight = currentTab.editorInstance.getOption(monaco.editor.EditorOption.lineHeight) || 20;
      const fontFamily = currentTab.editorInstance.getOption(monaco.editor.EditorOption.fontFamily) || 'Fira Code, monospace';
      const backgroundColor = darkModeFlag ? '#1E1E1E' : '#FFFFFF';
      const textColor = darkModeFlag ? '#D4D4D4' : '#000000';
      // const maxWidth = currentTab.editorInstance.getLayoutInfo().contentWidth + "px"
      const wrapperDiv = document.createElement('div');
      wrapperDiv.style.backgroundColor = backgroundColor;
      wrapperDiv.style.fontFamily = fontFamily;
      wrapperDiv.style.fontSize = `${fontSize}px`;
      wrapperDiv.style.lineHeight = `${lineHeight}px`;
      wrapperDiv.style.whiteSpace = "pre-wrap";
      wrapperDiv.style.width = '100%';
      // wrapperDiv.style.maxWidth = maxWidth;
      wrapperDiv.style.color = textColor;

      document.addEventListener('DOMContentLoaded', function () {
        if (window.screen.width < 768) {
          wrapperDiv.style.transform = "scale(0.7)";
          alert("Please note that the code may not be displayed properly on small screens.");
        }
      });

      codeLines.forEach((line, index) => {
        const lineWrapper = document.createElement('div');
        lineWrapper.style.display = "flex";
        lineWrapper.style.alignItems = "flex-start";

        const lineNumberDiv = document.createElement('div');
        lineNumberDiv.classList.add(darkModeFlag ? "lineNumDark" : "lineNumLight", "lineNum", "numberDiv");
        lineNumberDiv.textContent = index + 1;

        const codeLineDiv = document.createElement('div');
        codeLineDiv.classList.add("codeLineDiv")
        codeLineDiv.innerHTML = highlightedLines[index] || '';

        lineWrapper.appendChild(lineNumberDiv);
        lineWrapper.appendChild(codeLineDiv);
        wrapperDiv.appendChild(lineWrapper);
      });
      return wrapperDiv;
    }


    async function exportImage() {
      const wrapperBoth = document.createElement('div');
      wrapperBoth.style.backgroundColor = darkModeFlag ? '#1E1E1E' : '#FFFFFF';
      const editorTextDiv = document.createElement('div');
      editorTextDiv.classList.add("headerText")
      editorTextDiv.contentEditable = true;
      wrapperBoth.appendChild(editorTextDiv);
      wrapperBoth.appendChild(await getEditorDiv());
      const exportBtnsWrapper = document.createElement('div');
      exportBtnsWrapper.classList.add("exportBtnsWrapper");
      if (currentTab.outputElement.innerHTML.trim()) {
        const textDiv = document.createElement('div');
        textDiv.classList.add("headerText")
        textDiv.contentEditable = true;
        wrapperBoth.appendChild(textDiv);
        wrapperBoth.appendChild(await getOutputDivClone());
        const headerTextCheckbox = document.createElement("input");
        headerTextCheckbox.type = "checkbox";
        headerTextCheckbox.classList.add("exportCheckbox");
        exportBtnsWrapper.appendChild(headerTextCheckbox);
        headerTextCheckbox.checked = true;
        headerTextCheckbox.addEventListener("change", () => {
          textDiv.style.display = headerTextCheckbox.checked ? "block" : "none";
        });
        const exportCheckbox = document.createElement("input");
        exportCheckbox.type = "checkbox";
        exportCheckbox.classList.add("exportCheckbox");
        exportBtnsWrapper.appendChild(exportCheckbox);
        exportCheckbox.checked = true;
        exportCheckbox.addEventListener("change", () => {
          tempOutputDiv.style.display = exportCheckbox.checked ? "block" : "none";
          headerTextCheckbox.style.visibility = exportCheckbox.checked ? "hidden" : "visible";
        });
      }
      const editorHeaderCheckbox = document.createElement("input");
      editorHeaderCheckbox.type = "checkbox";
      editorHeaderCheckbox.classList.add("exportCheckbox");
      exportBtnsWrapper.appendChild(editorHeaderCheckbox);
      editorHeaderCheckbox.checked = true;
      editorHeaderCheckbox.addEventListener("change", () => {
        editorTextDiv.style.display = editorHeaderCheckbox.checked ? "block" : "none";
      });
      exportModalContent.appendChild(wrapperBoth);
      const exportBtn = document.createElement('button');
      exportBtn.textContent = "Export Image";
      exportBtn.classList.add("exportBtn");
      exportBtnsWrapper.appendChild(exportBtn);
      exportModalContent.appendChild(exportBtnsWrapper);
      exportBtn.onclick = async function () {
        exportBtn.disabled = true;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const imgSrc = await takeImage(wrapperBoth);
        closeModal("close");
        const bothImg = new Image();
        bothImg.src = imgSrc;
        let theyReady = false;

        bothImg.onload = () => {
          theyReady = true;
        };

        while (!theyReady) {
          await new Promise((resolve) => setTimeout(resolve, 150));
        }

        canvas.width = bothImg.width;
        canvas.height = bothImg.height
        ctx.drawImage(bothImg, 0, 0);

        const a = document.createElement('a');
        a.href = canvas.toDataURL("image/png");
        a.download = `${currentTab.name}.png`;
        a.click();
      }

      displayModal()
    }


    async function exportPDF() {
      const editorDiv = await getEditorDiv();
      const wrapBoth = document.createElement('div');
      wrapBoth.style.backgroundColor = darkModeFlag ? '#1E1E1E' : '#FFFFFF';
      const editorTextDiv = document.createElement('div');
      editorTextDiv.classList.add("headerText")
      editorTextDiv.contentEditable = true;
      wrapBoth.appendChild(editorTextDiv);
      exportModalContent.appendChild(wrapBoth);
      wrapBoth.appendChild(editorDiv);
      const exportBtnsWrapper = document.createElement('div');
      exportBtnsWrapper.classList.add("exportBtnsWrapper");
      if (currentTab.outputElement.innerHTML.trim()) {
        const outputDiv = await getOutputDivClone();
        outputDiv.style.backgroundColor = darkModeFlag ? '#1E1E1E' : '#FFFFFF';
        const textDiv = document.createElement('div');
        textDiv.classList.add("headerText")
        textDiv.contentEditable = true;
        wrapBoth.appendChild(textDiv);
        wrapBoth.appendChild(outputDiv);
        const headerTextCheckbox = document.createElement("input");
        headerTextCheckbox.type = "checkbox";
        headerTextCheckbox.classList.add("exportCheckbox");
        exportBtnsWrapper.appendChild(headerTextCheckbox);
        headerTextCheckbox.checked = true;
        headerTextCheckbox.addEventListener("change", () => {
          textDiv.style.display = headerTextCheckbox.checked ? "block" : "none";
        });
        const exportCheckbox = document.createElement("input");
        exportCheckbox.type = "checkbox";
        exportCheckbox.classList.add("exportCheckbox");
        exportBtnsWrapper.appendChild(exportCheckbox);
        exportCheckbox.checked = true;
        exportCheckbox.addEventListener("change", () => {
          outputDiv.style.display = exportCheckbox.checked ? "block" : "none";
          headerTextCheckbox.style.visibility = exportCheckbox.checked ? "hidden" : "visible";
        });
      }
      const editorHeaderCheckbox = document.createElement("input");
      editorHeaderCheckbox.type = "checkbox";
      editorHeaderCheckbox.classList.add("exportCheckbox");
      exportBtnsWrapper.appendChild(editorHeaderCheckbox);
      editorHeaderCheckbox.checked = true;
      editorHeaderCheckbox.addEventListener("change", () => {
        editorTextDiv.style.display = editorHeaderCheckbox.checked ? "block" : "none";
      });
      const exportBtn = document.createElement('button');
      exportBtn.textContent = "Export PDF";
      exportBtn.classList.add("exportBtn");
      exportBtnsWrapper.appendChild(exportBtn);
      exportModalContent.appendChild(exportBtnsWrapper);
      exportBtn.onclick = async function () {
        exportBtn.disabled = true;
        const contentWidth = wrapBoth.offsetWidth;
        const contentHeight = wrapBoth.offsetHeight;
        let doc = new jsPDF({
          orientation: contentWidth > contentHeight ? 'l' : 'p',
          unit: 'px',
          format: [contentWidth, contentHeight]
        });
        await new Promise(resolve => {
          doc.html(wrapBoth, {
            callback: resolve,
            x: 0,
            y: 0,
            margin: [0, 0, 0, 0],
            html2canvas: { scale: 1, logging: false }
          });
        });
        closeModal("close");
        if (doc.internal.getNumberOfPages() > 1) {
          for (let i = doc.internal.getNumberOfPages(); i > 1; i--) {
            doc.deletePage(i);
          }
        }
        doc.save(`${currentTab.name}.pdf`);
      }
      displayModal();
    }

    function exportCurrent() {
      if (activeTabId === null) {
        alert("No tab to export.");
        return;
      }
      let t = tabs.find((x) => x.id === activeTabId);
      let blob = new Blob([t.editorInstance.getValue()], { type: "text/javascript" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = t.name.endsWith(".js") ? t.name : (t.name + ".js");
      a.click();
      URL.revokeObjectURL(url);
    }

    function displayModal() {
      modal.style.display = "block";
      modal.dispatchEvent(new Event("modalOpened"));
    }

    function closeModal(event) {
      if (event.target === modal || event === "close") {
        modal.style.display = "none";
        modal.dispatchEvent(new Event("modalClosed"));
      }
    }
    modal.addEventListener("modalOpened", () => {
      document.addEventListener("click", closeModal);
    });
    modal.addEventListener("modalClosed", () => {
      document.removeEventListener("click", closeModal);
      exportModalContent.innerHTML = "";
    });

    function modalIsOpen() {
      return modal.style.display === "block";
    }


    alert(3);
  </script>

</body>

</html>