{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Tab Sandboxed JS Compiler</title>
  <link rel="stylesheet" data-name="vs/editor/editor.main"
    href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/editor/editor.main.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Fira Code', monospace;
      display: flex;
      flex-direction: row;
      height: 100vh;
      background-color: #1e1e1e;
      color: #d4d4d4;
      overflow: hidden;
    }

    .vs-logo {
      position: absolute;
      top: 0;
      left: 0;
      height: 40px;
      width: 40px;
      z-index: 1010;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .vs-logo img {
      height: 25px;
      width: 25px;
      object-fit: contain;
      border-radius: 4px;
      margin-bottom: 8px;
      user-select: none;
      -webkit-user-drag: none;
    }

    .vs-navbar {
      background-color: #252526;
      color: #ffffff;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      display: flex;
      padding: 5px 10px;
      border-bottom: 1px solid #333;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      padding-left: 40px;
      height: 30px;
    }

    .vs-navbar-item {
      margin-right: 10px;
      margin-top: 1px;
      position: relative;
      cursor: pointer;
      padding: 5px;
      padding-top: 1px;
      font-size: 12px;
      border-radius: 5px;
    }

    .vs-navbar-item:hover {
      background-color: #9492923b;
    }

    .vs-navbar-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #333;
      border: 1px solid #252526;
      border-radius: 4px;
      overflow: hidden;
      z-index: 1000;
      min-width: 120px;
    }

    .vs-navbar-dropdown.active {
      display: block;
    }

    .vs-navbar-dropdown-item {
      padding: 8px 12px;
      color: #d4d4d4;
      cursor: pointer;
      white-space: nowrap;
    }

    .vs-navbar-dropdown-item:hover {
      background-color: #444;
      color: #ffffff;
    }

    .vs-navbar-dropdown-item.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    #activityBar {
      width: 50px;
      background-color: #252526;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      border-right: 1px solid #333;
      transition: width 0.3s ease;
      flex-shrink: 0;
      margin-top: 30px;
    }

    #activityBar .icon {
      color: #b3b3b3;
      padding: 12px 0;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      width: 100%;
      text-align: center;
      font-size: 20px;
      position: relative;
    }

    #activityBar .icon:hover,
    #activityBar .icon.active {
      background-color: #3c3c3c;
      color: #fff;
    }

    #activityBar .icon:hover:after {
      content: attr(data-label);
      position: absolute;
      left: 55px;
      top: 50%;
      transform: translateY(-50%);
      background: #333;
      color: #fff;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 3px;
      white-space: nowrap;
      z-index: 9;
    }

    .sidebar-panel {
      width: 250px;
      background-color: #1e1e1e;
      border-right: 1px solid #333;
      overflow-y: auto;
      padding: 10px;
      display: none;
      flex-shrink: 0;
      transition: all 0.3s ease;
      margin-top: 30px;
    }

    .sidebar-panel.active {
      display: block;
    }

    #gitUrl {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      background-color: #2d2d2d;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      color: #d4d4d4;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #gitUrl:focus {
      border-color: #007acc;
    }

    #loadGitButton {
      width: 100%;
      padding: 8px 10px;
      background-color: #007acc;
      border: none;
      border-radius: 4px;
      color: white;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #loadGitButton:hover {
      background-color: #005f99;
    }

    #tabSizeInput {
      width: 100%;
    }

    .vs-range {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background-color: #2d2d2d;
      outline: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: #007acc;
      border-radius: 50%;
      border: 2px solid #444;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #007acc;
      border: 2px solid #444;
      border-radius: 50%;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb:hover,
    .vs-range::-moz-range-thumb:hover {
      background: #119eff;
    }

    .vs-range::-webkit-slider-thumb:active,
    .vs-range::-moz-range-thumb:active {
      background: #0067a8;
    }

    #mainContainer {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-top: 30px;
      overflow: hidden;
    }

    #tabBar {
      background-color: #252526;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      height: 36px;
      flex-shrink: 0;
    }

    .tab {
      background-color: #333;
      margin-right: 2px;
      margin-top: 9px;
      padding: 7px 10px 7px;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      user-select: none;
      -webkit-user-drag: element;
    }

    .tab-placeholder {
      width: 3px;
      height: 31px;
      margin-top: 9px;
      background-color: white;
      display: inline-block;
    }

    .tab.active {
      background-color: #1e1e1e;
      border-top: 1px solid #007acc;
    }

    .tab .tab-title {
      margin-right: 15px;
    }

    .tab .close {
      font-size: 12px;
      cursor: pointer;
    }

    .tab-title-edit {
      background: #555;
      border: 1px solid #666;
      color: #fff;
      width: 90px;
      font-size: 13px;
      margin-right: 8px;
      font-family: inherit;
      outline: none;
    }

    #addTabButton {
      background: none;
      color: #c5c5c5;
      font-size: 18px;
      cursor: pointer;
      margin-left: auto;
      margin-right: 5px;
    }

    #addTabButton:hover {
      color: #fff;
    }

    #tabsContainer {
      position: relative;
      flex: 1;
      overflow: hidden;
    }

    .editor-and-output {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .editor-and-output.active {
      display: flex;
    }

    .editorContainer {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .monaco-editor {
      width: 100%;
      height: 100%;
    }

    .outputContainer {
      height: 200px;
      background-color: #1e1e1e;
      border-top: 1px solid #333;
      display: flex;
      flex-direction: column;
    }

    .controls {
      display: flex;
      justify-content: flex-end;
      padding: 8px 12px;
      background-color: #252526;
      border-bottom: 1px solid #333;
    }

    .monaco-findInput>.controls {
      padding: 0px !important;
      background-color: transparent !important;
    }

    .runButton {
      padding: 6px 12px;
      background-color: #0e639c;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

    .runButton:hover {
      background-color: #1177bb;
    }

    .runButton i {
      margin-right: 5px;
    }

    .output {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      background-color: #1e1e1e;
    }

    .output::-webkit-scrollbar {
      width: 8px;
    }

    .output::-webkit-scrollbar-track {
      background: #252526;
    }

    .output::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .output::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .output::-webkit-scrollbar-corner {
      background: #252526;
    }

    .output::-webkit-scrollbar-horizontal {
      height: 8px;
    }

    .log {
      color: #d4d4d4;
    }

    .error {
      color: #f44747;
    }

    .warn {
      color: #cca700;
    }

    .info {
      color: #3794ff;
    }

    .outputContent {
      margin-top: 2px;
    }

    .prompt-line {
      display: flex;
      align-items: center;
      color: #d4d4d4;
      font-size: 14px;
    }

    .prompt-line span {
      margin-right: 5px;
      white-space: pre;
    }

    .prompt-line input {
      flex: 1;
      padding: 0;
      margin: 0;
      border: none;
      outline: none;
      background: transparent;
      color: #d4d4d4;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      caret-color: #d4d4d4;
    }

    #statusBar {
      height: 24px;
      background-color: #252526;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      font-size: 12px;
      color: #cccccc;
      flex-shrink: 0;
    }

    .status-item {
      margin-right: 10px;
    }

    .tab-drop-left {
      box-shadow: inset 4px 0 0 0 #007acc;
    }

    .tab-drop-right {
      box-shadow: inset -4px 0 0 0 #007acc;
    }

    .vs-button {
      background-color: #0e639c;
      color: #ffffff;
      border: none;
      padding: 6px 12px;
      margin-left: 10px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .vs-button:hover {
      background-color: #1177bb;
    }

    .console-table {
      border-collapse: collapse;
      font-size: 14px;
      color: #d4d4d4;
      margin-top: 4px;
      width: auto;
    }

    .console-table thead {
      background-color: #3c3c3c;
      font-weight: bold;
    }

    .console-table th,
    .console-table td {
      border: 1px solid #333;
      padding: 4px 8px;
      vertical-align: top;
    }

    .console-table-row:hover {
      background-color: #2d2d2d;
    }



    @media (max-width: 768px) {
      #activityBar {
        width: 40px;
      }

      #activityBar .icon {
        font-size: 18px;
        padding: 10px 0;
      }

      .sidebar-panel {
        width: 200px;
      }

      .runButton {
        padding: 6px 10px;
        font-size: 12px;
      }

      #statusBar {
        left: 50px;
      }
    }

    @media (max-width: 675px) {
      .sidebar-panel {
        width: 100%;
        padding-right: 50px;
      }
    }
  </style>
</head>

<body>
  <div class="vs-logo">
    <img src="{% static 'site_images/jseditor.png' %}" alt="Logo" />
  </div>
  <div class="vs-navbar">
    <div class="vs-navbar-item" data-dropdown="fileDropdown">
      File
      <div class="vs-navbar-dropdown" id="fileDropdown">
        <div class="vs-navbar-dropdown-item" id="uploadFileBtn">Upload File</div>
        <div class="vs-navbar-dropdown-item" id="saveScriptBtn">Save File</div>
      </div>
    </div>
    <div class="vs-navbar-item" data-dropdown="editDropdown">
      Edit
      <div class="vs-navbar-dropdown" id="editDropdown">
        <div class="vs-navbar-dropdown-item" id="undoBtn">Undo</div>
        <div class="vs-navbar-dropdown-item" id="redoBtn">Redo</div>
      </div>
    </div>
  </div>
  <div id="activityBar">
    <div class="icon" id="searchIcon" data-label="Search" data-target="searchPanel">
      <i class="fas fa-search"></i>
    </div>
    <div class="icon" id="gitIcon" data-label="Source Control" data-target="gitPanel">
      <i class="fas fa-code-branch"></i>
    </div>
    <div class="icon" id="settingsIcon" data-label="Settings" data-target="settingsPanel">
      <i class="fas fa-cog"></i>
    </div>
  </div>
  <div id="gitPanel" class="sidebar-panel">
    <input type="url" id="gitUrl" placeholder="Enter GitHub file URL" />
    <button id="loadGitButton" disabled="true">Load</button>
  </div>
  <div id="settingsPanel" class="sidebar-panel">
    <div>
      <label for="tabSizeInput">Tab Size: <span id="tabSizeDisplay">3</span></label>
      <input id="tabSizeInput" type="range" min="1" max="8" value="3" class="vs-range" />
    </div>
  </div>
  <div id="mainContainer">
    <div id="tabBar">
      <div id="addTabButton"><i class="fas fa-plus"></i></div>
    </div>
    <div id="tabsContainer"></div>
    <div id="statusBar">
      <div class="status-item" id="statusPosition">Ln 1, Col 1</div>
      <div class="status-item">UTF-8</div>
      <div class="status-item" id="statusSpaces">Spaces: 3</div>
      <div class="status-item">JavaScript</div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
  <script>
    const workerPath = "{% url 'betzi_test_js' %}"
    let workerBlobURL = null
    let activeDropdown = null
    let spaces = 3
    let tabs = []
    let activeTabId = null
    let draggedTabId = null
    let lastDropSide = null
    function reorderTabsByTab(dId, tId, side) {
      let dIndex = tabs.findIndex((x) => x.id === dId)
      let tIndex = tabs.findIndex((x) => x.id === tId)
      if (dIndex < 0 || tIndex < 0) return
      let removed = tabs.splice(dIndex, 1)[0]
      let newI = tIndex + (side === "right" ? 1 : 0)
      if (dIndex < tIndex) newI--
      tabs.splice(newI, 0, removed)
      let b = document.getElementById("tabBar")
      tabs.forEach((x) => { b.insertBefore(x.tabElement, document.getElementById("addTabButton")) })
    }
    function getUniqueTabName(b, i = null) { let c = b, s = 1; while (tabs.some((t) => t.id !== i && t.name.toLowerCase() === c.toLowerCase())) { c = b + `(${s++})` } return c }
    function createTab(d = null, c = null) {
      let n
      if (!d) { n = getNextTabName() } else { n = getUniqueTabName(d) }
      let id = Date.now()
      let sb = new SharedArrayBuffer(1024)
      let v = new Int32Array(sb)
      let e = document.createElement("div")
      e.classList.add("tab")
      e.draggable = true
      let ti = document.createElement("span")
      ti.classList.add("tab-title")
      ti.textContent = n
      e.appendChild(ti)
      let cl = document.createElement("i")
      cl.classList.add("fas", "fa-times", "close")
      e.appendChild(cl)
      let eo = document.createElement("div")
      eo.classList.add("editor-and-output")
      let ec = document.createElement("div")
      ec.classList.add("editorContainer")
      let oc = document.createElement("div")
      oc.classList.add("outputContainer")
      let co = document.createElement("div")
      co.classList.add("controls")
      let rb = document.createElement("button")
      rb.classList.add("runButton")
      rb.innerHTML = '<i class="fas fa-play"></i> Run'
      co.appendChild(rb)
      let od = document.createElement("div")
      od.classList.add("output")
      od.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key.toLowerCase() === "a") {
          e.preventDefault();
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(od);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      })

      oc.appendChild(co)
      oc.appendChild(od)
      eo.appendChild(ec)
      eo.appendChild(oc)
      od.setAttribute("tabindex", "0");
      let tb = document.getElementById("tabBar")
      let ab = document.getElementById("addTabButton")
      tb.insertBefore(e, ab)
      let tc = document.getElementById("tabsContainer")
      tc.appendChild(eo)
      let ed = monaco.editor.create(ec, {
        language: "javascript",
        theme: "custom-dark",
        automaticLayout: true,
        tabSize: spaces,
        insertSpaces: true,
        minimap: { enabled: true },
        fontSize: 14,
        fontFamily: 'Fira Code, Consolas, "Courier New", monospace',
        fontLigatures: true,
        folding: true,
        lineNumbers: "on",
        wordWrap: "on",
        scrollbar: { verticalScrollbarSize: 8, horizontalScrollbarSize: 8 },
        contextmenu: true,
        selectionHighlight: true,
        renderIndentGuides: true,
        renderLineHighlight: "all",
        cursorStyle: "line",
        cursorBlinking: "blink",
        quickSuggestions: true,
        parameterHints: true,
        autoClosingBrackets: "always",
        autoClosingQuotes: "always",
        formatOnType: true,
        formatOnPaste: true,
        suggestOnTriggerCharacters: true,
        smoothScrolling: true,
        breadcrumbs: { enabled: true }
      })
      let o = { id, name: n, sharedBuffer: sb, view: v, tabElement: e, editorContainer: ec, outputElement: od, editorInstance: ed, worker: null, editorAndOutput: eo }
      tabs.push(o)
      ed.onDidChangeCursorPosition(() => { updateStatusPosition() })
      rb.addEventListener("click", () => { runTab(id, rb) })
      cl.addEventListener("click", (x) => { x.stopPropagation(); closeTab(id) })
      e.addEventListener("dragstart", (x) => {
        switchTab(id)
        x.dataTransfer.setData("text/plain", "")
        x.dataTransfer.effectAllowed = "move"
        draggedTabId = id
        e.classList.add("dragging")
      })
      e.addEventListener("dragend", () => {
        e.classList.remove("dragging")
        draggedTabId = null
        lastDropSide = null
        document.querySelectorAll(".tab").forEach((m) => m.classList.remove("tab-drop-left", "tab-drop-right", "dragging"))
      })
      e.addEventListener("dragover", (x) => {
        x.preventDefault()
        if (!draggedTabId || e.classList.contains("dragging")) return
        let r = e.getBoundingClientRect()
        let mid = r.left + r.width / 2
        if (x.clientX < mid) {
          e.classList.add("tab-drop-left")
          e.classList.remove("tab-drop-right")
          lastDropSide = "left"
        } else {
          e.classList.add("tab-drop-right")
          e.classList.remove("tab-drop-left")
          lastDropSide = "right"
        }
      })
      e.addEventListener("dragleave", () => {
        e.classList.remove("tab-drop-left", "tab-drop-right")
      })
      e.addEventListener("drop", (x) => {
        x.preventDefault()
        e.classList.remove("tab-drop-left", "tab-drop-right")
        if (!draggedTabId) return
        reorderTabsByTab(draggedTabId, id, lastDropSide)
        lastDropSide = null
      })
      ti.addEventListener("dblclick", () => { makeTabTitleEditable(o) })
      switchTab(id)
      if (c !== null) { ed.setValue(c) } else { ed.setValue(`// ${n}\nconsole.log("This is a log");\nconsole.info("This is an info");\nconsole.warn("This is a warning");\nconsole.error("This is an error");\nprompt("This is a prompt:");`) }
      return id
    }
    function getNextTabName() {
      let m = 0
      for (let t of tabs) {
        let x = t.name.match(/^Tab(\d+)$/)
        if (x) {
          let y = parseInt(x[1], 10)
          if (y > m) m = y
        }
      }
      return `Tab${m + 1}`
    }
    function switchTab(i) {
      if (activeTabId !== null) {
        let c = tabs.find((x) => x.id === activeTabId)
        if (c) {
          c.tabElement.classList.remove("active")
          c.editorAndOutput.classList.remove("active")
        }
      }
      let n = tabs.find((x) => x.id === i)
      if (n) {
        n.tabElement.classList.add("active")
        n.editorAndOutput.classList.add("active")
        activeTabId = i
        updateStatusPosition()
      }
    }
    function closeTab(i) {
      let f = tabs.findIndex((x) => x.id === i)
      if (f === -1) return
      let o = tabs[f]
      if (o.worker) { o.worker.terminate(); o.worker = null }
      o.tabElement.remove()
      o.editorAndOutput.remove()
      tabs.splice(f, 1)
      if (activeTabId === i) {
        if (tabs.length > 0) { switchTab(tabs[tabs.length - 1].id) } else { activeTabId = null }
      }
    }

    async function handleAlert(message, tab) {
      return new Promise((resolve) => {
        const d = tab.outputElement;

        const alertLine = document.createElement("div");
        alertLine.classList.add("prompt-line", "outputContent");

        const alertSpan = document.createElement("span");
        alertSpan.textContent = `[!] ${message}`;
        alertSpan.style.color = colorMap.info;
        alertLine.appendChild(alertSpan);

        const okBtn = document.createElement("button");
        okBtn.classList.add("vs-button");
        okBtn.style.marginLeft = "10px";
        okBtn.textContent = "OK";
        alertLine.appendChild(okBtn);

        d.appendChild(alertLine);

        okBtn.focus();

        okBtn.addEventListener("click", () => {
          Atomics.store(tab.view, 0, 1);
          Atomics.notify(tab.view, 0);
          alertLine.remove();
          appendToOutput(d, "info", message);
          resolve();
        });
      });
    }


    function appendTable(outputElement, tableData) {
      const { rows, columns } = buildChromeTableModel(tableData);

      // Create table container
      const div = document.createElement("div");
      div.classList.add("outputContent");

      // Create table element
      const table = document.createElement("table");
      table.classList.add("console-table");

      // Create table header
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      headRow.classList.add("console-table-row");

      columns.forEach(col => {
        const th = document.createElement("th");
        th.classList.add("console-table-header");
        th.textContent = col === "__index" ? "(index)" : col;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      // Create table body
      const tbody = document.createElement("tbody");

      rows.forEach(rowObj => {
        const tr = document.createElement("tr");
        tr.classList.add("console-table-row");

        columns.forEach(col => {
          const td = document.createElement("td");
          td.classList.add("console-table-data");

          let value = rowObj[col];
          if (typeof value === "object" && value !== null && !Array.isArray(value)) {
            // Display nested objects as "{…}"
            td.textContent = Object.keys(value).length ? "{…}" : "{}";
          } else if (Array.isArray(value)) {
            // Display arrays as "(length) […]"
            td.textContent = `(${value.length}) […]`;
          } else if (typeof value === "string" && value.startsWith("[Circular")) {
            // Display circular references
            td.textContent = value;
          } else if (typeof value === "string" && value.startsWith("function")) {
            // Display functions as their string representation
            td.textContent = value;
          } else if (typeof value === "string" && value.startsWith("Symbol")) {
            // Display symbols
            td.textContent = value;
          } else if (value === undefined) {
            // Empty cell for undefined
            td.textContent = "";
          } else {
            // Display primitive values
            td.textContent = String(value);
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      // Append table to output
      div.appendChild(table);
      outputElement.appendChild(div);
      outputElement.scrollTop = outputElement.scrollHeight;
    }

    function buildChromeTableModel(input) {
      // Returns { rows: Array<Object>, columns: string[] }
      if (Array.isArray(input)) {
        if (input.length === 0) {
          // Empty array: Show table with only (index) column
          return { rows: [], columns: ["(index)"] };
        }

        let columnsSet = new Set(["__index"]);
        let rows = [];

        input.forEach((item, index) => {
          if (item && typeof item === "object") {
            Object.keys(item).forEach(k => columnsSet.add(k));
            rows.push({ "__index": index, ...item });
          } else {
            columnsSet.add("Value");
            rows.push({ "__index": index, "Value": item });
          }
        });

        return {
          rows,
          columns: Array.from(columnsSet)
        };
      }

      if (input && typeof input === "object") {
        const keys = Object.keys(input);
        if (keys.length === 0) {
          // Empty object: Show table with only (index) column
          return { rows: [], columns: ["(index)"] };
        }

        const allNumeric = keys.every(k => /^\d+$/.test(k));
        if (allNumeric) {
          // Treat as sparse array
          let columnsSet = new Set(["__index"]);
          let rowObjs = [];

          const numericKeys = keys.map(k => parseInt(k, 10)).sort((a, b) => a - b);
          numericKeys.forEach(numKey => {
            let val = input[numKey];
            if (val && typeof val === "object") {
              Object.keys(val).forEach(k => columnsSet.add(k));
              rowObjs.push({ "__index": numKey, ...val });
            } else {
              columnsSet.add("Value");
              rowObjs.push({ "__index": numKey, "Value": val });
            }
          });

          return { rows: rowObjs, columns: Array.from(columnsSet) };
        } else {
          // Plain object with non-numeric keys: Single row
          let rowObj = {};
          keys.forEach(k => {
            rowObj[k] = input[k];
          });
          return { rows: [rowObj], columns: keys };
        }
      }

      // Fallback: Not table-worthy
      return { rows: [], columns: ["Value"] };
    }



    async function runTab(i, btn) {
      btn.disabled = true
      let o = tabs.find((x) => x.id === i)
      if (!o) {
        btn.disabled = false
        return
      }
      try {
        clearConsole(o.outputElement)
        if (o.worker) { o.worker.terminate(); o.worker = null }
        await cacheWorkerCode()
        let w = new Worker(workerBlobURL)
        o.worker = w
        w.onmessage = async (e) => {
          let t = e.data.type
          let m = e.data.message
          if (t === "prompt") { await handlePrompt(m, o) }
          else if (["log", "error", "warn", "info"].includes(t)) { appendToOutput(o.outputElement, t, m) }
          else if (t === "clear") { clearConsole(o.outputElement) }
          else if (t === "alert") { await handleAlert(m, o) }
          else if (t === "table") {
            appendTable(o.outputElement, e.data.tableData);
          }
        }
        w.onerror = (x) => {
          appendToOutput(o.outputElement, "error", x.message)
          appendToOutput(o.outputElement, "log", "The script has finished running with exit code 1.")
        }
        let c = o.editorInstance.getValue()
        w.postMessage({ type: "execute", code: c, sharedBuffer: o.sharedBuffer })
      }
      catch (e) {
        appendToOutput(o.outputElement, "error", e.message)
        appendToOutput(o.outputElement, "log", "The script has finished running with exit code 1.")
      }
      btn.disabled = false
    }
    function clearConsole(d) { d.innerHTML = "" }
    const symbolsMap = { log: ">", error: "x", warn: "!", info: "i", prompt: "?" }
    const colorMap = { log: "#CCCCCC", error: "#FF5555", warn: "#FFFF55", info: "#55FFFF", prompt: "#55FF55" }
    function appendToOutput(d, t, m) {
      if (!d) return
      let l = document.createElement("div")
      l.className = t
      l.classList.add("outputContent")
      l.textContent = `[${symbolsMap[t]}] ${m}`
      l.style.color = colorMap[t]
      d.appendChild(l)
      d.scrollTop = d.scrollHeight
    }
    function handlePrompt(m, o) {
      return new Promise((r) => {
        let d = o.outputElement
        let pl = document.createElement("div")
        pl.className = "prompt-line"
        pl.classList.add("outputContent")
        let pm = document.createElement("span")
        pm.textContent = `[?] ${m}`
        pm.style.color = colorMap.prompt
        let inp = document.createElement("input")
        inp.type = "text"
        inp.autocomplete = "off"
        inp.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            let v = inp.value.trim()
            pm.textContent = `[${symbolsMap.prompt}] ${m} ${v}`
            inp.remove()
            let te = new TextEncoder()
            let en = te.encode(v + "\0")
            let rb = new Uint8Array(o.sharedBuffer, 4)
            rb.fill(0)
            rb.set(en)
            Atomics.store(o.view, 0, 1)
            Atomics.notify(o.view, 0)
            r()
          }
        })
        pl.appendChild(pm)
        pl.appendChild(inp)
        d.appendChild(pl)
        inp.focus()
      })
    }
    function makeTabTitleEditable(o) {
      let s = o.tabElement.querySelector(".tab-title")
      let x = o.tabElement.querySelector(".close")
      if (!s) return
      x.style.display = "none"
      let on = o.name
      let inp = document.createElement("input")
      inp.type = "text"
      inp.value = on
      inp.classList.add("tab-title-edit")
      o.tabElement.replaceChild(inp, s)
      inp.focus()
      inp.select()
      let fc = false
      let z = () => {
        if (fc) return
        fc = true
        let nv = inp.value.trim()
        if (!nv || nv === on) { nv = on } else { nv = getUniqueTabName(nv, o.id) }
        o.name = nv
        let ns = document.createElement("span")
        ns.classList.add("tab-title")
        ns.textContent = nv
        ns.addEventListener("dblclick", () => { makeTabTitleEditable(o) })
        o.tabElement.replaceChild(ns, inp)
        x.style.display = "block"
      }
      inp.addEventListener("blur", z)
      inp.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault()
          z()
        } else if (e.key === "Escape") {
          e.preventDefault()
          inp.value = on
          z()
        }
      })
    }
    require.config({
      paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs" }
    })
    window.MonacoEnvironment = {
      getWorkerUrl: function (m, l) {
        return "data:text/javascript;charset=utf-8," + encodeURIComponent(`
self.MonacoEnvironment={baseUrl:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/'};
importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/base/worker/workerMain.js');
`)
      }
    }
    async function cacheWorkerCode() {
      if (!workerBlobURL) {
        let r = await fetch(workerPath)
        let c = await r.text()
        let b = new Blob([c], { type: "application/javascript" })
        workerBlobURL = URL.createObjectURL(b)
      }
    }
    require(["vs/editor/editor.main"], function () {
      monaco.editor.defineTheme("custom-dark", {
        base: "vs-dark",
        inherit: true,
        rules: [
          { token: "keyword", foreground: "C586C0" },
          { token: "identifier", foreground: "9CDCFE" },
          { token: "string", foreground: "CE9178" },
          { token: "comment", foreground: "6A9955" },
          { token: "number", foreground: "B5CEA8" }
        ],
        colors: {
          "editor.background": "#1E1E1E"
        }
      })
      createTab()
    })
    function updateStatusPosition() {
      if (activeTabId === null) {
        document.getElementById("statusPosition").textContent = "Ln 0, Col 0"
        return
      }
      let o = tabs.find((x) => x.id === activeTabId)
      if (!o) return
      let p = o.editorInstance.getPosition()
      if (p) {
        document.getElementById("statusPosition").textContent = `Ln ${p.lineNumber}, Col ${p.column}`
      }
    }
    document.getElementById("addTabButton").addEventListener("click", () => { createTab() })
    document.getElementById("tabBar").addEventListener("click", (e) => {
      let c = tabs.find((t) => t.tabElement === e.target || t.tabElement.contains(e.target))
      if (c) { switchTab(c.id) }
    })
      ;["gitIcon", "settingsIcon"].forEach((i) => {
        let a = document.getElementById(i)
        a.addEventListener("click", (e) => {
          let s = e.currentTarget.classList.contains("active")
          document.querySelectorAll(".icon").forEach((b) => b.classList.remove("active"))
          document.querySelectorAll(".sidebar-panel").forEach((p) => p.classList.remove("active"))
          if (!s) {
            e.currentTarget.classList.add("active")
            let t = e.currentTarget.getAttribute("data-target")
            document.getElementById(t).classList.add("active")
          }
        })
      })
    document.getElementById("searchIcon").addEventListener("click", () => {
      if (activeTabId === null) return
      let o = tabs.find((t) => t.id === activeTabId)
      if (!o) return
      o.editorInstance.getAction("actions.find").run()
    })
    document.addEventListener("click", (event) => {
      if (!event.target.closest(".vs-navbar-item")) {
        document.querySelectorAll(".vs-navbar-dropdown").forEach((d) => d.classList.remove("active"))
        activeDropdown = null
      }
    })
    document.querySelectorAll(".vs-navbar-item").forEach((item) => {
      item.addEventListener("click", (evt) => {
        let di = evt.currentTarget.getAttribute("data-dropdown")
        let dd = document.getElementById(di)
        document.querySelectorAll(".vs-navbar-dropdown").forEach((d) => d.classList.remove("active"))
        if (dd) {
          dd.classList.toggle("active")
          activeDropdown = dd.classList.contains("active") ? dd : null
        }
      })
      item.addEventListener("mouseover", (evt) => {
        if (activeDropdown) {
          let di = evt.currentTarget.getAttribute("data-dropdown")
          let dd = document.getElementById(di)
          if (activeDropdown !== dd) {
            activeDropdown.classList.remove("active")
            dd.classList.add("active")
            activeDropdown = dd
          }
        }
      })
    })
    let tabSizeInput = document.getElementById("tabSizeInput")
    let tabSizeDisplay = document.getElementById("tabSizeDisplay")
    tabSizeInput.addEventListener("input", () => {
      spaces = parseInt(tabSizeInput.value, 10)
      tabSizeDisplay.textContent = spaces
      document.getElementById("statusSpaces").textContent = `Spaces: ${spaces}`
      tabs.forEach((t) => { t.editorInstance.updateOptions({ tabSize: spaces }) })
    })
    let redoBtn = document.getElementById("redoBtn")
    let undoBtn = document.getElementById("undoBtn")
    function toggleDisabled(e, d) { if (d) { e.classList.add("disabled") } else { e.classList.remove("disabled") } }
    function updateUndoRedoButtons() {
      if (activeTabId === null) { toggleDisabled(undoBtn, true); toggleDisabled(redoBtn, true); return }
      let t = tabs.find((x) => x.id === activeTabId)
      if (!t) return
      let m = t.editorInstance.getModel()
      if (!m) return
      toggleDisabled(undoBtn, !m.canUndo())
      toggleDisabled(redoBtn, !m.canRedo())
    }
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "s") {
        e.preventDefault()
        document.getElementById("saveScriptBtn").dispatchEvent(new MouseEvent("click"))
      } else if ((e.ctrlKey && e.key === "z") || (e.ctrlKey && e.shiftKey && e.key === "Z")) {
        setTimeout(() => updateUndoRedoButtons(), 100)
      }
    })
    redoBtn.addEventListener("click", () => {
      if (activeTabId === null) return
      let t = tabs.find((x) => x.id === activeTabId)
      t.editorInstance.trigger("redo", "redo", null)
      updateUndoRedoButtons()
    })
    undoBtn.addEventListener("click", () => {
      if (activeTabId === null) return
      let t = tabs.find((x) => x.id === activeTabId)
      t.editorInstance.trigger("undo", "undo", null)
      updateUndoRedoButtons()
    })
    setInterval(() => updateUndoRedoButtons(), 500)
    document.getElementById("uploadFileBtn").addEventListener("click", () => {
      let i = document.createElement("input")
      i.type = "file"
      i.accept = ".js"
      i.style.display = "none"
      i.addEventListener("change", async (e) => {
        let f = e.target.files[0]
        let r = new FileReader()
        r.onload = (v) => {
          let fn = getUniqueTabName(f.name)
          createTab(fn, v.target.result)
          closeDropdowns()
        }
        r.readAsText(f)
      })
      document.body.appendChild(i)
      i.click()
      i.remove()
    })
    document.getElementById("saveScriptBtn").addEventListener("click", () => {
      if (activeTabId === null) return
      let t = tabs.find((x) => x.id === activeTabId)
      let c = t.editorInstance.getValue()
      let b = new Blob([c], { type: "text/javascript" })
      let u = URL.createObjectURL(b)
      let a = document.createElement("a")
      a.href = u
      a.download = t.name.endsWith(".js") ? t.name : `${t.name}.js`
      a.click()
      URL.revokeObjectURL(u)
      closeDropdowns()
    })
    function closeDropdowns() {
      document.querySelectorAll(".vs-navbar-dropdown").forEach((d) => d.classList.remove("active"))
    }
    let gitInp = document.getElementById("gitUrl")
    let loadGitButton = document.getElementById("loadGitButton")
    gitInp.addEventListener("keydown", (e) => { if (e.key === "Enter") loadGitButton.click() })
    gitInp.addEventListener("input", () => { if (!gitInp.value.trim()) { loadGitButton.disabled = true } else { loadGitButton.disabled = false } })
    loadGitButton.addEventListener("click", async () => {
      let g = gitInp.value.trim()
      if (!g) return appendToOutput(null, "error", "No URL provided.")
      let fn = "untitled.js"
      try { new URL(g) } catch (e) { alert("Invalid URL"); return }
      let nu = normalizeUrl(g)
      let pu = parseGitHubUrl(nu)
      if (pu.isRawFile) {
        let ls = pu.rawUrl.lastIndexOf("/")
        if (ls !== -1) { fn = pu.rawUrl.substring(ls + 1) }
      } else if (pu.isFile) {
        let ls = pu.path.lastIndexOf("/")
        if (ls !== -1) { fn = pu.path.substring(ls + 1) }
      }
      try {
        let fc
        if (pu.isRawFile) {
          fc = await fetchRawFile(pu.rawUrl)
        } else if (pu.isFile) {
          let fd = await fetchFromGit(pu.owner, pu.repo, pu.path, pu.branch)
          if (!fd.content) { alert("Failed to fetch file content."); return }
          fc = atob(fd.content)
        } else {
          alert("Invalid GitHub file URL. Must point to a specific file.")
          return
        }
        createTab(fn, fc)
      } catch (e) { alert(`Error fetching file: ${e.message}`) }
    })
    function normalizeUrl(u) {
      if (u.endsWith(".git")) { u = u.slice(0, -4) }
      if (!u.startsWith("http://") && !u.startsWith("https://")) { u = "https://" + u }
      if (u.startsWith("http://")) { u = "https://" + u.substring(7) }
      return u
    }
    function parseGitHubUrl(u) {
      if (u.includes("raw.githubusercontent.com")) {
        let m = u.match(/^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)$/)
        if (m) { return { isRawFile: true, rawUrl: u } } return { isRawFile: false }
      }
      let q = u.match(/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/)
      if (!q) return { isFile: false }
      return { owner: q[1], repo: q[2], branch: q[3], path: q[4], isFile: true }
    }
    async function fetchFromGit(o, r, p, b = "main") {
      let a = `https://api.github.com/repos/${o}/${r}/contents/${p}?ref=${b}`
      let s = await fetch(a)
      if (!s.ok) throw new Error(`Failed to fetch file: ${s.statusText}`)
      let d = await s.json()
      if (d.type !== "file") throw new Error("The URL does not point to a valid file.")
      return d
    }
    async function fetchRawFile(u) {
      let r = await fetch(u)
      if (!r.ok) throw new Error(`Failed to fetch raw file: ${r.statusText}`)
      return await r.text()
    }
    alert('4')
  </script>
</body>

</html>