{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Tab Sandboxed JS Compiler</title>
  <link rel="stylesheet" data-name="vs/editor/editor.main"
    href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/editor/editor.main.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    #compiler {
      position: relative;
      font-family: 'Fira Code', monospace;
      display: flex;
      background-color: #1e1e1e;
      width: 60%;
      height: 500px;
      margin: 100px auto;
      color: #d4d4d4;
      overflow: hidden;
      transition: width 0.3s ease, height 0.3s ease, margin 0.3s ease;
    }

    .theme {}

    .color1e1e1e {
      background-color: #1e1e1e;
      color: #d4d4d4;
    }

    .color252526 {
      background-color: #252526;
      color: #cccccc;
      border-color: #333 !important;
      border-bottom-color: #333;
    }

    .colorffffff {
      background-color: #ffffff;
      color: #000;
    }

    .colorf0f0f0 {
      background-color: #f0f0f0;
      color: #131313;
      border-color: #c0c0c0 !important;
      border-bottom-color: #c0c0c0;
    }

    .vs-logo {
      position: absolute;
      top: 0;
      left: 0;
      height: 40px;
      width: 40px;
      z-index: 1010;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .vs-logo img {
      height: 25px;
      width: 25px;
      object-fit: contain;
      border-radius: 4px;
      margin-bottom: 8px;
      user-select: none;
      -webkit-user-drag: none;
    }

    .vs-navbar {
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      display: flex;
      padding: 5px 10px;
      padding-right: 5px;
      border-bottom: 1px solid;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      padding-left: 40px;
      height: 30px;
    }

    .vs-navbar-item {
      margin-right: 10px;
      margin-top: 1px;
      position: relative;
      cursor: pointer;
      padding: 5px;
      padding-top: 1px;
      font-size: 12px;
      border-radius: 5px;
    }

    .vs-navbar-item:hover {
      background-color: #9492923b;
    }

    .vs-navbar-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      border: 1px solid #252526;
      border-radius: 4px;
      overflow: hidden;
      z-index: 1000;
      min-width: 120px;
    }

    .vs-navbar-dropdown.active {
      display: block;
    }

    .vs-navbar-dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .vs-navbar-dropdown-item:hover {
      background-color: #444;
      color: #ffffff;
    }

    .vs-navbar-dropdown-item.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    #lightMode {
      margin-left: 10px;
      margin-right:10px;
      margin-top: 1px;
      cursor: pointer;
    }

    #fullScreenBtn {
      margin-top: 3px;
      font-size: 13px;
      cursor: pointer;
    }

    #activityBar {
      width: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      border-right: 1px solid #333;
      transition: width 0.3s ease;
      flex-shrink: 0;
      margin-top: 30px;
    }

    #activityBar .icon {
      padding: 12px 0;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      width: 100%;
      text-align: center;
      font-size: 20px;
      position: relative;
    }

    /* #activityBar .icon:hover,
    #activityBar .icon.active {
      background-color: #3c3c3c;
      color: #fff;
    } */

    #activityBar .icon:hover:after {
      content: attr(data-label);
      position: absolute;
      left: 55px;
      top: 50%;
      transform: translateY(-50%);
      background: #333;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 3px;
      white-space: nowrap;
      z-index: 9;
    }

    .sidebar-panel {
      width: 250px;
      background-color: #1e1e1e;
      border-right: 1px solid #333;
      overflow-y: auto;
      padding: 10px;
      display: none;
      flex-shrink: 0;
      margin-top: 30px;
    }

    .sidebar-panel.active {
      display: block;
    }

    #gitUrl {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      background-color: #2d2d2d;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      color: #d4d4d4;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #gitUrl:focus {
      border-color: #007acc;
    }

    #loadGitButton {
      width: 100%;
      padding: 8px 10px;
      background-color: #007acc;
      border: none;
      border-radius: 4px;
      color: white;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #loadGitButton:hover {
      background-color: #005f99;
    }

    #tabSizeInput {
      width: 100%;
    }

    .vs-range {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background-color: #2d2d2d;
      outline: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: #007acc;
      border-radius: 50%;
      border: 2px solid #444;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #007acc;
      border: 2px solid #444;
      border-radius: 50%;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .vs-range::-webkit-slider-thumb:hover,
    .vs-range::-moz-range-thumb:hover {
      background: #119eff;
    }

    .vs-range::-webkit-slider-thumb:active,
    .vs-range::-moz-range-thumb:active {
      background: #0067a8;
    }

    #mainContainer {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-top: 30px;
      overflow: hidden;
    }

    #tabBar {
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      height: 36px;
      flex-shrink: 0;
      overflow: hidden;
    }

    #tabBar:hover {
      overflow-x: auto;
      overflow-y: hidden;
      transition: overflow 0.3s;
    }

    #tabBar::-webkit-scrollbar {
      height: 3px;
    }

    #tabBar::-webkit-scrollbar-thumb {
      background-color: #007acc;
      border-radius: 10px;
    }

    .tab {
      margin-right: 2px;
      margin-top: 3px;
      padding: 7px 10px;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      user-select: none;
      -webkit-user-drag: element;
    }

    .tab .tab-title {
      margin-right: 15px;
    }

    .tab .close {
      font-size: 12px;
      cursor: pointer;
    }

    .tab-title-edit {
      background: #555;
      border: 1px solid #666;
      color: #fff;
      width: 90px;
      font-size: 13px;
      margin-right: 8px;
      font-family: inherit;
      outline: none;
    }

    #addTabButton {
      background: none;
      color: #c5c5c5;
      font-size: 18px;
      cursor: pointer;
      margin-left: auto;
      margin-right: 5px;
      flex-shrink: 0;
      transition: color 0.2s;
    }

    #addTabButton:hover {
      color: #fff;
    }

    #tabsContainer {
      position: relative;
      flex: 1;
      overflow: hidden;
    }

    .editor-and-output {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .editor-and-output.active {
      display: flex;
    }

    .editorContainer {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .monaco-editor {
      width: 100%;
      height: 100%;
    }

    .outputContainer {
      height: 200px;
      display: flex;
      flex-direction: column;
    }

    .resize{
      height: 200px !important
    }

    .monaco-editor .find-widget.visible .controls {
      padding: 0px !important;
      border: none !important;
    }

    .controls {
      display: flex;
      justify-content: flex-end;
      padding: 8px 12px;
      border-top: 1px solid;
      border-bottom: 1px solid;
    }

   #runButton {
      margin-left: auto;
      margin-top: 2px;
      padding: 6px 12px;
      background-color: #0e639c;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

   #runButton:hover {
      background-color: #1177bb;
    }

   #runButton i {
      margin-right: 5px;
    }

    .output {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      overflow: hidden;
    }

    .output:hover {
      overflow: auto;
      transition: overflow 0.3s;
    }

    .output::-webkit-scrollbar {
      width: 8px;
    }

    .output::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .output::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .output::-webkit-scrollbar-horizontal {
      height: 8px;
    }

    .outputContent {
      margin-top: 2px;
    }

    .prompt-line {
      display: flex;
      align-items: center;
      font-size: 14px;
    }

    .prompt-line span {
      margin-right: 5px;
      white-space: pre;
    }

    .prompt-line input {
      flex: 1;
      padding: 0;
      margin: 0;
      border: none;
      outline: none;
      background: transparent;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      caret-color: currentColor;
    }

    #statusBar {
      height: 24px;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      font-size: 12px;
      flex-shrink: 0;
    }

    .status-item {
      margin-right: 10px;
    }

    .tab-drop-left {
      box-shadow: inset 4px 0 0 0 #007acc;
    }

    .tab-drop-right {
      box-shadow: inset -4px 0 0 0 #007acc;
    }

    .vs-button {
      background-color: #0e639c;
      color: #ffffff;
      border: none;
      padding: 6px 12px;
      margin-left: 10px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .vs-button:hover {
      background-color: #1177bb;
    }

    .console-table {
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 4px;
      width: auto;
    }

    .console-table thead {
      font-weight: bold;
    }

    .console-table th,
    .console-table td {
      border: 1px solid #333;
      padding: 4px 8px;
      vertical-align: top;
    }

    .console-table-row:hover {
      opacity: 0.9;
    }

    #undoBtn,
    #redoBtn {
      margin-top: 3px;
      font-size: 11px;
    }

    #undoBtn {
      margin-right: 10px;
    }

    .theme.color1e1e1e {}

    .theme.color1e1e1e .tab {
      background-color: #2c2c2c;
      color: #ffffff;
    }

    .theme.color1e1e1e .tab.active {
      background-color: #1c1c1c;
      border-top: 1px solid #007acc !important;
    }

    .theme.color1e1e1e #statusBar {
      background-color: #2c2c2c;
      color: #cccccc;
    }

    #activityBar.theme.color252526 .icon:hover,
    #activityBar.theme.color252526 .icon.active {
      background-color: #3c3c3c;
      color: #fff;
    }

    .theme.color1e1e1e .sidebar-panel.active {
      background-color: #2b2b2b;
      color: #ffffff;
      border-color: #3c3c3c !important;
    }

    .theme.color1e1e1e .sidebar-panel.active #gitUrl {
      background-color: #3c3c3c;
      border-color: #4c4c4c;
      color: #ffffff;
    }

    .theme.color1e1e1e .sidebar-panel.active .vs-range {
      background-color: #3c3c3c;
      border: 1px solid #4c4c4c;
    }

    .theme.color1e1e1e .output {
      background-color: #1e1e1e;
      color: #d4d4d4;
    }

    .theme.color1e1e1e .console-table thead {
      background-color: #3c3c3c;
      color: #ffffff;
    }

    .theme.color1e1e1e .console-table td,
    .theme.color1e1e1e .console-table th {
      color: #d4d4d4;
    }

    .dark-log {
      color: #BBBBBB !important;
    }

    .dark-error {
      color: #FF6666 !important;
    }

    .dark-warn {
      color: #FFFF66 !important;
    }

    .dark-info {
      color: #74cbfb !important;
    }

    .dark-prompt {
      color: #99FF99 !important;
    }

    .theme.colorffffff .tab {
      background-color: #e0e0e0;
      color: #000000;
    }

    .theme.colorffffff .tab {
      background-color: #e0e0e0;
      color: #000000;
    }

    .theme.colorffffff .tab.active {
      background-color: #d0d0d0;
      border-top: 1px solid #007acc !important;
    }

    .theme.colorffffff #statusBar {
      background-color: #ecebeb;
      color: #000000;
      border-color: #c0c0c0 !important;
    }

    .theme.colorf0f0f0.vs-navbar-dropdown.active .vs-navbar-dropdown-item:hover {
      background-color: #c0c0c0;
      color: black;
    }

    #tabBar.theme.colorf0f0f0 #addTabButton {
      color: #636262 !important;
    }


    #tabBar.theme.colorf0f0f0 #addTabButton:hover {
      color: #000000 !important;
    }

    .theme.color252526 #tabBar::-webkit-scrollbar-track {
      background-color: #333;
    }

    .theme.colorf0f0f0 #tabBar::-webkit-scrollbar-track {
      background-color: #c0c0c0;
    }

    .theme.color252526.output::-webkit-scrollbar-corner {
      background: #252526;
    }

    .theme.colorf0f0f0.output::-webkit-scrollbar-corner {
      background: #f0f0f0;
    }

    .theme.color252526 #tabBar::-webkit-scrollbar-track {
      background-color: #333;
    }

    .theme.colorf0f0f0 #tabBar::-webkit-scrollbar-track {
      background-color: #c0c0c0;
    }


    #activityBar.theme.colorf0f0f0 .icon {
      color: #9b9a9a !important;
    }

    #activityBar.theme.colorf0f0f0 .icon:hover,
    #activityBar.theme.colorf0f0f0 .icon.active {
      background-color: rgb(183, 182, 182);
      color: #eae8e8 !important;
    }

    #activityBar.theme.colorf0f0f0 .icon:hover:after {
      background: #acabab;
    }

    .theme.colorf0f0f0 #activityBar .icon {
      color: #9b9a9a !important;
    }

    .theme.colorffffff .sidebar-panel.active {
      background-color: #eeeeee;
      color: #000000;
      border-color: #c0c0c0 !important;
    }

    .theme.colorffffff .sidebar-panel.active #gitUrl {
      background-color: #f9f9f9;
      border-color: #c0c0c0;
      color: #000000;
    }

    .theme.colorffffff .sidebar-panel.active .vs-range {
      background-color: #f9f9f9;
      border: 1px solid #c0c0c0;
    }

    .theme.colorffffff .output {
      background-color: #f9f9f9;
      color: #000;
    }

    .theme.colorffffff .console-table thead {
      background-color: #dddddd;
      color: #000000;
    }

    .theme.colorffffff .console-table td,
    .theme.colorffffff .console-table th {
      color: #333333;
    }

    .light-log {
      color: #444444 !important;
    }

    .light-error {
      color: #cc0000 !important;
    }

    .light-warn {
      color: #cc9a00 !important;
    }

    .light-info {
      color: #0066cc !important;
    }

    .light-prompt {
      color: #008000 !important;
    }

    .theme.color1e1e1e .prompt-line input {
      color: #ffffff;
    }

    .theme.colorffffff .prompt-line input {
      color: #000000;
    }

    #moon {
      font-size: 17px;
      height: 20px;
      width: 20px;
      padding-top: 1px;
      padding-left: 4px;
    }

    @media (max-width: 768px) {
      #activityBar {
        width: 40px;
      }

      #activityBar .icon {
        font-size: 18px;
        padding: 10px 0;
      }

      .sidebar-panel {
        width: 200px;
      }

     #runButton {
        padding: 6px 10px;
        font-size: 12px;
      }

      #statusBar {
        left: 50px;
      }
    }

    @media (max-width: 675px) {
      .sidebar-panel {
        width: 100%;
        padding-right: 50px;
      }
    }
  </style>
</head>

<body>
  <div id="compiler" class="theme color1e1e1e">
    <div class="vs-logo">
      <img src="{% static 'site_images/jseditor.png' %}" alt="Logo" />
    </div>
    <div class="vs-navbar theme color252526">
      <div class="vs-navbar-item" data-dropdown="fileDropdown">
        File
        <div class="theme color252526 vs-navbar-dropdown" id="fileDropdown">
          <div class="vs-navbar-dropdown-item" id="uploadFileBtn">Upload File</div>
          <div class="vs-navbar-dropdown-item" id="saveScriptBtn">Save File</div>
        </div>
      </div>
      <div class="vs-navbar-item" data-dropdown="editDropdown">
        Edit
        <div class="theme color252526 vs-navbar-dropdown" id="editDropdown">
          <div class="vs-navbar-dropdown-item"> </div>
          <div class="vs-navbar-dropdown-item"> </div>
        </div>
      </div>
      <div id="undoBtn"><i class="fa-solid fa-arrow-rotate-left"></i></div>
      <div id="redoBtn"><i class="fa-solid fa-rotate-right"></i></div>
      <button id="runButton" onclick="runTab()">
        <i class="fas fa-play"></i> Run
      </button>
      <div id="lightMode" onclick="changeToLightMode()">
        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
          <circle cx="12" cy="12" r="5" stroke="white" stroke-width="2" fill="none" />
          <line x1="12" y1="2" x2="12" y2="4" stroke="white" stroke-width="2" />
          <line x1="12" y1="20" x2="12" y2="22" stroke="white" stroke-width="2" />
          <line x1="2" y1="12" x2="4" y2="12" stroke="white" stroke-width="2" />
          <line x1="20" y1="12" x2="22" y2="12" stroke="white" stroke-width="2" />
          <line x1="5.5" y1="5.5" x2="7" y2="7" stroke="white" stroke-width="2" />
          <line x1="17" y1="5.5" x2="18.5" y2="7" stroke="white" stroke-width="2" />
          <line x1="5.5" y1="18.5" x2="7" y2="17" stroke="white" stroke-width="2" />
          <line x1="17" y1="18.5" x2="18.5" y2="17" stroke="white" stroke-width="2" />
        </svg>
      </div>
      <div id="fullScreenBtn" onclick="fullScreen()">
        <i class="fa-solid fa-up-right-and-down-left-from-center"></i>
      </div>
    </div>
    <div id="activityBar" class="theme color252526">
      <div class="icon" id="searchIcon" data-label="Search" data-target="searchPanel">
        <i class="fas fa-search"></i>
      </div>
      <div class="icon" id="gitIcon" data-label="Source Control" data-target="gitPanel">
        <i class="fas fa-code-branch"></i>
      </div>
      <div class="icon" id="settingsIcon" data-label="Settings" data-target="settingsPanel">
        <i class="fas fa-cog"></i>
      </div>
    </div>
    <div id="gitPanel" class="sidebar-panel">
      <input type="url" id="gitUrl" placeholder="Enter GitHub file URL" />
      <button id="loadGitButton" disabled="true">Load</button>
    </div>
    <div id="settingsPanel" class="sidebar-panel">
      <div>
        <label for="tabSizeInput">Tab Size: <span id="tabSizeDisplay">3</span></label>
        <input id="tabSizeInput" type="range" min="1" max="8" value="3" class="vs-range" />
      </div>
    </div>
    <div id="mainContainer">
      <div id="tabBar" class="theme color252526">
        <div id="addTabButton"><i class="fas fa-plus"></i></div>
      </div>
      <div id="tabsContainer"></div>
      <div id="statusBar">
        <div class="status-item" id="statusPosition">Ln 1, Col 1</div>
        <div class="status-item">UTF-8</div>
        <div class="status-item" id="statusSpaces">Spaces: 3</div>
        <div class="status-item">JavaScript</div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
  <script>
    const workerPath = "{% url 'betzi_test_js' %}";
    let currentTab = null;
    let workerBlobURL = null;
    let activeDropdown = null;
    let spaces = 3;
    let tabs = [];
    let activeTabId = null;
    let draggedTabId = null;
    let lastDropSide = null;
    let darkModeFlag = true;
    const compiler = document.getElementById("compiler");
    if (window.innerWidth < 768) {
      compiler.style.width = '100%';
      compiler.style.height = '100vh';
      compiler.style.margin = '0';
      document.getElementById("fullScreenBtn").style.display = 'none';
    } else {
      window.onload = function () {
        compiler.style.width = '60%';
        fullScreen();
      };
    }
    function fullScreen() {
      if (compiler.style.width === "60%") {
        compiler.style.width = "100%";
        compiler.style.height = "100vh";
        compiler.style.margin = "0";
      } else {
        compiler.style.width = "60%";
        compiler.style.height = "500px";
        compiler.style.margin = '100px auto';
      }
    }
    document.addEventListener('keydown', function (event) {
      if (compiler.style.width === "100%") {
        if (event.key === 'Escape') {
          compiler.style.width = "60%";
          compiler.style.height = "500px";
          compiler.style.margin = '100px auto';
        }
      }
    });
    const themeMapDark = {
      "color252526": "colorf0f0f0",
      "color1e1e1e": "colorffffff"
    };
    const themeMapLight = {
      "colorf0f0f0": "color252526",
      "colorffffff": "color1e1e1e"
    };
    const lightModeDiv = document.getElementById("lightMode");
    const sunSvg = lightModeDiv.innerHTML;

    function changeToLightMode() {
      if (darkModeFlag) {
        lightModeDiv.innerHTML = '<i class="fa-regular fa-moon" id="moon"></i>';
        darkModeFlag = false;
        document.querySelectorAll(".theme").forEach((element) => {
          element.classList.forEach((cls) => {
            if (themeMapDark[cls]) {
              element.classList.remove(cls);
              element.classList.add(themeMapDark[cls]);
            }
          });
        });
        monaco.editor.setTheme("vs-light");

        // Reassign log classes for ALL existing tabs:
        tabs.forEach(tab => {
          let lines = tab.outputElement.querySelectorAll(".outputContent");
          lines.forEach(line => {
            if (line.classList.contains("dark-log")) {
              line.classList.remove("dark-log");
              line.classList.add("light-log");
            } else if (line.classList.contains("dark-error")) {
              line.classList.remove("dark-error");
              line.classList.add("light-error");
            } else if (line.classList.contains("dark-warn")) {
              line.classList.remove("dark-warn");
              line.classList.add("light-warn");
            } else if (line.classList.contains("dark-info")) {
              line.classList.remove("dark-info");
              line.classList.add("light-info");
            }
            let promptSpan = line.querySelector(".dark-prompt");
            if (promptSpan) {
              promptSpan.classList.remove("dark-prompt");
              promptSpan.classList.add("light-prompt");
            }
          });
        });

      } else {
        lightModeDiv.innerHTML = sunSvg;
        darkModeFlag = true;
        document.querySelectorAll(".theme").forEach((element) => {
          element.classList.forEach((cls) => {
            if (themeMapLight[cls]) {
              element.classList.remove(cls);
              element.classList.add(themeMapLight[cls]);
            }
          });
        });
        monaco.editor.setTheme("custom-dark");

        // Reassign log classes for ALL existing tabs:
        tabs.forEach(tab => {
          let lines = tab.outputElement.querySelectorAll(".outputContent");
          lines.forEach(line => {
            if (line.classList.contains("light-log")) {
              line.classList.remove("light-log");
              line.classList.add("dark-log");
            } else if (line.classList.contains("light-error")) {
              line.classList.remove("light-error");
              line.classList.add("dark-error");
            } else if (line.classList.contains("light-warn")) {
              line.classList.remove("light-warn");
              line.classList.add("dark-warn");
            } else if (line.classList.contains("light-info")) {
              line.classList.remove("light-info");
              line.classList.add("dark-info");
            }
            let promptSpan = line.querySelector(".light-prompt");
            if (promptSpan) {
              promptSpan.classList.remove("light-prompt");
              promptSpan.classList.add("dark-prompt");
            }
          });
        });
      }
    }


    function reorderTabsByTab(dId, tId, side) {
      let dIndex = tabs.findIndex((x) => x.id === dId);
      let tIndex = tabs.findIndex((x) => x.id === tId);
      if (dIndex < 0 || tIndex < 0) return;
      let removed = tabs.splice(dIndex, 1)[0];
      let newI = tIndex + (side === "right" ? 1 : 0);
      if (dIndex < tIndex) newI--;
      tabs.splice(newI, 0, removed);
      let b = document.getElementById("tabBar");
      tabs.forEach((x) => {
        b.insertBefore(x.tabElement, document.getElementById("addTabButton"));
      });
    }
    function createTab(desiredName = null, content = null) {
      let name = desiredName
        ? getUniqueTabName(desiredName)
        : getNextTabName();
      let id = Date.now();
      let sharedBuffer = new SharedArrayBuffer(1024);
      let view = new Int32Array(sharedBuffer);
      let tabEl = document.createElement("div");
      tabEl.classList.add("tab");
      tabEl.draggable = true;
      let titleSpan = document.createElement("span");
      titleSpan.classList.add("tab-title");
      titleSpan.textContent = name;
      tabEl.appendChild(titleSpan);
      let closeIcon = document.createElement("i");
      closeIcon.classList.add("fas", "fa-times", "close");
      tabEl.appendChild(closeIcon);
      let editorOutputWrapper = document.createElement("div");
      editorOutputWrapper.classList.add("editor-and-output");
      let editorContainer = document.createElement("div");
      editorContainer.classList.add("editorContainer");
      editorOutputWrapper.appendChild(editorContainer);
      let outputContainer = document.createElement("div");
      outputContainer.classList.add("outputContainer");
      outputContainer.classList.add("resize");
      let controlsBar = document.createElement("div");
      controlsBar.classList.add("controls");
      controlsBar.classList.add("theme");
      controlsBar.classList.add(darkModeFlag ? "color252526" : "colorf0f0f0");
      outputContainer.appendChild(controlsBar);
      let outputDiv = document.createElement("div");
      outputDiv.classList.add("output");
      outputDiv.setAttribute("tabindex", "0");
      outputDiv.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key.toLowerCase() === "a") {
          e.preventDefault();
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(outputDiv);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      });
      outputContainer.appendChild(outputDiv);
      editorOutputWrapper.appendChild(outputContainer);
      let tabBar = document.getElementById("tabBar");
      let addTabBtn = document.getElementById("addTabButton");
      tabBar.insertBefore(tabEl, addTabBtn);
      let tabsContainer = document.getElementById("tabsContainer");
      tabsContainer.appendChild(editorOutputWrapper);
      let editorInstance = monaco.editor.create(editorContainer, {
        language: "javascript",
        theme: darkModeFlag ? "custom-dark" : "vs-light",
        automaticLayout: true,
        tabSize: spaces,
        insertSpaces: true,
        minimap: { enabled: true },
        fontSize: 14,
        fontFamily: 'Fira Code, Consolas, "Courier New", monospace',
        fontLigatures: true,
        folding: true,
        lineNumbers: "on",
        wordWrap: "on",
        scrollbar: { verticalScrollbarSize: 8, horizontalScrollbarSize: 8 },
        contextmenu: true,
        selectionHighlight: true,
        renderIndentGuides: true,
        renderLineHighlight: "all",
        cursorStyle: "line",
        cursorBlinking: "blink",
        quickSuggestions: true,
        parameterHints: true,
        autoClosingBrackets: "always",
        autoClosingQuotes: "always",
        formatOnType: true,
        formatOnPaste: true,
        suggestOnTriggerCharacters: true,
        smoothScrolling: true,
        breadcrumbs: { enabled: true }
      });
      let tabObj = {
        id,
        name,
        sharedBuffer,
        view,
        tabElement: tabEl,
        editorContainer,
        outputElement: outputDiv,
        editorInstance,
        worker: null,
        editorAndOutput: editorOutputWrapper
      };
      tabs.push(tabObj);
      editorInstance.onDidChangeCursorPosition(() => {
        updateStatusPosition();
      });
      closeIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        closeTab(id);
      });
      tabEl.addEventListener("dragstart", (ev) => {
        switchTab(id);
        ev.dataTransfer.setData("text/plain", "");
        ev.dataTransfer.effectAllowed = "move";
        draggedTabId = id;
        tabEl.classList.add("dragging");
      });
      tabEl.addEventListener("dragend", () => {
        tabEl.classList.remove("dragging");
        draggedTabId = null;
        lastDropSide = null;
        document.querySelectorAll(".tab")
          .forEach((m) => m.classList.remove("tab-drop-left", "tab-drop-right", "dragging"));
      });
      tabEl.addEventListener("dragover", (ev) => {
        ev.preventDefault();
        if (!draggedTabId || tabEl.classList.contains("dragging")) return;
        let rect = tabEl.getBoundingClientRect();
        let mid = rect.left + rect.width / 2;
        if (ev.clientX < mid) {
          tabEl.classList.add("tab-drop-left");
          tabEl.classList.remove("tab-drop-right");
          lastDropSide = "left";
        } else {
          tabEl.classList.add("tab-drop-right");
          tabEl.classList.remove("tab-drop-left");
          lastDropSide = "right";
        }
      });
      tabEl.addEventListener("dragleave", () => {
        tabEl.classList.remove("tab-drop-left", "tab-drop-right");
      });
      tabEl.addEventListener("drop", (ev) => {
        ev.preventDefault();
        tabEl.classList.remove("tab-drop-left", "tab-drop-right");
        if (!draggedTabId) return;
        reorderTabsByTab(draggedTabId, id, lastDropSide);
        lastDropSide = null;
      });
      titleSpan.addEventListener("dblclick", () => {
        makeTabTitleEditable(tabObj);
      });
      if (content !== null) {
        editorInstance.setValue(content);
      } else {
        editorInstance.setValue(`// ${name}
console.log("This is a log");
console.info("This is an info");
console.warn("This is a warning");
console.error("This is an error");
prompt("This is a prompt:");
`);
      }
      switchTab(id);
      return id;
    }
    function getUniqueTabName(baseName, tabId = null) {
      let candidate = baseName;
      let suffix = 1;
      while (tabs.some((t) =>
        t.id !== tabId && t.name.toLowerCase() === candidate.toLowerCase()
      )) {
        candidate = baseName + `(${suffix++})`;
      }
      return candidate;
    }
    function getNextTabName() {
      let max = 0;
      for (let t of tabs) {
        let match = t.name.match(/^Tab(\d+)$/);
        if (match) {
          let num = parseInt(match[1], 10);
          if (num > max) max = num;
        }
      }
      return `Tab${max + 1}`;
    }
    function switchTab(tabId) {
      if (activeTabId !== null) {
        let current = tabs.find((x) => x.id === activeTabId);
        if (current) {
          current.tabElement.classList.remove("active");
          current.editorAndOutput.classList.remove("active");
        }
      }
      let newTab = tabs.find((x) => x.id === tabId);
      if (newTab) {
        newTab.tabElement.classList.add("active");
        newTab.editorAndOutput.classList.add("active");
        activeTabId = tabId;
        updateStatusPosition();
        currentTab = newTab;
      }
    }
    function closeTab(tabId) {
      let i = tabs.findIndex((x) => x.id === tabId);
      if (i === -1) return;
      let obj = tabs[i];
      if (obj.worker) {
        obj.worker.terminate();
        obj.worker = null;
      }
      obj.tabElement.remove();
      obj.editorAndOutput.remove();
      tabs.splice(i, 1);
      if (activeTabId === tabId) {
        if (tabs.length > 0) {
          switchTab(tabs[tabs.length - 1].id);
        } else {
          activeTabId = null;
        }
      }
    }
    async function handlePrompt(message, tab) {
      return new Promise((resolve) => {
        let d = tab.outputElement;
        let pl = document.createElement("div");
        pl.classList.add("prompt-line", "outputContent");
        let pm = document.createElement("span");
        pm.textContent = `[?] ${message}`;
        pm.classList.add(darkModeFlag ? "dark-prompt" : "light-prompt");
        let inp = document.createElement("input");
        inp.type = "text";
        inp.autocomplete = "off";
        inp.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            let val = inp.value.trim();
            pm.textContent = `[?] ${message} ${val}`;
            inp.remove();
            let te = new TextEncoder();
            let encoded = te.encode(val + "\0");
            let respBuffer = new Uint8Array(tab.sharedBuffer, 4);
            respBuffer.fill(0);
            respBuffer.set(encoded);
            Atomics.store(tab.view, 0, 1);
            Atomics.notify(tab.view, 0);
            resolve();
          }
        });
        pl.appendChild(pm);
        pl.appendChild(inp);
        d.appendChild(pl);
        inp.focus();
      });
    }
    async function handleAlert(message, tab) {
      return new Promise((resolve) => {
        const d = tab.outputElement;
        const alertLine = document.createElement("div");
        alertLine.classList.add("prompt-line", "outputContent");
        const alertSpan = document.createElement("span");
        alertSpan.textContent = `[!] ${message}`;
        alertSpan.classList.add(darkModeFlag ? "dark-info" : "light-info");
        alertLine.appendChild(alertSpan);
        const okBtn = document.createElement("button");
        okBtn.classList.add("vs-button");
        okBtn.style.marginLeft = "10px";
        okBtn.textContent = "OK";
        alertLine.appendChild(okBtn);
        d.appendChild(alertLine);
        okBtn.focus();
        okBtn.addEventListener("click", () => {
          Atomics.store(tab.view, 0, 1);
          Atomics.notify(tab.view, 0);
          appendToOutput(d, "info", message);
          alertLine.remove();
          resolve();
        });
      });
    }
    async function runTab() {
      let btn = document.getElementById("runButton");
      btn.disabled = true;
      let tab = tabs.find((x) => x.id === currentTab.id);
      if (!tab) {
        btn.disabled = false;
        return;
      }
      try {
        clearConsole(tab.outputElement);
        if (tab.worker) {
          tab.worker.terminate();
          tab.worker = null;
        }
        await cacheWorkerCode();
        let w = new Worker(workerBlobURL);
        tab.worker = w;
        w.onmessage = async (e) => {
          let type = e.data.type;
          let msg = e.data.message;
          if (type === "prompt") {
            await handlePrompt(msg, tab);
          } else if (type === "alert") {
            await handleAlert(msg, tab);
          } else if (type === "clear") {
            clearConsole(tab.outputElement);
          } else if (type === "table") {
            const { rows, columns } = e.data;
            appendTable(tab.outputElement, rows, columns);
          } else if (["log", "error", "warn", "info"].includes(type)) {
            appendToOutput(tab.outputElement, type, msg);
          } else if (type === "dir") {
            appendDir(tab.outputElement, msg);
          }
        };
        w.onerror = (err) => {
          appendToOutput(tab.outputElement, "error", err.message);
          appendToOutput(tab.outputElement, "log",
            "The script has finished running with exit code 1.");
        };
        let code = tab.editorInstance.getValue();
        w.postMessage({
          type: "execute",
          code,
          sharedBuffer: tab.sharedBuffer
        });
      }
      catch (ex) {
        appendToOutput(tab.outputElement, "error", ex.message);
        appendToOutput(tab.outputElement, "log",
          "The script has finished running with exit code 1.");
      }
      btn.disabled = false;
    }
    function clearConsole(outputDiv) {
      outputDiv.innerHTML = "";
    }

    function appendDir(outputDiv, obj) {
      if (!outputDiv) return;
      let line = document.createElement("div");
      line.classList.add("outputContent");
      let styleClass = (darkModeFlag ? "dark-" : "light-") + "log";
      line.classList.add(styleClass);
      line.innerHTML =  obj;
      outputDiv.appendChild(line);
      outputDiv.scrollTop = outputDiv.scrollHeight;
    }


    const symbolsMap = { log: ">", error: "x", warn: "!", info: "i", prompt: "?" };

    function appendToOutput(outputDiv, type, message) {
      if (!outputDiv) return;
      let line = document.createElement("div");
      line.classList.add("outputContent");
      let styleClass = (darkModeFlag ? "dark-" : "light-") + type;
      line.classList.add(styleClass);

      // let processedMessage = message
      //   .split('\n')
      //   .map((l, i) => {
      //     if (i === 0) return l;
      //     if (l.trim().length > 0 && !/^[>\?!xi]/.test(l.trim()[0])) {
      //       return "    " + l;
      //     }
      //     return l;
      //   })
      //   .join('\n');

      line.textContent = `[${symbolsMap[type]}] ${message}`;
      outputDiv.appendChild(line);
      outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    function appendTable(outputElement, rows, columns) {
      if (!outputElement) return;
      if (!Array.isArray(rows) || !Array.isArray(columns)) {
        appendToOutput(outputElement, "error", "Invalid table data received.");
        return;
      }
      if (columns.length === 0 || rows.length === 0) {
        const fallbackMessage = (rows.length === 0)
          ? "Empty Table" : "No data to display.";
        appendToOutput(outputElement, "log", fallbackMessage);
        return;
      }
      const div = document.createElement("div");
      div.classList.add("outputContent");

      div.style.paddingLeft = "4ch";

      const table = document.createElement("table");
      table.classList.add("console-table");
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      headRow.classList.add("console-table-row");
      columns.forEach(col => {
        const th = document.createElement("th");
        th.classList.add("console-table-header");
        th.textContent = col;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      rows.forEach(rowObj => {
        const tr = document.createElement("tr");
        tr.classList.add("console-table-row");
        columns.forEach(col => {
          const td = document.createElement("td");
          td.classList.add("console-table-data");
          let value = rowObj[col];
          if (typeof value === "object" && value !== null) {
            if (Array.isArray(value)) {
              td.textContent = `[Array(${value.length})]`;
            } else if (value === "[Circular]") {
              td.textContent = "{…}";
            } else {
              const expandable = document.createElement("span");
              expandable.classList.add("expandable");
              expandable.textContent = "{…}";
              expandable.style.cursor = "pointer";
              expandable.addEventListener("click", () => {
                if (expandable.classList.contains("expanded")) {
                  expandable.classList.remove("expanded");
                  if (td.querySelector(".expandable-details")) {
                    td.querySelector(".expandable-details").remove();
                  }
                } else {
                  expandable.classList.add("expanded");
                  const details = document.createElement("div");
                  details.classList.add("expandable-details");
                  details.style.marginTop = "4px";
                  details.style.marginLeft = "20px";
                  details.innerHTML = objectToHTML(value, 1);
                  td.appendChild(details);
                }
              });
              td.appendChild(expandable);
            }
          } else if (typeof value === "function") {
            td.textContent = value;
          } else {
            td.textContent = (value === "undefined") ? "undefined" : String(value);
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      div.appendChild(table);
      outputElement.appendChild(div);
      outputElement.scrollTop = outputElement.scrollHeight;
    }

    function objectToHTML(obj, level = 0) {
      if (obj === null) {
        return `<span style="opacity:0.7;">null</span>`;
      }
      if (typeof obj !== "object") {
        return `<span>${escapeHtml(String(obj))}</span>`;
      }
      if (Array.isArray(obj)) {
        let html = `<details open style="margin-left:${level * 20}px;">`;
        html += `<summary>Array(${obj.length})</summary>`;
        obj.forEach((value, i) => {
          html += `<div style="margin-left:${(level + 1) * 20}px;">[${i}] => ${objectToHTML(value, level + 1)}</div>`;
        });
        html += `</details>`;
        return html;
      }
      const keys = Object.keys(obj);
      let html = `<details open style="margin-left:${level * 20}px;">`;
      html += `<summary>Object {${keys.length} keys}</summary>`;
      keys.forEach((key) => {
        html += `<div style="margin-left:${(level + 1) * 20}px;">
          <strong>${escapeHtml(key)}</strong>:
          ${objectToHTML(obj[key], level + 1)}
        </div>`;
      });
      html += `</details>`;
      return html;
    }
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
    require.config({
      paths: {
        vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs"
      }
    });
    window.MonacoEnvironment = {
      getWorkerUrl: function () {
        return "data:text/javascript;charset=utf-8," + encodeURIComponent(`
          self.MonacoEnvironment={baseUrl:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/'};
          importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/base/worker/workerMain.js');
        `);
      }
    };
    async function cacheWorkerCode() {
      if (!workerBlobURL) {
        let resp = await fetch(workerPath);
        let code = await resp.text();
        let blob = new Blob([code], { type: "application/javascript" });
        workerBlobURL = URL.createObjectURL(blob);
      }
    }
    require(["vs/editor/editor.main"], function () {
      monaco.editor.defineTheme("custom-dark", {
        base: "vs-dark",
        inherit: true,
        rules: [
          { token: "keyword", foreground: "C586C0" },
          { token: "identifier", foreground: "9CDCFE" },
          { token: "string", foreground: "CE9178" },
          { token: "comment", foreground: "6A9955" },
          { token: "number", foreground: "B5CEA8" }
        ],
        colors: {
          "editor.background": "#1E1E1E"
        }
      });
      createTab();
    });
    function updateStatusPosition() {
      if (activeTabId === null) {
        document.getElementById("statusPosition").textContent = "Ln 0, Col 0";
        return;
      }
      let t = tabs.find((x) => x.id === activeTabId);
      if (!t) return;
      let pos = t.editorInstance.getPosition();
      if (pos) {
        document.getElementById("statusPosition").textContent =
          `Ln ${pos.lineNumber}, Col ${pos.column}`;
      }
    }
    document.getElementById("addTabButton").addEventListener("click", () => {
      createTab();
    });
    document.getElementById("tabBar").addEventListener("click", (e) => {
      let clickedTab = tabs.find((t) =>
        t.tabElement === e.target || t.tabElement.contains(e.target)
      );
      if (clickedTab) {
        switchTab(clickedTab.id);
      }
    });
    ["gitIcon", "settingsIcon"].forEach((iconId) => {
      let el = document.getElementById(iconId);
      el.addEventListener("click", (e) => {
        let alreadyActive = e.currentTarget.classList.contains("active");
        document.querySelectorAll(".icon")
          .forEach((b) => b.classList.remove("active"));
        document.querySelectorAll(".sidebar-panel")
          .forEach((p) => p.classList.remove("active"));
        if (!alreadyActive) {
          e.currentTarget.classList.add("active");
          let targetPanel = e.currentTarget.getAttribute("data-target");
          document.getElementById(targetPanel).classList.add("active");
        }
      });
    });
    document.getElementById("searchIcon").addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      if (!t) return;
      t.editorInstance.getAction("actions.find").run();
    });
    document.addEventListener("click", (event) => {
      if (!event.target.closest(".vs-navbar-item")) {
        document.querySelectorAll(".vs-navbar-dropdown").forEach((d) => {
          d.classList.remove("active");
        });
        activeDropdown = null;
      }
    });
    document.querySelectorAll(".vs-navbar-item").forEach((item) => {
      item.addEventListener("click", (evt) => {
        let dropdownId = evt.currentTarget.getAttribute("data-dropdown");
        let dd = document.getElementById(dropdownId);
        document.querySelectorAll(".vs-navbar-dropdown")
          .forEach((d) => d.classList.remove("active"));
        if (dd) {
          dd.classList.toggle("active");
          activeDropdown = dd.classList.contains("active") ? dd : null;
        }
      });
      item.addEventListener("mouseover", (evt) => {
        if (activeDropdown) {
          let dropdownId = evt.currentTarget.getAttribute("data-dropdown");
          let dd = document.getElementById(dropdownId);
          if (activeDropdown !== dd) {
            activeDropdown.classList.remove("active");
            dd.classList.add("active");
            activeDropdown = dd;
          }
        }
      });
    });
    let tabSizeInput = document.getElementById("tabSizeInput");
    let tabSizeDisplay = document.getElementById("tabSizeDisplay");
    tabSizeInput.addEventListener("input", () => {
      spaces = parseInt(tabSizeInput.value, 10);
      tabSizeDisplay.textContent = spaces;
      document.getElementById("statusSpaces").textContent = `Spaces: ${spaces}`;
      tabs.forEach((t) => {
        t.editorInstance.updateOptions({ tabSize: spaces });
      });
    });
    let redoBtn = document.getElementById("redoBtn");
    let undoBtn = document.getElementById("undoBtn");
    function toggleDisabled(el, disabled) {
      if (disabled) {
        el.classList.add("disabled");
        el.style.color = "grey";
        el.style.cursor = "default";
      } else {
        el.classList.remove("disabled");
        el.style.cursor = "pointer";
        if (darkModeFlag) {
          el.style.color = "white";
        } else {
          el.style.color = "black";
        }
      }
    }
    function updateUndoRedoButtons() {
      if (activeTabId === null) {
        toggleDisabled(undoBtn, true);
        toggleDisabled(redoBtn, true);
        return;
      }
      let t = tabs.find((x) => x.id === activeTabId);
      if (!t) return;
      let model = t.editorInstance.getModel();
      if (!model) return;
      toggleDisabled(undoBtn, !model.canUndo());
      toggleDisabled(redoBtn, !model.canRedo());
    }
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        document.getElementById("saveScriptBtn")
          .dispatchEvent(new MouseEvent("click"));
      } else if ((e.ctrlKey && e.key === "z") ||
        (e.ctrlKey && e.shiftKey && e.key === "Z")) {
        setTimeout(() => updateUndoRedoButtons(), 100);
      }
    });
    redoBtn.addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      t.editorInstance.trigger("redo", "redo", null);
      updateUndoRedoButtons();
    });
    undoBtn.addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      t.editorInstance.trigger("undo", "undo", null);
      updateUndoRedoButtons();
    });
    setInterval(() => updateUndoRedoButtons(), 500);
    document.getElementById("uploadFileBtn").addEventListener("click", () => {
      let input = document.createElement("input");
      input.type = "file";
      input.accept = ".js";
      input.style.display = "none";
      input.addEventListener("change", async (e) => {
        let file = e.target.files[0];
        let reader = new FileReader();
        reader.onload = (evt) => {
          let newTabName = getUniqueTabName(file.name);
          createTab(newTabName, evt.target.result);
          closeDropdowns();
        };
        reader.readAsText(file);
      });
      document.body.appendChild(input);
      input.click();
      input.remove();
    });
    document.getElementById("saveScriptBtn").addEventListener("click", () => {
      if (activeTabId === null) return;
      let t = tabs.find((x) => x.id === activeTabId);
      let content = t.editorInstance.getValue();
      let blob = new Blob([content], { type: "text/javascript" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = t.name.endsWith(".js") ? t.name : (t.name + ".js");
      a.click();
      URL.revokeObjectURL(url);
      closeDropdowns();
    });
    function closeDropdowns() {
      document.querySelectorAll(".vs-navbar-dropdown")
        .forEach((d) => d.classList.remove("active"));
    }
    let gitInp = document.getElementById("gitUrl");
    let loadGitButton = document.getElementById("loadGitButton");
    gitInp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadGitButton.click();
    });
    gitInp.addEventListener("input", () => {
      if (!gitInp.value.trim()) {
        loadGitButton.disabled = true;
      } else {
        loadGitButton.disabled = false;
      }
    });
    loadGitButton.addEventListener("click", async () => {
      let urlVal = gitInp.value.trim();
      if (!urlVal) return;
      let fileName = "untitled.js";
      try {
        new URL(urlVal);
      } catch (e) {
        alert("Invalid URL");
        return;
      }
      let normalized = normalizeUrl(urlVal);
      let parsed = parseGitHubUrl(normalized);
      if (parsed.isRawFile) {
        let slashIdx = parsed.rawUrl.lastIndexOf("/");
        if (slashIdx !== -1) {
          fileName = parsed.rawUrl.substring(slashIdx + 1);
        }
      } else if (parsed.isFile) {
        let slashIdx = parsed.path.lastIndexOf("/");
        if (slashIdx !== -1) {
          fileName = parsed.path.substring(slashIdx + 1);
        }
      }
      try {
        let fileContent;
        if (parsed.isRawFile) {
          fileContent = await fetchRawFile(parsed.rawUrl);
        } else if (parsed.isFile) {
          let fileData = await fetchFromGit(parsed.owner, parsed.repo, parsed.path, parsed.branch);
          if (!fileData.content) {
            alert("Failed to fetch file content.");
            return;
          }
          fileContent = atob(fileData.content);
        } else {
          alert("Invalid GitHub file URL. Must point to a specific file.");
          return;
        }
        createTab(fileName, fileContent);
      } catch (err) {
        alert(`Error fetching file: ${err.message}`);
      }
    });
    function normalizeUrl(u) {
      if (u.endsWith(".git")) {
        u = u.slice(0, -4);
      }
      if (!u.startsWith("http://") && !u.startsWith("https://")) {
        u = "https://" + u;
      }
      if (u.startsWith("http://")) {
        u = "https://" + u.substring(7);
      }
      return u;
    }
    function parseGitHubUrl(u) {
      if (u.includes("raw.githubusercontent.com")) {
        let match = u.match(/^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)$/);
        if (match) {
          return { isRawFile: true, rawUrl: u };
        }
        return { isRawFile: false };
      }
      let m = u.match(/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/);
      if (!m) return { isFile: false };
      return {
        owner: m[1],
        repo: m[2],
        branch: m[3],
        path: m[4],
        isFile: true
      };
    }
    async function fetchFromGit(owner, repo, path, branch = "main") {
      let apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
      let resp = await fetch(apiUrl);
      if (!resp.ok) {
        throw new Error(`Failed to fetch file: ${resp.statusText}`);
      }
      let data = await resp.json();
      if (data.type !== "file") {
        throw new Error("The URL does not point to a valid file.");
      }
      return data;
    }
    async function fetchRawFile(rawUrl) {
      let r = await fetch(rawUrl);
      if (!r.ok) {
        throw new Error(`Failed to fetch raw file: ${r.statusText}`);
      }
      return await r.text();
    }
    function makeTabTitleEditable(tabObj) {
      let span = tabObj.tabElement.querySelector(".tab-title");
      let closeIcon = tabObj.tabElement.querySelector(".close");
      if (!span) return;
      closeIcon.style.display = "none";
      let oldName = tabObj.name;
      let input = document.createElement("input");
      input.type = "text";
      input.value = oldName;
      input.classList.add("tab-title-edit");
      tabObj.tabElement.replaceChild(input, span);
      input.focus();
      input.select();
      let done = false;
      let finalize = () => {
        if (done) return;
        done = true;
        let newVal = input.value.trim();
        if (!newVal || newVal === oldName) {
          newVal = oldName;
        } else {
          newVal = getUniqueTabName(newVal, tabObj.id);
        }
        tabObj.name = newVal;
        let newSpan = document.createElement("span");
        newSpan.classList.add("tab-title");
        newSpan.textContent = newVal;
        newSpan.addEventListener("dblclick", () => {
          makeTabTitleEditable(tabObj);
        });
        tabObj.tabElement.replaceChild(newSpan, input);
        closeIcon.style.display = "block";
      };
      input.addEventListener("blur", finalize);
      input.addEventListener("keydown", (evt) => {
        if (evt.key === "Enter") {
          evt.preventDefault();
          finalize();
        } else if (evt.key === "Escape") {
          evt.preventDefault();
          input.value = oldName;
          finalize();
        }
      });
    }
    alert("10px");
  </script>
</body>

</html>